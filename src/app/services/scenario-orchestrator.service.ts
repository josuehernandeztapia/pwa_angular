import { Injectable } from '@angular/core';
import { BusinessFlow, Market, Quote, Client } from '../models/types';
import { FinancialCalculatorService } from './financial-calculator.service';
import { CotizadorEngineService, CotizadorConfig } from './cotizador-engine.service';
import { TandaEngineService } from './tanda-engine.service';
import { ProtectionEngineService } from './protection-engine.service';
import { SimuladorEngineService, SavingsScenario, CollectiveScenarioConfig } from './simulador-engine.service';

export interface CompleteBusinessScenario {
  id: string;
  clientName: string;
  flow: BusinessFlow;
  market: Market;
  stage: 'COTIZACION' | 'SIMULACION' | 'ACTIVO' | 'PROTECCION';
  
  // Cotizaci√≥n data (if applicable)
  quote?: Quote;
  amortizationTable?: any[];
  
  // Simulaci√≥n data (if applicable)  
  savingsScenario?: SavingsScenario;
  tandaSimulation?: any;
  
  // Protection data (if applicable)
  protectionScenarios?: any[];
  
  // Senior-first formatted data
  seniorSummary: {
    title: string;
    description: string[];
    keyMetrics: Array<{ label: string; value: string; emoji: string }>;
    timeline: Array<{ month: number; event: string; emoji: string }>;
    whatsAppMessage: string;
  };
}

@Injectable({
  providedIn: 'root'
})
export class ScenarioOrchestratorService {

  constructor(
    private financialCalc: FinancialCalculatorService,
    private cotizador: CotizadorEngineService,
    private tandaEngine: TandaEngineService,
    private protectionEngine: ProtectionEngineService,
    private simulador: SimuladorEngineService
  ) { }

  // ===============================
  // COTIZADOR MODE SCENARIOS
  // ===============================

  async createAGSIndividualCotizacion(
    clientName: string,
    totalPrice: number,
    downPayment: number,
    term: number
  ): Promise<CompleteBusinessScenario> {
    
    const config: CotizadorConfig = {
      totalPrice,
      downPayment,
      term,
      market: 'aguascalientes',
      clientType: 'Individual',
      businessFlow: BusinessFlow.VentaPlazo
    };

    const validation = this.cotizador.validateConfiguration(config);
    if (!validation.valid) {
      throw new Error(`Configuraci√≥n inv√°lida: ${validation.errors.join(', ')}`);
    }

    const quote = this.cotizador.generateQuote(config);
    const amortizationTable = this.cotizador.generateAmortizationTable(quote);
    const financialSummary = this.cotizador.getFinancialSummary(quote);

    return {
      id: `ags-individual-${Date.now()}`,
      clientName,
      flow: BusinessFlow.VentaPlazo,
      market: 'aguascalientes',
      stage: 'COTIZACION',
      quote,
      amortizationTable,
      seniorSummary: {
        title: 'üöê Tu Unidad en Aguascalientes',
        description: [
          `${clientName}, aqu√≠ est√° tu cotizaci√≥n para una unidad de ${this.financialCalc.formatCurrency(totalPrice)}.`,
          `Con un enganche de ${this.financialCalc.formatCurrency(downPayment)}, financiar√°s ${this.financialCalc.formatCurrency(quote.amountToFinance)}.`,
          `Tu pago mensual ser√° de ${this.financialCalc.formatCurrency(quote.monthlyPayment)} por ${term} meses.`
        ],
        keyMetrics: [
          { label: 'Precio Total', value: this.financialCalc.formatCurrency(totalPrice), emoji: 'üí∞' },
          { label: 'Enganche', value: this.financialCalc.formatCurrency(downPayment), emoji: 'üí∏' },
          { label: 'Pago Mensual', value: this.financialCalc.formatCurrency(quote.monthlyPayment), emoji: 'üìÖ' },
          { label: 'Plazo', value: `${term} meses`, emoji: '‚è±Ô∏è' }
        ],
        timeline: [
          { month: 0, event: 'Firma de Contrato y Enganche', emoji: '‚úçÔ∏è' },
          { month: 1, event: 'Primer Pago Mensual', emoji: 'üí≥' },
          { month: term, event: '√öltimo Pago - Unidad Liberada', emoji: 'üéâ' }
        ],
        whatsAppMessage: `üöê *Cotizaci√≥n AGS - ${clientName}*\n\nüí∞ Precio: ${this.financialCalc.formatCurrency(totalPrice)}\nüí∏ Enganche: ${this.financialCalc.formatCurrency(downPayment)}\nüìÖ Mensualidad: ${this.financialCalc.formatCurrency(quote.monthlyPayment)}\n‚è±Ô∏è Plazo: ${term} meses\n\n*Tu nueva unidad te est√° esperando* ‚ú®`
      }
    };
  }

  async createEdoMexCollectiveCotizacion(
    clientName: string,
    totalPrice: number,
    downPayment: number,
    term: number,
    groupSize: number
  ): Promise<CompleteBusinessScenario> {
    
    const config: CotizadorConfig = {
      totalPrice,
      downPayment,
      term,
      market: 'edomex',
      clientType: 'Colectivo',
      businessFlow: BusinessFlow.CreditoColectivo
    };

    const validation = this.cotizador.validateConfiguration(config);
    if (!validation.valid) {
      throw new Error(`Configuraci√≥n inv√°lida: ${validation.errors.join(', ')}`);
    }

    const quote = this.cotizador.generateQuote(config);
    const amortizationTable = this.cotizador.generateAmortizationTable(quote);

    return {
      id: `edomex-collective-${Date.now()}`,
      clientName,
      flow: BusinessFlow.CreditoColectivo,
      market: 'edomex',
      stage: 'COTIZACION',
      quote,
      amortizationTable,
      seniorSummary: {
        title: 'ü§ù Cr√©dito Colectivo - Estado de M√©xico',
        description: [
          `${clientName}, tu grupo de ${groupSize} personas puede acceder a unidades de ${this.financialCalc.formatCurrency(totalPrice)}.`,
          `Con un enganche colectivo de ${this.financialCalc.formatCurrency(downPayment)}, cada unidad se financia a ${this.financialCalc.formatCurrency(quote.monthlyPayment)} mensuales.`,
          `El plan colectivo les permite obtener mejores condiciones y apoyo mutuo entre miembros.`
        ],
        keyMetrics: [
          { label: 'Precio por Unidad', value: this.financialCalc.formatCurrency(totalPrice), emoji: 'üöê' },
          { label: 'Enganche Grupal', value: this.financialCalc.formatCurrency(downPayment), emoji: 'ü§ù' },
          { label: 'Pago por Unidad', value: this.financialCalc.formatCurrency(quote.monthlyPayment), emoji: 'üí≥' },
          { label: 'Miembros Grupo', value: `${groupSize} personas`, emoji: 'üë•' }
        ],
        timeline: [
          { month: 0, event: 'Formaci√≥n del Grupo y Convenio', emoji: 'ü§ù' },
          { month: 1, event: 'Inicio de Aportaciones Colectivas', emoji: 'üí∞' },
          { month: 12, event: 'Primera Adjudicaci√≥n Estimada', emoji: 'üéØ' },
          { month: term, event: '√öltima Entrega del Grupo', emoji: 'üéâ' }
        ],
        whatsAppMessage: `ü§ù *Cr√©dito Colectivo EdoMex - ${clientName}*\n\nüöê Precio: ${this.financialCalc.formatCurrency(totalPrice)}\nüí∞ Enganche Grupal: ${this.financialCalc.formatCurrency(downPayment)}\nüí≥ Pago por unidad: ${this.financialCalc.formatCurrency(quote.monthlyPayment)}\nüë• Grupo: ${groupSize} miembros\n\n*Juntos llegar√°n m√°s lejos* üåü`
      }
    };
  }

  // ===============================
  // SIMULADOR MODE SCENARIOS  
  // ===============================

  async createAGSAhorroRenovacion(
    clientName: string,
    initialDownPayment: number,
    deliveryMonths: number,
    unitPlates: string[],
    consumptionPerPlate: number[],
    overpricePerLiter: number,
    totalUnitValue: number
  ): Promise<CompleteBusinessScenario> {
    
    const savingsScenario = this.simulador.generateAGSLiquidationScenario(
      initialDownPayment,
      deliveryMonths,
      unitPlates,
      consumptionPerPlate,
      overpricePerLiter,
      totalUnitValue
    );

    const seniorFormat = this.simulador.formatScenarioForSenior(savingsScenario);

    return {
      id: `ags-ahorro-${Date.now()}`,
      clientName,
      flow: BusinessFlow.AhorroProgramado,
      market: 'aguascalientes',
      stage: 'SIMULACION',
      savingsScenario,
      seniorSummary: {
        title: 'üí° Plan de Ahorro AGS',
        description: seniorFormat.summary,
        keyMetrics: seniorFormat.keyNumbers.map(kn => ({
          label: kn.label,
          value: kn.value,
          emoji: kn.label.includes('Meta') ? 'üéØ' : kn.label.includes('Tiempo') ? '‚è∞' : 'üí∞'
        })),
        timeline: savingsScenario.timeline.slice(0, 4).map(t => ({
          month: t.month,
          event: t.event,
          emoji: t.event.includes('Enganche') ? 'üí∏' : t.event.includes('Recaudaci√≥n') ? '‚õΩ' : t.event.includes('Entrega') ? 'üöê' : 'üí∞'
        })),
        whatsAppMessage: `üí° *Plan Ahorro AGS - ${clientName}*\n\nüéØ Meta: ${this.financialCalc.formatCurrency(totalUnitValue)}\nüí∞ Con tu enganche: ${this.financialCalc.formatCurrency(initialDownPayment)}\n‚õΩ Recaudaci√≥n mensual: ${this.financialCalc.formatCurrency(savingsScenario.collectionContribution)}\n‚è∞ Tiempo estimado: ${deliveryMonths} meses\n\n*¬°Tu renovaci√≥n est√° m√°s cerca!* üåü`
      }
    };
  }

  async createEdoMexIndividualAhorro(
    clientName: string,
    targetDownPayment: number,
    plateConsumption: number,
    overpricePerLiter: number,
    voluntaryMonthly: number = 0
  ): Promise<CompleteBusinessScenario> {
    
    const savingsScenario = this.simulador.generateEdoMexIndividualScenario(
      targetDownPayment,
      plateConsumption,
      overpricePerLiter,
      voluntaryMonthly
    );

    const seniorFormat = this.simulador.formatScenarioForSenior(savingsScenario);

    return {
      id: `edomex-individual-ahorro-${Date.now()}`,
      clientName,
      flow: BusinessFlow.AhorroProgramado,
      market: 'edomex',
      stage: 'SIMULACION',
      savingsScenario,
      seniorSummary: {
        title: 'üè¶ Plan Individual EdoMex - Enganche',
        description: seniorFormat.summary,
        keyMetrics: seniorFormat.keyNumbers.map(kn => ({
          label: kn.label,
          value: kn.value,
          emoji: kn.label.includes('Meta') ? 'üéØ' : kn.label.includes('Tiempo') ? '‚è∞' : 'üí∞'
        })),
        timeline: [
          { month: 1, event: 'Inicio de Ahorros', emoji: 'üè¶' },
          { month: Math.ceil(savingsScenario.monthsToTarget / 2), event: 'Mitad del Camino', emoji: 'üìà' },
          { month: savingsScenario.monthsToTarget, event: 'Meta de Enganche Alcanzada', emoji: 'üéØ' },
          { month: savingsScenario.monthsToTarget + 1, event: 'Inicio de Financiamiento', emoji: 'üöê' }
        ],
        whatsAppMessage: `üè¶ *Plan Individual EdoMex - ${clientName}*\n\nüéØ Meta enganche: ${this.financialCalc.formatCurrency(targetDownPayment)}\n‚õΩ Recaudaci√≥n: ${this.financialCalc.formatCurrency(savingsScenario.collectionContribution)}\nüí∞ Aportaci√≥n extra: ${this.financialCalc.formatCurrency(voluntaryMonthly)}\n‚è∞ Tiempo: ${savingsScenario.monthsToTarget} meses\n\n*Paso a paso hacia tu unidad* üéØ`
      }
    };
  }

  async createEdoMexTandaColectiva(
    clientName: string,
    config: CollectiveScenarioConfig
  ): Promise<CompleteBusinessScenario> {
    
    const { scenario: savingsScenario, tandaResult, snowballEffect } = await this.simulador.generateEdoMexCollectiveScenario(config);

    return {
      id: `edomex-tanda-${Date.now()}`,
      clientName,
      flow: BusinessFlow.CreditoColectivo,
      market: 'edomex',
      stage: 'SIMULACION',
      savingsScenario,
      tandaSimulation: { tandaResult, snowballEffect },
      seniorSummary: {
        title: 'üå®Ô∏è Tanda Colectiva - Efecto Bola de Nieve',
        description: [
          `${clientName}, tu grupo de ${config.memberCount} miembros crear√° un efecto bola de nieve poderoso.`,
          `Con ${this.financialCalc.formatCurrency(savingsScenario.monthlyContribution)} mensuales del grupo, las entregas comenzar√°n pronto.`,
          `Cada entrega aumenta el poder de ahorro colectivo y acelera las siguientes adjudicaciones.`
        ],
        keyMetrics: [
          { label: 'Miembros Activos', value: `${config.memberCount} personas`, emoji: 'üë•' },
          { label: 'Aportaci√≥n Grupal', value: this.financialCalc.formatCurrency(savingsScenario.monthlyContribution), emoji: 'üí∞' },
          { label: 'Primera Entrega', value: `Mes ${tandaResult.firstAwardT || 12}`, emoji: 'üèÜ' },
          { label: 'Unidades Total', value: `${config.memberCount} unidades`, emoji: 'üöê' }
        ],
        timeline: [
          { month: 1, event: 'Inicio de Tanda Colectiva', emoji: 'ü§ù' },
          { month: tandaResult.firstAwardT || 12, event: 'Primera Adjudicaci√≥n', emoji: 'üèÜ' },
          { month: Math.floor((tandaResult.firstAwardT || 12) * 1.5), event: 'Aceleraci√≥n del Efecto', emoji: 'üå®Ô∏è' },
          { month: tandaResult.lastAwardT || 36, event: '√öltima Entrega', emoji: 'üéâ' }
        ],
        whatsAppMessage: `üå®Ô∏è *Tanda EdoMex - ${clientName}*\n\nüë• Grupo: ${config.memberCount} miembros\nüí∞ Aportaci√≥n grupal: ${this.financialCalc.formatCurrency(savingsScenario.monthlyContribution)}\nüèÜ Primera entrega: Mes ${tandaResult.firstAwardT || 12}\nüöê Total unidades: ${config.memberCount}\n\n*¬°El efecto bola de nieve funciona!* ‚ùÑÔ∏è`
      }
    };
  }

  // ===============================
  // PROTECTION MODE SCENARIOS
  // ===============================

  async createProtectionScenarios(
    client: Client,
    currentBalance: number,
    originalPayment: number,
    remainingTerm: number,
    market: Market
  ): Promise<CompleteBusinessScenario> {
    
    const protectionScenarios = this.protectionEngine.generateProtectionScenarios(
      currentBalance,
      originalPayment,
      remainingTerm,
      market
    );

    const bestScenario = protectionScenarios[0]; // Usually defer 3 months is most viable

    return {
      id: `protection-${client.id}-${Date.now()}`,
      clientName: client.name,
      flow: client.flow,
      market,
      stage: 'PROTECCION',
      protectionScenarios,
      seniorSummary: {
        title: 'üõ°Ô∏è Opciones de Protecci√≥n Financiera',
        description: [
          `${client.name}, tenemos ${protectionScenarios.length} opciones para ayudarte en este momento.`,
          `La opci√≥n recomendada es: ${bestScenario.title}.`,
          `${bestScenario.description} - Tu nuevo pago ser√≠a ${this.financialCalc.formatCurrency(bestScenario.newMonthlyPayment)}.`
        ],
        keyMetrics: [
          { label: 'Opciones Disponibles', value: `${protectionScenarios.length} escenarios`, emoji: 'üõ°Ô∏è' },
          { label: 'Pago Actual', value: this.financialCalc.formatCurrency(originalPayment), emoji: 'üí≥' },
          { label: 'Pago Recomendado', value: this.financialCalc.formatCurrency(bestScenario.newMonthlyPayment), emoji: '‚ú®' },
          { label: 'Reestructuras Usadas', value: `${client.protectionPlan?.restructuresUsed || 0}/${client.protectionPlan?.restructuresAvailable || 3}`, emoji: 'üîÑ' }
        ],
        timeline: [
          { month: 0, event: 'Solicitud de Protecci√≥n', emoji: 'üìã' },
          { month: 1, event: 'Inicio de Nuevo Plan', emoji: 'üõ°Ô∏è' },
          { month: bestScenario.newTerm, event: 'Plan Completado', emoji: '‚úÖ' }
        ],
        whatsAppMessage: `üõ°Ô∏è *Protecci√≥n ${client.name}*\n\n‚ú® Opci√≥n recomendada: ${bestScenario.title}\nüí≥ Pago actual: ${this.financialCalc.formatCurrency(originalPayment)}\n‚ú® Nuevo pago: ${this.financialCalc.formatCurrency(bestScenario.newMonthlyPayment)}\nüîÑ Reestructuras: ${client.protectionPlan?.restructuresUsed || 0}/${client.protectionPlan?.restructuresAvailable || 3}\n\n*Estamos aqu√≠ para apoyarte* üí™`
      }
    };
  }

  // ===============================
  // TANDA ENHANCED (SCENARIOS + IRR)
  // ===============================

  async createTandaScenariosEnhanced(
    group: { totalMembers: number; monthlyAmount: number; startDate?: Date },
    market: Market,
    horizonMonths: number,
    options?: { targetIrrAnnual?: number }
  ): Promise<CompleteBusinessScenario> {
    const tandaService = (this as any).enhancedTandaSimulationService as import('./enhanced-tanda-simulation.service').EnhancedTandaSimulationService | undefined;
    // Safe dynamic import to avoid circular deps in compile path
    const svc = tandaService ?? new (await import('./enhanced-tanda-simulation.service')).EnhancedTandaSimulationService(this.financialCalc);

    const results = svc.simulateWithGrid(group, market, horizonMonths, options);
    const best = results[0];

    return {
      id: `tanda-enhanced-${Date.now()}`,
      clientName: 'Grupo Colectivo',
      flow: 0 as any,
      market,
      stage: 'PROTECCION',
      protectionScenarios: [],
      seniorSummary: {
        title: '‚ùÑÔ∏è Tanda Enhanced ‚Äì Escenarios con IRR de Mercado',
        description: [
          `Se evaluaron ${results.length} escenarios de contribuci√≥n base y ¬±10%.`,
          `Mejor escenario: ${best.name} | IRR ${(best.irrAnnual * 100).toFixed(2)}% | ${best.tirOK ? '‚úì Cumple' : '‚úó No cumple'}`
        ],
        keyMetrics: [
          { label: 'Miembros', value: `${group.totalMembers}`, emoji: 'üë•' },
          { label: 'Aportaci√≥n Base', value: this.financialCalc.formatCurrency(group.monthlyAmount), emoji: 'üí∞' },
          { label: 'Horizonte', value: `${horizonMonths} meses`, emoji: 'üìÜ' },
        ],
        timeline: [] as any,
        whatsAppMessage: `‚ùÑÔ∏è *Tanda Enhanced*\n\nMejor escenario: ${best.name}\nIRR: ${(best.irrAnnual * 100).toFixed(2)}% ${best.tirOK ? '‚úì' : '‚úó'}\nMiembros: ${group.totalMembers} | Aportaci√≥n: ${this.financialCalc.formatCurrency(group.monthlyAmount)} | Horizonte: ${horizonMonths}m`
      }
    };
  }

  // ===============================
  // UTILITY METHODS
  // ===============================

  // Convert any scenario to WhatsApp-ready format
  generateWhatsAppExport(scenario: CompleteBusinessScenario): string {
    return scenario.seniorSummary.whatsAppMessage;
  }

  // Convert any scenario to PDF-ready format
  generatePDFExport(scenario: CompleteBusinessScenario): any {
    return {
      title: scenario.seniorSummary.title,
      description: scenario.seniorSummary.description,
      keyMetrics: scenario.seniorSummary.keyMetrics,
      timeline: scenario.seniorSummary.timeline,
      quote: scenario.quote,
      amortizationTable: scenario.amortizationTable,
      savingsScenario: scenario.savingsScenario
    };
  }

  // Validate scenario before creation
  validateScenarioInput(flow: BusinessFlow, market: Market, config: any): { valid: boolean; errors: string[] } {
    const errors: string[] = [];

    // Basic validations
    if (!config.clientName || config.clientName.trim().length < 2) {
      errors.push('El nombre del cliente es requerido');
    }

    // Flow-specific validations
    if (flow === BusinessFlow.VentaPlazo) {
      if (!config.totalPrice || config.totalPrice <= 0) {
        errors.push('El precio total debe ser mayor a cero');
      }
      if (!config.downPayment || config.downPayment <= 0) {
        errors.push('El enganche debe ser mayor a cero');
      }
      if (config.downPayment >= config.totalPrice) {
        errors.push('El enganche no puede ser mayor o igual al precio total');
      }
    }

    // Market-specific validations
    if (market === 'aguascalientes' && config.term && ![12, 24].includes(config.term)) {
      errors.push('Para Aguascalientes, los plazos v√°lidos son 12 o 24 meses');
    }
    if (market === 'edomex' && config.term && ![48, 60].includes(config.term)) {
      errors.push('Para Estado de M√©xico, los plazos v√°lidos son 48 o 60 meses');
    }

    return {
      valid: errors.length === 0,
      errors
    };
  }
}
