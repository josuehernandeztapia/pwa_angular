import{a as b}from"./chunk-XIPGL6BB.js";import{e as S}from"./chunk-SCHFUJ5K.js";import{V as f,_ as y,f as v,g as m}from"./chunk-5IDTUAMZ.js";import{a as p,b as _,g}from"./chunk-DM275RSA.js";var I=(()=>{class u{constructor(e){this.http=e,this.baseUrl=b.apiUrl,this.mediaRecorder=null,this.audioChunks=[],this.currentSession$=new m(null),this.isRecording$=new m(!1),this.recordingError$=new v,this.voiceEvaluations=[],this.requestIdCounter=0,this.municipalityQuestions={aguascalientes_individual:{municipality:"aguascalientes",product_type:"individual",required_questions:[{id:"years_driving",text:"\xBFCu\xE1ntos a\xF1os tienes manejando ruta de transporte p\xFAblico?",category:"operational",mandatory:!0,expected_answer_type:"numeric",validation_rules:["min_2_years"]},{id:"route_ownership",text:"\xBFLa ruta que manejas es propia, rentada o trabajas para un patr\xF3n?",category:"operational",mandatory:!0,expected_answer_type:"specific"},{id:"vehicle_gnv",text:"\xBFTu veh\xEDculo ya tiene instalaci\xF3n de GNV o necesitar\xEDas conversi\xF3n?",category:"financial",mandatory:!0,expected_answer_type:"specific"},{id:"previous_credits",text:"\xBFTienes alg\xFAn cr\xE9dito activo con otra financiera de transporte?",category:"financial",mandatory:!0,expected_answer_type:"yes_no"},{id:"daily_schedule",text:"\xBFEn qu\xE9 horarios oper\xE1s tu ruta normalmente?",category:"operational",mandatory:!0,expected_answer_type:"descriptive"},{id:"monthly_income",text:"Aproximadamente, \xBFcu\xE1nto generas de ingresos al mes con la ruta?",category:"financial",mandatory:!0,expected_answer_type:"numeric",validation_rules:["coherence_with_form"]}],legal_requirements:["Consentimiento para consulta en bur\xF3 de cr\xE9dito","Autorizaci\xF3n para verificar referencias","Aceptaci\xF3n de t\xE9rminos y condiciones"],risk_factors:["income_inconsistency","route_instability","credit_history"]},edomex_colectivo:{municipality:"estado_de_mexico",product_type:"colectivo",required_questions:[{id:"group_leader",text:"\xBFQui\xE9n es el l\xEDder o coordinador de su grupo de transportistas?",category:"operational",mandatory:!0,expected_answer_type:"specific"},{id:"group_size",text:"\xBFCu\xE1ntos transportistas forman parte de su grupo?",category:"operational",mandatory:!0,expected_answer_type:"numeric"},{id:"collective_guarantee",text:"\xBFEntiende que todo el grupo responde por el pago de cada miembro?",category:"legal",mandatory:!0,expected_answer_type:"yes_no"},{id:"route_permits",text:"\xBFSu grupo tiene todos los permisos vigentes para operar la ruta?",category:"legal",mandatory:!0,expected_answer_type:"yes_no"}],legal_requirements:["Aval solidario grupal","Verificaci\xF3n de permisos de ruta","Consentimientos individuales y colectivos"],risk_factors:["group_stability","leadership_quality","permit_compliance"]}},this.EDOMEX_GEOGRAPHIC_SCORING={ecatepec_morelos:{municipality:"Ecatepec de Morelos",score:15,extortion_risk:.9,political_pressure:.7,crime_incidence:.9,route_stability:.2,factors:["cobro_cuotas_grupos","robo_unidades","av_central_critica","via_morelos_inestable"]},nezahualcoyotl:{municipality:"Nezahualc\xF3yotl",score:20,extortion_risk:.8,political_pressure:.6,crime_incidence:.7,route_stability:.3,factors:["valle_aragon_extorsion","benito_juarez_problemas","presion_vecinal"]},naucalpan:{municipality:"Naucalpan",score:45,extortion_risk:.4,political_pressure:.6,crime_incidence:.5,route_stability:.6,factors:["bloqueos_sindicales","periferico_conflictivo","gustavo_baz_riesgo"]},cuautitlan_izcalli:{municipality:"Cuautitl\xE1n Izcalli",score:75,extortion_risk:.3,political_pressure:.2,crime_incidence:.4,route_stability:.8,factors:["rutas_obreras_estables","menos_presion_sindical","industrial_estable"]},huixquilucan:{municipality:"Huixquilucan",score:85,extortion_risk:.1,political_pressure:.2,crime_incidence:.2,route_stability:.9,factors:["interlomas_estable","alta_plusvalia","baja_criminalidad"]}},this.RESILIENCE_QUESTIONS_CORE=[{id:"seasonal_vulnerability",text:"\xBFEn qu\xE9 \xE9poca del a\xF1o se te complica m\xE1s trabajar?",category:"resilience",mandatory:!0,expected_answer_type:"descriptive",voice_flags:["rapid_response","specific_mention"],weight:8,go_no_go_impact:!0},{id:"unit_substitution",text:"Si no puedes manejar un d\xEDa, \xBFqui\xE9n cubre la unidad?",category:"resilience",mandatory:!0,expected_answer_type:"specific",voice_flags:["concrete_name","no_long_hesitation"],weight:8,go_no_go_impact:!0},{id:"cost_crisis_adjustment",text:"Si sube el gas, \xBFc\xF3mo ajustas tus pagos?",category:"resilience",mandatory:!0,expected_answer_type:"descriptive",voice_flags:["clear_solution","no_evasion"],weight:6,go_no_go_impact:!1},{id:"route_security_issues",text:"\xBFEn tu ruta has tenido problemas de cobros o extorsi\xF3n?",category:"resilience",mandatory:!0,expected_answer_type:"descriptive",voice_flags:["firm_response","no_tone_changes"],weight:10,go_no_go_impact:!0},{id:"health_contingency",text:"\xBFQu\xE9 pasa si te enfermas 15 d\xEDas?",category:"resilience",mandatory:!0,expected_answer_type:"descriptive",voice_flags:["mentions_substitute","no_denial"],weight:8,go_no_go_impact:!0},{id:"expense_priority",text:"Cuando se te juntan gastos, \xBFqu\xE9 pagas primero?",category:"resilience",mandatory:!0,expected_answer_type:"specific",voice_flags:["mentions_unit","confident_tone"],weight:6,go_no_go_impact:!1},{id:"credit_experience",text:"\xBFAlguna vez te atrasaste en un cr\xE9dito? \xBFC\xF3mo lo resolviste?",category:"resilience",mandatory:!0,expected_answer_type:"descriptive",voice_flags:["concrete_story","no_nervousness"],weight:8,go_no_go_impact:!0},{id:"economic_support_network",text:"\xBFQui\xE9n te ayuda si no alcanzas para el pago?",category:"resilience",mandatory:!0,expected_answer_type:"specific",voice_flags:["mentions_family","no_long_silence"],weight:8,go_no_go_impact:!0},{id:"unexpected_events",text:"\xBFQu\xE9 haces si bloquean tu ruta un d\xEDa?",category:"resilience",mandatory:!0,expected_answer_type:"descriptive",voice_flags:["alternative_solution","no_evasion"],weight:6,go_no_go_impact:!1},{id:"emergency_savings",text:"\xBFGuardas algo cada mes para emergencias?",category:"resilience",mandatory:!0,expected_answer_type:"yes_no",voice_flags:["mentions_tanda_or_savings","no_nervous_laughter"],weight:6,go_no_go_impact:!1},{id:"family_dependents",text:"\xBFCu\xE1ntas personas dependen de lo que ganas aqu\xED?",category:"resilience",mandatory:!0,expected_answer_type:"numeric",voice_flags:["clear_number","no_contradictions"],weight:5,go_no_go_impact:!1},{id:"future_vision",text:"\xBFD\xF3nde te ves en 5 a\xF1os con tu unidad?",category:"resilience",mandatory:!0,expected_answer_type:"descriptive",voice_flags:["growth_mention","no_evasion"],weight:5,go_no_go_impact:!1}],this.ADDITIONAL_RESILIENCE_QUESTIONS=[{id:"route_blockade_response",text:"\xBFQu\xE9 haces si tu ruta es bloqueada por un operativo?",category:"resilience",mandatory:!0,expected_answer_type:"descriptive",voice_flags:["solution_oriented","no_evasion"],weight:7,go_no_go_impact:!1},{id:"base_cuota_experience",text:"\xBFAlguna vez has tenido que pagar cuota en tu base?",category:"resilience",mandatory:!0,expected_answer_type:"yes_no",voice_flags:["honesty","no_nervousness"],weight:9,go_no_go_impact:!0},{id:"unit_breakdown_support",text:"\xBFQui\xE9n te ayuda si tu unidad queda parada una semana?",category:"resilience",mandatory:!0,expected_answer_type:"specific",voice_flags:["specific_names","confidence"],weight:8,go_no_go_impact:!0}],this.checkBrowserSupport()}checkBrowserSupport(){let e=!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia);return e||console.error("Voice recording not supported in this browser"),e}initializeRecording(){return g(this,null,function*(){try{let e=yield navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,sampleRate:44100}});return this.mediaRecorder=new MediaRecorder(e,{mimeType:"audio/webm;codecs=opus"}),this.setupRecorderHandlers(),!0}catch(e){return console.error("Failed to initialize recording:",e),this.recordingError$.next("No se pudo acceder al micr\xF3fono. Verifique permisos."),!1}})}setupRecorderHandlers(){this.mediaRecorder&&(this.mediaRecorder.ondataavailable=e=>{e.data.size>0&&this.audioChunks.push(e.data)},this.mediaRecorder.onstop=()=>{this.processRecording()},this.mediaRecorder.onerror=e=>{console.error("Recording error:",e),this.recordingError$.next("Error durante la grabaci\xF3n")})}startVoiceSession(e,t,i,o,s){return g(this,null,function*(){let r={session_id:`voice_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,advisor_id:e,client_id:t,session_type:i,municipality:o,product_type:s,started_at:new Date().toISOString(),status:"recording"};if(!(yield this.initializeRecording()))throw new Error("Cannot initialize voice recording");return this.currentSession$.next(r),r})}startRecording(){if(!this.mediaRecorder||this.mediaRecorder.state!=="inactive")return;this.audioChunks=[],this.mediaRecorder.start(1e3),this.isRecording$.next(!0);let e=this.currentSession$.value;e&&(e.status="recording",this.currentSession$.next(e))}stopRecording(){if(!this.mediaRecorder||this.mediaRecorder.state!=="recording")return;this.mediaRecorder.stop(),this.isRecording$.next(!1),this.mediaRecorder.stream.getTracks().forEach(t=>t.stop());let e=this.currentSession$.value;e&&(e.status="processing",this.currentSession$.next(e))}processRecording(){return g(this,null,function*(){if(this.audioChunks.length===0){this.recordingError$.next("No se grab\xF3 audio");return}let e=new Blob(this.audioChunks,{type:"audio/webm"}),t=this.currentSession$.value;if(!t){this.recordingError$.next("No hay sesi\xF3n activa");return}try{yield this.uploadAndProcessAudio(e,t)}catch(i){console.error("Failed to process recording:",i),this.recordingError$.next("Error al procesar la grabaci\xF3n"),t&&(t.status="failed",this.currentSession$.next(t))}})}uploadAndProcessAudio(e,t){return g(this,null,function*(){let i=new FormData;i.append("audio",e,`${t.session_id}.webm`),i.append("session_data",JSON.stringify(t));let o=`${t.municipality}_${t.product_type}`,s=this.municipalityQuestions[o];i.append("required_questions",JSON.stringify(s));let r=yield this.http.post(`${this.baseUrl}/voice/upload-and-process`,i,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}}).toPromise();r?.success&&this.pollProcessingResults(r.processing_id,t.session_id)})}pollProcessingResults(e,t){let i=setInterval(()=>g(this,null,function*(){try{let o=yield this.getProcessingResult(e);o.status==="completed"?(clearInterval(i),this.handleProcessingComplete(o.data,t)):o.status==="failed"&&(clearInterval(i),this.handleProcessingFailed(o.error,t))}catch(o){console.error("Error polling results:",o),clearInterval(i)}}),2e3);setTimeout(()=>clearInterval(i),3e5)}getProcessingResult(e){return g(this,null,function*(){return this.http.get(`${this.baseUrl}/voice/processing/${e}`,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}}).toPromise()})}handleProcessingComplete(e,t){let i=this.currentSession$.value;i&&i.session_id===t&&(i.status="completed",this.currentSession$.next(i)),localStorage.setItem(`voice_result_${t}`,JSON.stringify(e)),this.onValidationComplete(e)}handleProcessingFailed(e,t){let i=this.currentSession$.value;i&&i.session_id===t&&(i.status="failed",this.currentSession$.next(i)),this.recordingError$.next(`Procesamiento fall\xF3: ${e}`)}getValidationResult(e){return g(this,null,function*(){try{return(yield this.http.get(`${this.baseUrl}/voice/results/${e}`,{headers:{Authorization:`Bearer ${this.getAuthToken()}`}}).toPromise())||null}catch{let i=localStorage.getItem(`voice_result_${e}`);return i?JSON.parse(i):null}})}getRequiredQuestions(e,t){let i=`${e}_${t}`;return this.municipalityQuestions[i]?.required_questions||[]}calculateComplianceScore(e){let t={questions_completeness:Math.max(0,100-e.questions_missing.length*15),coherence_score:e.coherence_analysis.overall_score,risk_penalty:Math.max(0,e.risk_flags.length*-10),legal_compliance:e.digital_stamps.filter(o=>o.valid).length*25};return{total_score:Math.max(0,Math.min(100,t.questions_completeness*.3+t.coherence_score*.3+t.risk_penalty*.2+t.legal_compliance*.2)),breakdown:t}}getNextRequiredQuestion(e,t,i,o){let r=this.getRequiredQuestions(t,i).filter(a=>!o.includes(a.id));return r.find(a=>a.mandatory)||r[0]||null}generateInterviewGuide(e,t){let i=this.getRequiredQuestions(e,t);return{introduction:`Vamos a hacer algunas preguntas obligatorias para ${t} en ${e}. La conversaci\xF3n ser\xE1 grabada para validaci\xF3n.`,questions:i,closing:"Perfecto, hemos completado todas las preguntas obligatorias. \xBFTienes alguna duda adicional?",tips:["Hable claro y pausado","Haga todas las preguntas listadas","Verifique coherencia con el formulario","Documente cualquier inconsistencia"]}}get currentSession(){return this.currentSession$.asObservable()}get isRecording(){return this.isRecording$.asObservable()}get recordingErrors(){return this.recordingError$.asObservable()}onValidationComplete(e){let t=new CustomEvent("voiceValidationComplete",{detail:e});window.dispatchEvent(t)}getAuthToken(){return localStorage.getItem("auth_token")||""}formatDuration(e){let t=Math.floor(e/1e3),i=Math.floor(t/60),o=t%60;return`${i}:${o.toString().padStart(2,"0")}`}getRiskFlagIcon(e){switch(e.severity){case"critical":return"\u{1F6A8}";case"high":return"\u26A0\uFE0F";case"medium":return"\u26A1";case"low":return"\u2139\uFE0F";default:return"\u{1F50D}"}}getComplianceColor(e){return e>=90?"#22c55e":e>=70?"#eab308":e>=50?"#f97316":"#ef4444"}calculateGeographicRisk(e){let t=e.toLowerCase().replace(/\s+/g,"_"),i=this.EDOMEX_GEOGRAPHIC_SCORING[t];return i?i.score/100:.9}calculateHASEScore(e=.5,t,i,o){let s=e,r=this.calculateGeographicRisk(t),a=this.calculateResilienceScore(o),n=this.calculateVoiceScore(i),l=a*.6+n*.4,c=s*.3+r*.2+l*.5,h=c>=.55&&n>=.6&&this.hasNoMajorRedFlags(i),d=h&&this.hasVulnerabilityIndicators(o);return{historical_gnv:s,geographic_risk:r,voice_resilience:l,total_score:c,go_no_go_eligible:h,protection_auto_activate:d}}calculateResilienceScore(e){let i=0;return e.forEach(o=>{let s=[...this.RESILIENCE_QUESTIONS_CORE,...this.ADDITIONAL_RESILIENCE_QUESTIONS].find(r=>r.id===o.questionId);s&&o.valid&&(i+=s.weight||5)}),Math.min(i/78,1)}calculateVoiceScore(e){if(!e)return .5;let t=e.honesty||.5,i=(e.nervousness||0)*.5,o=(e.evasion||0)*.6;return Math.max(0,t-i-o)}hasNoMajorRedFlags(e){return e?(e.nervousness||0)<.7&&(e.evasion||0)<.6:!0}hasVulnerabilityIndicators(e){let t=["seasonal_vulnerability","cost_crisis_adjustment","health_contingency"];return e.some(i=>t.includes(i.questionId)&&i.mentions_vulnerability===!0)}evaluateAudio(e,t,i,o){return g(this,null,function*(){let s=new FormData;s.append("audio",e,"response.wav"),s.append("questionId",t),s.append("contextId",i),o&&s.append("municipality",o);let r=this.generateRequestId();try{console.log(`\u{1F3A4} Evaluating audio for question: ${t}`);let a=yield this.http.post(`${this.baseUrl}/v1/voice/evaluate-audio`,s,{headers:{"X-Request-Id":r}}).toPromise();if(!a)throw new Error("Empty response from voice analysis service");return this.storeVoiceEvaluation(a),console.log(`\u2705 Voice analysis completed: ${a.decision} (score: ${a.voiceScore})`),a}catch(a){console.warn(`\u26A0\uFE0F Voice analysis failed for ${t}:`,a);let n=this.applyHeuristicFallback(e,t);return this.storeVoiceEvaluation(n),n}})}applyHeuristicFallback(e,t){console.log(`\u{1F504} Applying heuristic fallback for question: ${t}`);let i=e.size/16e3,o=e.size/i,s=.5,r=["audio_analysis_failed"];return i<2?(s-=.3,r.push("response_too_short")):i>30?(s-=.2,r.push("response_too_long")):s+=.1,o<1e3&&(s-=.2,r.push("low_audio_quality")),s=Math.max(0,Math.min(1,s)),{questionId:t,voiceScore:s,decision:"REVIEW",flags:r,fallback:!0,message:"An\xE1lisis de voz fall\xF3, usando an\xE1lisis b\xE1sico. Marcado para revisi\xF3n manual.",processingTime:"0ms"}}storeVoiceEvaluation(e){this.voiceEvaluations=this.voiceEvaluations.filter(t=>t.questionId!==t.questionId),this.voiceEvaluations.push({questionId:e.questionId,voiceScore:e.voiceScore,flags:e.flags,decision:e.decision,timestamp:Date.now(),fallback:e.fallback}),console.log(`\u{1F4BE} Stored voice evaluation: ${e.questionId} = ${e.decision}`)}generateRequestId(){return this.requestIdCounter++,`req_${Date.now()}_${this.requestIdCounter}`}aggregateResilience(){if(console.log(`\u{1F4CA} Aggregating resilience from ${this.voiceEvaluations.length} voice evaluations`),this.voiceEvaluations.length===0)return{voiceResilienceScore:0,finalDecision:"REVIEW",reviewCount:0,noGoCount:0,goCount:0,totalQuestions:0,humanReviewRequired:!0,criticalFlags:["no_voice_evaluations"]};let e=78,t=0,i=0,o=0,s=0,r=[];this.voiceEvaluations.forEach(c=>{let d=this.findQuestionById(c.questionId)?.weight||5;switch((c.flags.includes("unstablePitch")||c.flags.includes("highLatency"))&&r.push(...c.flags),c.decision){case"GO":t+=d,s++;break;case"REVIEW":t+=d*.5,i++;break;case"NO-GO":o++;break}c.fallback&&(t-=d*.1,r.push("fallback_used"))});let a=Math.max(0,Math.min(1,t/e)),n=this.determineFinalDecision(a,i,o,this.voiceEvaluations.length);r=[...new Set(r)];let l={voiceResilienceScore:a,finalDecision:n,reviewCount:i,noGoCount:o,goCount:s,totalQuestions:this.voiceEvaluations.length,humanReviewRequired:n==="REVIEW"||o>0||r.length>2,criticalFlags:r};return console.log("\u2705 Resilience aggregation completed:",l),l}determineFinalDecision(e,t,i,o){return i>=2||i>=1&&e<.4||e<.3?"NO-GO":e>=.75&&i===0&&t<=2||e>=.6&&i===0&&t<=Math.floor(o*.3)?"GO":"REVIEW"}findQuestionById(e){return[...this.RESILIENCE_QUESTIONS_CORE,...this.ADDITIONAL_RESILIENCE_QUESTIONS,...Object.values(this.municipalityQuestions).flatMap(i=>i.required_questions)].find(i=>i.id===e)}getVoiceEvaluations(){return[...this.voiceEvaluations]}clearVoiceEvaluations(){console.log(`\u{1F9F9} Clearing ${this.voiceEvaluations.length} voice evaluations`),this.voiceEvaluations=[]}generateVoicePattern(){let e=["Mi voz confirma mi identidad para Conductores","Autorizo verificaci\xF3n de identidad por voz","Hoy confirmo mi identidad con mi voz","Verificaci\xF3n de identidad por voz completada"];return e[Math.floor(Math.random()*e.length)]}getVoiceEvaluationByQuestion(e){return this.voiceEvaluations.find(t=>t.questionId===e)}hasVoiceEvaluation(e){return this.voiceEvaluations.some(t=>t.questionId===e)}generateMockValidationResult(e){return{session_id:e,transcript:"Mock transcript of the interview...",compliance_score:85,questions_asked:["years_driving","route_ownership","vehicle_gnv"],questions_missing:["previous_credits"],risk_flags:[{type:"inconsistency",severity:"medium",description:"Income reported differs from expected range",evidence:"Declared $30K but route typically generates $18-22K",timestamp_in_audio:145.5}],coherence_analysis:{overall_score:78,cross_validation_score:85,temporal_consistency:92,detail_specificity:65,inconsistencies:[]},digital_stamps:[{stamp_type:"questions_completed",timestamp:new Date().toISOString(),valid:!1,evidence_hash:"abc123..."}],processing_completed_at:new Date().toISOString()}}static{this.\u0275fac=function(t){return new(t||u)(y(S))}}static{this.\u0275prov=f({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();var $=(()=>{class u{constructor(){this.configSubject=new m({haseContribution:25,microLocalQuestions:2,isActive:!0,questions:[{id:"p1",text:"Por favor, d\xEDgame su nombre completo y edad",order:1,isActive:!0,weight:5,category:"personal"},{id:"p2",text:"\xBFDe qu\xE9 ruta espec\xEDfica es usted?",order:2,isActive:!0,weight:10,category:"personal"},{id:"p3",text:"\xBFCu\xE1ntos a\xF1os lleva trabajando en esa ruta?",order:3,isActive:!0,weight:15,category:"personal"},{id:"o1",text:"\xBFCu\xE1ntas vueltas da al d\xEDa en su ruta?",order:4,isActive:!0,weight:15,category:"operation"},{id:"o2",text:"\xBFDe cu\xE1ntos kil\xF3metros es cada vuelta aproximadamente?",order:5,isActive:!0,weight:10,category:"operation"},{id:"o3",text:"\xBFCu\xE1les son sus ingresos promedio diarios?",order:6,isActive:!0,weight:20,category:"operation"},{id:"o4",text:"\xBFCu\xE1nto gasta al d\xEDa en combustible?",order:7,isActive:!0,weight:15,category:"operation"},{id:"o5",text:"\xBFCu\xE1ntas vueltas hace con esa carga de combustible?",order:8,isActive:!0,weight:10,category:"operation"},{id:"b1",text:"\xBFCu\xE1ntos choferes tiene trabajando?",order:9,isActive:!0,weight:15,category:"business"},{id:"b2",text:"\xBFUsted opera la unidad o solo administra el negocio?",order:10,isActive:!0,weight:10,category:"business"},{id:"b3",text:"\xBFEs due\xF1o de concesi\xF3n o permisionario?",order:11,isActive:!0,weight:20,category:"business"},{id:"v1",text:"\xBFQu\xE9 modelo y a\xF1o es su unidad, y ya tiene su factura liberada?",order:12,isActive:!0,weight:12,category:"vehicle"},{id:"v2",text:"\xBFQu\xE9 tipo de combustible utiliza: GNV, GLP o gasolina?",order:13,isActive:!0,weight:8,category:"vehicle"},{id:"v3",text:"\xBFSolo tiene una unidad o tiene m\xE1s veh\xEDculos?",order:14,isActive:!0,weight:10,category:"vehicle"},{id:"r1",text:"\xBFC\xF3mo maneja su ruta cuando llueve fuerte o hay mal tiempo?",order:15,isActive:!0,weight:12,category:"resilience"},{id:"r2",text:"\xBFQu\xE9 hace cuando hay obras o bloqueos en su corredor principal?",order:16,isActive:!0,weight:15,category:"resilience"},{id:"r3",text:"\xBFLe afectan mucho las vacaciones escolares en sus ingresos?",order:17,isActive:!0,weight:10,category:"resilience"},{id:"r4",text:"\xBFHa tenido que adaptarse a cambios en rutas por nuevas regulaciones?",order:18,isActive:!0,weight:13,category:"resilience"},{id:"r5",text:"\xBFC\xF3mo compite cuando llegan nuevos transportistas a su zona?",order:19,isActive:!0,weight:15,category:"resilience"}]}),this.config$=this.configSubject.asObservable(),this.loadConfigFromStorage()}getConfig(){return this.configSubject.value}updateHaseContribution(e){if(e>=0&&e<=100){let t=this.configSubject.value;this.configSubject.next(_(p({},t),{haseContribution:e})),this.saveConfigToStorage()}}toggleAviSystem(e){let t=this.configSubject.value;this.configSubject.next(_(p({},t),{isActive:e})),this.saveConfigToStorage()}getActiveQuestions(){return this.configSubject.value.questions.filter(e=>e.isActive).sort((e,t)=>e.order-t.order)}updateQuestion(e,t){let i=this.configSubject.value,o=i.questions.findIndex(s=>s.id===e);return o===-1?!1:(i.questions[o]=p(p({},i.questions[o]),t),this.configSubject.next(p({},i)),this.saveConfigToStorage(),!0)}toggleQuestion(e){let i=this.configSubject.value.questions.find(o=>o.id===e);return i?this.updateQuestion(e,{isActive:!i.isActive}):!1}updateQuestionWeight(e,t){return t<0||t>100?!1:this.updateQuestion(e,{weight:t})}addCustomQuestion(e,t,i=10){let o=this.configSubject.value,s=`custom_${Date.now()}`,r=Math.max(...o.questions.map(n=>n.order),0),a={id:s,text:e,category:t,weight:i,order:r+1,isActive:!0};return this.configSubject.next(_(p({},o),{questions:[...o.questions,a]})),this.saveConfigToStorage(),s}removeQuestion(e){let t=this.configSubject.value,i=t.questions.filter(o=>o.id!==e);return i.length===t.questions.length?!1:(this.configSubject.next(_(p({},t),{questions:i})),this.saveConfigToStorage(),!0)}calculateAviScore(e,t){let i=this.getActiveQuestions(),o=0,s=0;i.forEach(n=>{let l=e[n.id];if(l!==void 0&&l!==""){let c=this.scoreResponse(n,l);o+=c*n.weight,s+=n.weight}});let r=s>0?o/s:0;if(t&&t.overallFraudScore>0){let n=this.calculateFraudPenalty(t);r=Math.max(0,r-n)}let a=this.getConfig();return r*a.haseContribution/100}calculateFraudPenalty(e){let t=e.overallFraudScore,i=e.redFlags.filter(r=>r.severity==="HIGH").length,o=e.redFlags.filter(r=>r.severity==="MEDIUM").length,s=0;return t>70?s=40:t>50?s=25:t>30&&(s=10),s+=i*5+o*2,e.redFlags.forEach(r=>{switch(r.type){case"REHEARSED_SPEECH":s+=15;break;case"STRESS_DETECTED":s+=r.severity==="HIGH"?8:4;break;case"INCONSISTENT_RESPONSE":s+=r.severity==="HIGH"?10:5;break;case"LOW_CONFIDENCE":s+=r.severity==="HIGH"?6:3;break;case"LONG_HESITATION":s+=r.severity==="HIGH"?7:3;break}}),Math.min(s,80)}scoreResponse(e,t){if(t==null||t==="")return 0;if(typeof t=="number")return e.id==="o3"?t>=1e3?90:t>=600?70:t>=400?50:30:e.id==="p3"?t>=10?90:t>=5?75:t>=2?60:40:t>0?70:30;if(typeof t=="string"){let i=t.toLowerCase(),o=["s\xED","si","bueno","excelente","propio","due\xF1o","varios","muchos"],s=["no","poco","nada","malo","problema","deuda"],r=o.some(n=>i.includes(n)),a=s.some(n=>i.includes(n));return r&&!a?80:a&&!r?30:60}return 50}calculateHaseScore(e,t){let i=this.getConfig(),o=i.isActive?this.calculateAviScore(e,t):0,s=100-i.haseContribution,r=this.generateDummyScores(s,o,t);return{avi_score:o,financial_score:r.financial,document_score:r.document,market_score:r.market,behavioral_score:r.behavioral,total:o+r.financial+r.document+r.market+r.behavioral}}generateDummyScores(e,t,i){let o=t/this.getConfig().haseContribution*e,s=.2,r=1;if(i&&i.overallFraudScore>0){let d=i.overallFraudScore/100;r=Math.max(.4,1-d*.3)}let a=Math.max(0,Math.min(30,(o*.4+(Math.random()-.5)*s*30)*r)),n=Math.max(0,Math.min(20,(o*.27+(Math.random()-.5)*s*20)*r)),l=Math.max(0,Math.min(15,(o*.2+(Math.random()-.5)*s*15)*r)),c=r;i?.redFlags?.some(d=>d.type==="STRESS_DETECTED"||d.type==="LOW_CONFIDENCE"||d.type==="INCONSISTENT_RESPONSE")&&(c*=.7);let h=Math.max(0,Math.min(10,(o*.13+(Math.random()-.5)*s*10)*c));return{financial:a,document:n,market:l,behavioral:h}}exportConfig(){return JSON.stringify(this.configSubject.value,null,2)}importConfig(e){try{let t=JSON.parse(e);return t.questions&&Array.isArray(t.questions)&&typeof t.haseContribution=="number"?(this.configSubject.next(t),this.saveConfigToStorage(),!0):!1}catch(t){return console.error("Error importing AVI config:",t),!1}}resetToDefaults(){let e=new u().configSubject.value;this.configSubject.next(e),this.saveConfigToStorage()}saveConfigToStorage(){try{localStorage.setItem("avi_config",JSON.stringify(this.configSubject.value))}catch(e){console.warn("Could not save AVI config to localStorage:",e)}}loadConfigFromStorage(){try{let e=localStorage.getItem("avi_config");if(e){let t=JSON.parse(e);this.configSubject.next(t)}}catch(e){console.warn("Could not load AVI config from localStorage:",e)}}getConfigSummary(){let e=this.configSubject.value,t=e.questions.filter(o=>o.isActive),i=t.reduce((o,s)=>o+s.weight,0);return{isActive:e.isActive,haseContribution:e.haseContribution,totalQuestions:e.questions.length,activeQuestions:t.length,totalWeight:i,categories:{personal:t.filter(o=>o.category==="personal").length,operation:t.filter(o=>o.category==="operation").length,business:t.filter(o=>o.category==="business").length,vehicle:t.filter(o=>o.category==="vehicle").length}}}static{this.\u0275fac=function(t){return new(t||u)}}static{this.\u0275prov=f({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();export{I as a,$ as b};
