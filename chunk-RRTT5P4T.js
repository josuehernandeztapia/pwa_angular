import{a as Ue}from"./chunk-FMSL7TFC.js";import{c as qe}from"./chunk-4M7CYCOE.js";import{a as $e,b as ze}from"./chunk-DFQSZCRA.js";import{a as ne}from"./chunk-XIPGL6BB.js";import{a as Te,e as te,k as Ae,m as Re}from"./chunk-SCHFUJ5K.js";import{a as ve}from"./chunk-YYSQDTD3.js";import{a as V,c as de,d as E}from"./chunk-QCEAPM7G.js";import{b as Fe,d as Ve,g as Ne,u as Le}from"./chunk-S2UEMBMO.js";import{$ as R,A as v,Ea as c,Fa as ae,G as Q,I as J,Kb as N,Lb as ke,Ma as K,N as xe,Q as ee,R as oe,S as O,Sa as h,Ta as Pe,Ua as p,V as F,Va as G,Wa as H,Xa as P,Xb as Y,Ya as o,Yb as q,Za as a,_ as Se,_a as k,_b as he,bb as I,bc as U,c as ye,cb as x,db as m,ea as $,eb as Ee,f as B,fb as Me,g as ue,gb as we,h as j,ib as r,j as _,jb as f,k as ge,kb as b,lb as W,ma as y,n as w,na as C,o as fe,ob as De,pb as Ie,qb as Oe,sb as z,t as Ce,va as se,vb as ce,xb as le}from"./chunk-5IDTUAMZ.js";import{a as M,b as D,g as Z}from"./chunk-DM275RSA.js";var Be=(()=>{class i{constructor(){this.questionPools=new Map,this.REFRESH_INTERVAL_DAYS=30,this.initializeLocalQuestionPools()}initializeLocalQuestionPools(){let e=[{id:"ags_001",question:"\xBFEn qu\xE9 esquina del centro hist\xF3rico est\xE1 el McDonald's m\xE1s conocido?",category:"location",difficulty:"easy",zone:"aguascalientes_centro",expectedAnswerType:"specific_place"},{id:"ags_002",question:"\xBFC\xF3mo le dicen los choferes al t\xFAnel de la Avenida Ch\xE1vez?",category:"cultural",difficulty:"medium",zone:"aguascalientes_centro",expectedAnswerType:"local_term"},{id:"ags_003",question:"\xBFD\xF3nde compran las llantas m\xE1s baratas en L\xF3pez Mateos?",category:"business",difficulty:"medium",zone:"aguascalientes_lopez_mateos",expectedAnswerType:"specific_place"},{id:"ags_004",question:"\xBFEn qu\xE9 parada de la Ruta 5 siempre se suben m\xE1s estudiantes?",category:"route",difficulty:"hard",zone:"aguascalientes_ruta5",expectedAnswerType:"route_detail"},{id:"ags_005",question:"\xBFCu\xE1l es el taller mec\xE1nico que m\xE1s recomiendan en tu ruta?",category:"business",difficulty:"medium",zone:"aguascalientes_general",expectedAnswerType:"specific_place"}],t=[{id:"edomex_001",question:"\xBFQu\xE9 l\xEDnea del Mexib\xFAs te deja m\xE1s cerca del Palacio Municipal?",category:"route",difficulty:"medium",zone:"edomex_ecatepec",expectedAnswerType:"route_detail"},{id:"edomex_002",question:"\xBFC\xF3mo le dicen los locales al cerro que est\xE1 al lado de la V\xEDa Morelos?",category:"cultural",difficulty:"hard",zone:"edomex_ecatepec",expectedAnswerType:"local_term"},{id:"edomex_003",question:"\xBFEn qu\xE9 mercado venden las refacciones m\xE1s baratas para microbuses?",category:"business",difficulty:"medium",zone:"edomex_general",expectedAnswerType:"specific_place"},{id:"edomex_004",question:"\xBFD\xF3nde est\xE1 el sem\xE1foro donde siempre hacen operativos de tr\xE1nsito?",category:"location",difficulty:"hard",zone:"edomex_general",expectedAnswerType:"specific_place"},{id:"edomex_005",question:"\xBFEn qu\xE9 terminal de autobuses cargan gas los transportistas?",category:"business",difficulty:"medium",zone:"edomex_general",expectedAnswerType:"specific_place"}];this.questionPools.set("aguascalientes",{zone:"aguascalientes",municipality:"aguascalientes",questions:e,lastUpdated:new Date,version:"1.0.0"}),this.questionPools.set("edomex",{zone:"edomex",municipality:"edomex",questions:t,lastUpdated:new Date,version:"1.0.0"})}getRandomMicroLocalQuestions(e,t=2,n){let s=this.questionPools.get(e);if(!s)return _([]);let l=s.questions;n&&(l=s.questions.filter(g=>g.zone===n||g.zone.includes("general")));let d=this.shuffleArray([...l]).slice(0,Math.min(t,l.length));return _(d)}refreshQuestionsFromLLM(e){return Z(this,null,function*(){try{let t=this.questionPools.get(e);if(t&&!this.needsRefresh(t.lastUpdated))return!1;let n=yield this.generateQuestionsViaLLM(e);if(n.length>0){let s={zone:e,municipality:e,questions:n,lastUpdated:new Date,version:this.generateVersion()};return this.questionPools.set(e,s),this.saveQuestionPoolToStorage(e,s),!0}return!1}catch(t){return console.error("Error refreshing questions from LLM:",t),!1}})}generateQuestionsViaLLM(e){return Z(this,null,function*(){let t=this.buildLLMPrompt(e);try{let n=yield fetch("/api/generate-micro-local-questions",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:t,municipality:e,count:20,exclude_previous:this.getPreviousQuestions(e)})});if(!n.ok)throw new Error("LLM API call failed");let s=yield n.json();return this.parseLLMResponse(s.questions,e)}catch(n){return console.error("LLM API error:",n),[]}})}buildLLMPrompt(e){return`
Genera 20 preguntas micro-locales espec\xEDficas para transportistas de ${{aguascalientes:"Aguascalientes, M\xE9xico - transportistas urbanos, rutas del centro hist\xF3rico, L\xF3pez Mateos, terminales de autobuses",edomex:"Estado de M\xE9xico - transportistas que operan rutas hacia CDMX, Mexib\xFAs, microbuses, Ecatepec, Naucalpan"}[e]}.

REQUISITOS CR\xCDTICOS:
1. Preguntas que SOLO un transportista local podr\xEDa responder
2. NO se pueden googlear f\xE1cilmente
3. Relacionadas con: talleres, gasolineras, sem\xE1foros conocidos, terminales, rutas espec\xEDficas
4. Evitar preguntas demasiado obvias o tur\xEDsticas
5. Incluir jerga local y referencias que solo locales conocen

FORMATO de respuesta JSON:
[
  {
    "question": "\xBFEn qu\xE9 esquina del Mercado X est\xE1 el taller de Y?",
    "category": "business|location|route|cultural",
    "difficulty": "easy|medium|hard",
    "expectedAnswerType": "specific_place|local_term|route_detail"
  }
]

EJEMPLOS del estilo deseado:
- "\xBFD\xF3nde cargan gas los de la Ruta 15 cuando est\xE1n por el centro?"
- "\xBFC\xF3mo le dicen al sem\xE1foro donde siempre se paran los operativos?"
- "\xBFCu\xE1l es el taller m\xE1s barato para cambiar balatas en tu zona?"
`}parseLLMResponse(e,t){return e.map((n,s)=>({id:`${t}_llm_${Date.now()}_${s}`,question:n.question,category:n.category||"business",difficulty:n.difficulty||"medium",zone:`${t}_general`,expectedAnswerType:n.expectedAnswerType||"specific_place"}))}needsRefresh(e){return(Date.now()-e.getTime())/864e5>=this.REFRESH_INTERVAL_DAYS}getPreviousQuestions(e){let t=this.questionPools.get(e);return t?t.questions.map(n=>n.question):[]}generateVersion(){return`${new Date().getFullYear()}.${new Date().getMonth()+1}.${Date.now()}`}shuffleArray(e){let t=[...e];for(let n=t.length-1;n>0;n--){let s=Math.floor(Math.random()*(n+1));[t[n],t[s]]=[t[s],t[n]]}return t}saveQuestionPoolToStorage(e,t){try{localStorage.setItem(`avi_questions_${e}`,JSON.stringify(t))}catch(n){console.error("Error saving question pool to storage:",n)}}loadQuestionPoolFromStorage(e){try{let t=localStorage.getItem(`avi_questions_${e}`);return t?JSON.parse(t):null}catch(t){return console.error("Error loading question pool from storage:",t),null}}initializeFromStorage(){["aguascalientes","edomex"].forEach(e=>{let t=this.loadQuestionPoolFromStorage(e);t&&this.questionPools.set(e,D(M({},t),{lastUpdated:new Date(t.lastUpdated)}))})}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Ge=(()=>{class i{constructor(){this.sessionData=new Map}initializeSession(e){this.sessionData.set(e,[])}addVoiceResponse(e,t){this.sessionData.has(e)||this.initializeSession(e),this.sessionData.get(e).push(t)}analyzeFraudPatterns(e){let t=this.sessionData.get(e)||[];if(t.length===0)return this.createEmptyAnalysis(e);let n=this.calculateStressLevel(t),s=this.calculateHesitationRate(t),l=this.calculateConsistencyScore(t),d=this.calculateConfidenceLevel(t),g=this.calculateSpeechRate(t),S=this.analyzePausePatterns(t),T=this.generateRedFlags(t,{stressLevel:n,hesitationRate:s,consistencyScore:l,confidenceLevel:d,speechRate:g,pauseAnalysis:S}),A=this.calculateOverallFraudScore({stressLevel:n,hesitationRate:s,consistencyScore:l,confidenceLevel:d,speechRate:g,pauseAnalysis:S});return{sessionId:e,overallFraudScore:A,patterns:{stressLevel:n,hesitationRate:s,consistencyScore:l,confidenceLevel:d,speechRate:g,pauseAnalysis:S},redFlags:T,recommendations:this.generateRecommendations(A,T)}}calculateStressLevel(e){let t=0,n=0;return e.forEach(s=>{let l=s.transcript.toLowerCase(),g=["no s\xE9","este","eh","mm","pues","o sea"].reduce((A,ie)=>A+(l.match(new RegExp(ie,"g"))||[]).length,0),S=l.split(" ").length,T=S>0?g/S:0;t+=Math.min(T*3,1),s.responseTime<1?t+=.3:s.responseTime>8&&(t+=.4),n++}),n>0?Math.min(t/n,1):0}calculateHesitationRate(e){let t=0,n=e.length;return e.forEach(s=>{let l=s.transcript.toLowerCase(),g=["eh","este","mm","pues","bueno","a ver"].reduce((T,A)=>T+(l.match(new RegExp(`\\b${A}\\b`,"g"))||[]).length,0),S=s.responseTime>5?1:0;t+=Math.min(g/10+S*.5,1)}),n>0?t/n:0}calculateConsistencyScore(e){if(e.length<2)return 1;let t=1,n=e.map(T=>T.responseTime),s=n.reduce((T,A)=>T+A,0)/n.length;n.reduce((T,A)=>T+Math.pow(A-s,2),0)/n.length>10&&(t-=.3);let d=e.map(T=>{let A=T.transcript.split(" ").length;return T.duration>0?A/T.duration*60:0}),g=d.reduce((T,A)=>T+A,0)/d.length;return d.reduce((T,A)=>T+Math.pow(A-g,2),0)/d.length>2500&&(t-=.2),Math.max(t,0)}calculateConfidenceLevel(e){let t=0;return e.forEach(n=>{let s=n.transcript.toLowerCase(),l=.7,d=["s\xED","claro","exacto","siempre","seguro","por supuesto"],g=["creo que","no estoy seguro","tal vez","posiblemente","no s\xE9"],S=d.reduce((ie,re)=>ie+(s.includes(re)?1:0),0),T=g.reduce((ie,re)=>ie+(s.includes(re)?1:0),0);l+=S*.1-T*.15;let A=s.split(" ").length;A>15&&(l+=.1),A<5&&(l-=.2),t+=Math.min(Math.max(l,0),1)}),e.length>0?t/e.length:0}calculateSpeechRate(e){let t=0,n=0;return e.forEach(s=>{if(s.duration>0){let d=s.transcript.split(" ").length/s.duration*60;t+=d,n++}}),n>0?t/n:0}analyzePausePatterns(e){let t=0,n=0,s=0,l=0;return e.forEach(d=>{let g=d.transcript.toLowerCase();l+=["eh","mm","este","pues"].reduce((T,A)=>T+(g.match(new RegExp(`\\b${A}\\b`,"g"))||[]).length,0),d.responseTime>3&&(t++,n+=d.responseTime,d.responseTime>8&&s++)}),{averagePauseLength:t>0?n/t:0,unusualPauses:s,fillerWords:l,totalPauses:t}}generateRedFlags(e,t){let n=[],s=Date.now();return t.stressLevel>.7&&n.push({type:"STRESS_DETECTED",severity:t.stressLevel>.85?"HIGH":"MEDIUM",description:`Alto nivel de estr\xE9s detectado (${(t.stressLevel*100).toFixed(1)}%)`,timestamp:s}),t.hesitationRate>.6&&n.push({type:"LONG_HESITATION",severity:t.hesitationRate>.8?"HIGH":"MEDIUM",description:`Excesiva vacilaci\xF3n en respuestas (${(t.hesitationRate*100).toFixed(1)}%)`,timestamp:s}),t.consistencyScore<.4&&n.push({type:"INCONSISTENT_RESPONSE",severity:t.consistencyScore<.2?"HIGH":"MEDIUM",description:`Patrones inconsistentes de respuesta (${(t.consistencyScore*100).toFixed(1)}%)`,timestamp:s}),t.confidenceLevel<.3&&n.push({type:"LOW_CONFIDENCE",severity:t.confidenceLevel<.15?"HIGH":"MEDIUM",description:`Bajo nivel de confianza en respuestas (${(t.confidenceLevel*100).toFixed(1)}%)`,timestamp:s}),e.reduce((d,g)=>d+g.responseTime,0)/e.length<1.5&&t.consistencyScore>.9&&n.push({type:"REHEARSED_SPEECH",severity:"HIGH",description:"Posibles respuestas ensayadas (muy r\xE1pidas y consistentes)",timestamp:s}),n}calculateOverallFraudScore(e){let t={stressLevel:.25,hesitationRate:.2,consistencyScore:.25,confidenceLevel:.15,unusualPauses:.15},n=0;n+=e.stressLevel*t.stressLevel*100,n+=e.hesitationRate*t.hesitationRate*100,n+=(1-e.consistencyScore)*t.consistencyScore*100,n+=(1-e.confidenceLevel)*t.confidenceLevel*100;let s=Math.min(e.pauseAnalysis.unusualPauses/10,1);return n+=s*t.unusualPauses*100,Math.min(Math.round(n),100)}generateRecommendations(e,t){let n=[];return e>70?(n.push("ALTO RIESGO: Requiere revisi\xF3n manual inmediata"),n.push("Considerar entrevista presencial adicional")):e>50?(n.push("RIESGO MEDIO: Verificaci\xF3n adicional recomendada"),n.push("Revisar documentos con mayor detalle")):e>30?n.push("RIESGO BAJO: Proceder con precauci\xF3n est\xE1ndar"):n.push("RIESGO M\xCDNIMO: Proceder con proceso normal"),t.forEach(s=>{switch(s.type){case"STRESS_DETECTED":n.push("Considerar re-hacer entrevista en ambiente m\xE1s c\xF3modo");break;case"REHEARSED_SPEECH":n.push("Hacer preguntas adicionales no preparadas");break;case"INCONSISTENT_RESPONSE":n.push("Validar informaci\xF3n con fuentes adicionales");break}}),[...new Set(n)]}createEmptyAnalysis(e){return{sessionId:e,overallFraudScore:0,patterns:{stressLevel:0,hesitationRate:0,consistencyScore:1,confidenceLevel:1,speechRate:0,pauseAnalysis:{averagePauseLength:0,unusualPauses:0,fillerWords:0,totalPauses:0}},redFlags:[],recommendations:["Sin datos suficientes para an\xE1lisis"]}}clearSession(e){this.sessionData.delete(e)}getSessionMetrics(e){return this.sessionData.get(e)||[]}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var ct=["micButton"];function lt(i,u){i&1&&(o(0,"span",31),r(1,"\u{1F534}"),a())}function dt(i,u){i&1&&(o(0,"p"),r(1," Preparando verificaci\xF3n... "),a())}function pt(i,u){if(i&1&&(o(0,"p")(1,"strong"),r(2),a(),k(3,"br"),r(4),a()),i&2){let e,t=m();c(2),W("Pregunta ",t.sessionData.currentQuestionIndex+1," de ",t.sessionData.transportQuestions.length,":"),c(2),b(" ",(e=t.getCurrentTransportQuestion())==null?null:e.text," ")}}function mt(i,u){if(i&1&&(o(0,"p")(1,"strong"),r(2,"Pregunta de verificaci\xF3n local:"),a(),k(3,"br"),r(4),a()),i&2){let e=m();c(4),b(" ",e.currentQuestion.question," ")}}function ut(i,u){i&1&&(o(0,"p",32),r(1," \u2728 Verificaci\xF3n completada exitosamente "),a())}function gt(i,u){if(i&1&&(o(0,"div",33)(1,"h3"),r(2,"\u{1F4DD} Transcripci\xF3n en vivo:"),a(),o(3,"div",34),r(4),a()()),i&2){let e=m();c(4),b(" ",e.currentTranscript," ")}}function ft(i,u){if(i&1&&(o(0,"span",49),r(1),a()),i&2){let e=u.$implicit;c(),f(e)}}function ht(i,u){if(i&1&&(o(0,"div",47),h(1,ft,2,1,"span",48),a()),i&2){let e=m().$implicit;c(),p("ngForOf",e.flags)}}function vt(i,u){if(i&1&&(o(0,"div",39)(1,"div",40)(2,"span",41),r(3),a()(),o(4,"div",42)(5,"div",43),r(6),a(),o(7,"div",44),r(8),a(),o(9,"div",45),r(10),a()(),h(11,ht,2,1,"div",46),a()),i&2){let e=u.$implicit;P("result-"+e.decision.toLowerCase().replace("-","")),c(),Pe("aria-label",e.decision),c(2),f(e.icon),c(3),f(e.questionId),c(2),f(e.decision),c(2),b("Score: ",e.score.toFixed(1),"/10"),c(),p("ngIf",e.flags.length>0)}}function _t(i,u){i&1&&(o(0,"div",50),k(1,"div",51),o(2,"span",52),r(3,"Analizando respuesta de voz..."),a()())}function xt(i,u){if(i&1&&(o(0,"div",35)(1,"h3"),r(2,"\u{1F6A6} Resultados de An\xE1lisis de Voz:"),a(),o(3,"div",36),h(4,vt,12,8,"div",37),a(),h(5,_t,4,0,"div",38),a()),i&2){let e=m();c(4),p("ngForOf",e.questionResults)("ngForTrackBy",e.trackByQuestionId),c(),p("ngIf",e.isAnalyzing)}}function bt(i,u){if(i&1&&(o(0,"div",53)(1,"h3"),r(2,"\u{1F4AA} Resumen de Resiliencia:"),a(),o(3,"div",54)(4,"div",55)(5,"div",56)(6,"span",57),r(7,"Puntuaci\xF3n Global:"),a(),o(8,"span",58),r(9),a()(),o(10,"div",59),r(11),a()(),o(12,"div",60)(13,"div",61)(14,"span",62),r(15,"Estabilidad Financiera:"),a(),o(16,"span",63),r(17),a()(),o(18,"div",61)(19,"span",62),r(20,"Adaptabilidad Operacional:"),a(),o(21,"span",63),r(22),a()(),o(23,"div",61)(24,"span",62),r(25,"Conocimiento del Mercado:"),a(),o(26,"span",63),r(27),a()()()()()),i&2){let e=m();c(8),P("score-"+e.getScoreLevel(e.resilienceSummary.overallScore)),c(),b(" ",e.resilienceSummary.overallScore.toFixed(1),"/10 "),c(2),b(" ",e.getResilienceLevel(e.resilienceSummary.overallScore)," "),c(6),b("",e.resilienceSummary.categoryScores.financial_stability.toFixed(1),"/10"),c(5),b("",e.resilienceSummary.categoryScores.operational_adaptability.toFixed(1),"/10"),c(5),b("",e.resilienceSummary.categoryScores.market_knowledge.toFixed(1),"/10")}}function yt(i,u){if(i&1&&(o(0,"div",64)(1,"h3"),r(2,"\u{1F4CA} Progreso de Verificaci\xF3n:"),a(),o(3,"div",65)(4,"div",66)(5,"span",67),r(6,"Preguntas Respondidas:"),a(),o(7,"span",68),r(8),a()(),o(9,"div",66)(10,"span",67),r(11,"Preguntas Restantes:"),a(),o(12,"span",68),r(13),a()()(),o(14,"div",69),k(15,"div",70),a()()),i&2){let e=m();c(8),f(e.sessionData.responses.length),c(5),b(" ",e.sessionData.transportQuestions.length+e.sessionData.microLocalQuestions.length-e.sessionData.responses.length," "),c(2),G("width",e.getProgressPercentage(),"%")}}function Ct(i,u){if(i&1&&(o(0,"div",71)(1,"div",72)(2,"div",73),r(3,"\u2728"),a(),o(4,"h3"),r(5,"\xA1Verificaci\xF3n Completada!"),a(),o(6,"p",74),r(7," Hemos procesado exitosamente su informaci\xF3n de verificaci\xF3n. Su puntuaci\xF3n AVI ha sido calculada y est\xE1 lista para revisi\xF3n. "),a(),o(8,"div",75)(9,"span",57),r(10,"Puntuaci\xF3n AVI:"),a(),o(11,"span",58),r(12),a()()()()),i&2){let e=m();c(12),b("",e.getClientFriendlyScore(),"/100")}}function St(i,u){if(i&1){let e=I();o(0,"button",76),x("click",function(){y(e);let n=m();return C(n.completeVerification())}),r(1," Finalizar Verificaci\xF3n "),a()}}var je=(()=>{class i{constructor(e,t,n,s){this.voiceValidation=e,this.questionGenerator=t,this.aviConfigService=n,this.voiceFraudDetection=s,this.clientId="",this.municipality="aguascalientes",this.visible=!0,this.completed=new se,this.closed=new se,this.destroy$=new B,this.isRecording=!1,this.currentTranscript="",this.currentQuestion=null,this.recordingStartTime=0,this._questionResults={},this.isAnalyzing=!1,this.analysisMessage="Analizando respuesta...",this.showFinalSummary=!1,this.finalSummary=null,this.sessionData={clientId:"",municipality:"aguascalientes",transportQuestions:[],microLocalQuestions:[],currentQuestionIndex:0,responses:[],overallRiskScore:0,status:"initializing"}}ngOnInit(){this.initializeAviSession()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete(),this.isRecording&&this.stopRecording()}initializeAviSession(){return Z(this,null,function*(){this.sessionData.clientId=this.clientId,this.sessionData.municipality=this.municipality,this.voiceFraudDetection.initializeSession(this.clientId);let e=this.aviConfigService.getConfig();this.sessionData.transportQuestions=this.aviConfigService.getActiveQuestions();let t=e.microLocalQuestions||2;this.questionGenerator.getRandomMicroLocalQuestions(this.municipality,t).pipe(oe(this.destroy$)).subscribe(n=>{this.sessionData.microLocalQuestions=n,this.sessionData.transportQuestions.length>0?this.sessionData.status="asking_questions":(this.sessionData.status="micro_local_questions",this.currentQuestion=this.sessionData.microLocalQuestions[0]||null)}),this.questionGenerator.refreshQuestionsFromLLM(this.municipality).then(n=>{n&&console.log(`Micro-local questions refreshed for ${this.municipality}`)})})}toggleRecording(){this.isRecording?this.stopRecording():this.startRecording()}startRecording(){this.isRecording=!0,this.currentTranscript="",this.recordingStartTime=Date.now(),this.voiceValidation.startRecording()}stopRecording(){return Z(this,null,function*(){this.isRecording=!1;try{this.voiceValidation.stopRecording();let e=yield this.voiceValidation.getValidationResult(this.sessionData.clientId);if(!e)return;this.isAnalyzing=!0,this.analysisMessage="Analizando respuesta...";let t=this.getCurrentQuestionId();if(t&&e.audioBlob)try{let n=yield this.voiceValidation.evaluateAudio(e.audioBlob,t,this.sessionData.clientId,this.municipality);this.showQuestionResult(n)}catch(n){console.warn("Voice evaluation failed, continuing with transcript only:",n)}this.processVoiceResult(e)}catch(e){console.error("Stop recording error:",e)}finally{this.isAnalyzing=!1}})}processAudioStream(e){e.transcript&&(this.currentTranscript=e.transcript)}processVoiceResult(e){this.sessionData.status==="asking_questions"?this.processTransportQuestionResponse(e):this.sessionData.status==="micro_local_questions"&&this.processMicroLocalResponse(e)}processTransportQuestionResponse(e){let t=this.getCurrentTransportQuestion();if(!t)return;let n=(Date.now()-this.recordingStartTime)/1e3,s=e.duration||n,l={transcript:e.transcript,audioBlob:e.audioBlob,duration:s,questionId:t.id,responseTime:n};this.voiceFraudDetection.addVoiceResponse(this.sessionData.clientId,l);let d={questionId:t.id,response:e.transcript,score:e.compliance_score||this.scoreTransportResponse(t,e.transcript)};this.sessionData.responses.push(d),this.sessionData.currentQuestionIndex<this.sessionData.transportQuestions.length-1?this.sessionData.currentQuestionIndex++:this.proceedToMicroLocalQuestions()}scoreTransportResponse(e,t){let n=t.toLowerCase();switch(e.category){case"personal":return n.length>10?80:50;case"operation":return/\d+/.test(n)?85:60;case"business":return["due\xF1o","propio","administra","manejo"].some(X=>n.includes(X))?90:70;case"vehicle":return["nissan","ford","chevrolet","gnv","glp","gasolina"].some(X=>n.includes(X))?85:65;case"resilience":let T=["cambio","adapto","busco","alternativa","estrategia","siempre","tengo","planifico"],A=["no puedo","imposible","no hago nada","me afecta mucho","no tengo"],ie=["preveo","anticipo","preparo","diversifico","multiple"],re=T.some(X=>n.includes(X)),be=A.some(X=>n.includes(X));return ie.some(X=>n.includes(X))?95:re&&!be?85:be?30:60;default:return 70}}proceedToMicroLocalQuestions(){this.sessionData.status="micro_local_questions",this.currentQuestion=this.sessionData.microLocalQuestions[0]||null}processMicroLocalResponse(e){if(!this.currentQuestion)return;let t=(Date.now()-this.recordingStartTime)/1e3,n=e.duration||t,s={transcript:e.transcript,audioBlob:e.audioBlob,duration:n,questionId:this.currentQuestion.id,responseTime:t};this.voiceFraudDetection.addVoiceResponse(this.sessionData.clientId,s);let l={questionId:this.currentQuestion.id,response:e.transcript,score:e.compliance_score||0};this.sessionData.responses.push(l);let d=this.sessionData.microLocalQuestions.findIndex(g=>g.id===this.currentQuestion.id);d<this.sessionData.microLocalQuestions.length-1?this.currentQuestion=this.sessionData.microLocalQuestions[d+1]:this.completeAviSession()}completeAviSession(){this.sessionData.fraudAnalysis=this.voiceFraudDetection.analyzeFraudPatterns(this.sessionData.clientId);let e={};this.sessionData.responses.forEach(n=>{e[n.questionId]=n.response});let t=this.aviConfigService.calculateAviScore(e,this.sessionData.fraudAnalysis);this.sessionData.overallRiskScore=Math.max(0,100-t),this.sessionData.status="completed",this.currentQuestion=null,this.showFinalResilienceSummary()}completeVerification(){let e={};this.sessionData.responses.forEach(n=>{e[n.questionId]=n.response});let t=this.aviConfigService.calculateHaseScore(e,this.sessionData.fraudAnalysis);this.voiceFraudDetection.clearSession(this.sessionData.clientId),this.completed.emit({clientId:this.sessionData.clientId,transportResponses:this.sessionData.responses,microLocalResponses:this.sessionData.responses.filter(n=>this.sessionData.microLocalQuestions.some(s=>s.id===n.questionId)),aviScore:t.avi_score,haseScore:t,riskScore:this.sessionData.overallRiskScore,fraudAnalysis:this.sessionData.fraudAnalysis,status:"completed"})}getCurrentTransportQuestion(){return this.sessionData.currentQuestionIndex<this.sessionData.transportQuestions.length?this.sessionData.transportQuestions[this.sessionData.currentQuestionIndex]:null}closeModal(){this.isRecording&&this.stopRecording(),this.closed.emit()}onOverlayClick(e){e.target===e.currentTarget&&this.closeModal()}getEntityLabel(e){return{nombre:"Nombre",rfc:"RFC",direccion:"Direcci\xF3n",telefono:"Tel\xE9fono"}[e]||e}isStepCompleted(e){let t=["asking_questions","micro_local_questions","completed"],n=t.indexOf(this.sessionData.status),s=t.indexOf(e);return n>s}getProgressPercentage(){let e=this.sessionData.transportQuestions.length+this.sessionData.microLocalQuestions.length,t=this.sessionData.responses.length;return e>0?t/e*100:0}getFraudScoreClass(){if(!this.sessionData.fraudAnalysis)return"fraud-score-low";let e=this.sessionData.fraudAnalysis.overallFraudScore;return e>70?"fraud-score-high":e>50?"fraud-score-medium":e>30?"fraud-score-low":"fraud-score-minimal"}getClientFriendlyScore(){if(!this.sessionData.fraudAnalysis)return 0;let e={};this.sessionData.responses.forEach(n=>{e[n.questionId]=n.response});let t=this.aviConfigService.calculateAviScore(e);return Math.round(t/this.aviConfigService.getConfig().haseContribution*100)}getCurrentQuestionId(){return this.sessionData.status==="asking_questions"?this.getCurrentTransportQuestion()?.id||null:this.sessionData.status==="micro_local_questions"&&this.currentQuestion?this.currentQuestion.id:null}showQuestionResult(e){console.log(`\u{1F3AF} Showing result for question: ${e.questionId}`,e),this._questionResults[e.questionId]={questionId:e.questionId,decision:e.decision,icon:this.getDecisionIcon(e.decision),message:this.getDecisionMessage(e),flags:e.flags||[],score:e.voiceScore,timestamp:Date.now()}}getDecisionIcon(e){switch(e){case"GO":return"\u2705";case"REVIEW":return"\u26A0\uFE0F";case"NO-GO":return"\u274C";default:return"\u{1F50D}"}}getDecisionMessage(e){if(e.fallback)return e.message||"An\xE1lisis b\xE1sico aplicado";switch(e.decision){case"GO":return"Respuesta clara y confiable";case"REVIEW":return"Requiere revisi\xF3n manual";case"NO-GO":return"Respuesta evasiva detectada";default:return"Procesando..."}}getQuestionNumber(e){let n=[...this.sessionData.transportQuestions,...this.sessionData.microLocalQuestions].findIndex(s=>s.id===e);return n>=0?n+1:0}showFinalResilienceSummary(){try{this.finalSummary=this.voiceValidation.aggregateResilience(),this.showFinalSummary=!0,console.log("\u{1F4CA} Final resilience summary:",this.finalSummary)}catch(e){console.error("Failed to generate resilience summary:",e),this.showFinalSummary=!1}}getFinalScoreClass(){if(!this.finalSummary)return"";let e=this.finalSummary.voiceResilienceScore;return e>=.75?"score-excellent":e>=.6?"score-good":e>=.4?"score-fair":"score-poor"}trackByQuestionId(e,t){return t.questionId}get questionResults(){return Object.values(this._questionResults)}get resilienceSummary(){return this.finalSummary}getScoreLevel(e){return e>=7.5?"high":e>=5?"medium":"low"}getResilienceLevel(e){return e>=8.5?"Excelente":e>=7?"Muy Buena":e>=5.5?"Buena":e>=4?"Regular":"Necesita Mejora"}static{this.\u0275fac=function(t){return new(t||i)(ae($e),ae(Be),ae(ze),ae(Ge))}}static{this.\u0275cmp=$({type:i,selectors:[["app-avi-verification-modal"]],viewQuery:function(t,n){if(t&1&&Ee(ct,5),t&2){let s;Me(s=we())&&(n.micButtonRef=s.first)}},inputs:{clientId:"clientId",municipality:"municipality",visible:"visible"},outputs:{completed:"completed",closed:"closed"},standalone:!0,features:[z],decls:52,vars:30,consts:[["micButton",""],[1,"avi-modal-overlay",3,"click"],[1,"avi-modal-container",3,"click"],[1,"avi-header"],[1,"avi-title"],[1,"avi-icon"],[1,"avi-close-btn",3,"click"],[1,"avi-content"],[1,"recording-status"],[1,"recording-indicator"],["class","recording-dot",4,"ngIf"],[1,"recording-text"],[1,"mic-section"],[1,"mic-button",3,"click","disabled"],[1,"mic-icon"],[1,"mic-instructions"],[4,"ngIf"],["class","success-message",4,"ngIf"],["class","transcription-section",4,"ngIf"],["class","voice-evaluation-section",4,"ngIf"],["class","resilience-summary-section",4,"ngIf"],["class","progress-info-section",4,"ngIf"],["class","completion-section",4,"ngIf"],[1,"progress-section"],[1,"progress-steps"],[1,"progress-step"],[1,"step-number"],[1,"step-label"],[1,"avi-footer"],[1,"btn-secondary",3,"click","disabled"],["class","btn-primary",3,"click",4,"ngIf"],[1,"recording-dot"],[1,"success-message"],[1,"transcription-section"],[1,"transcript-box"],[1,"voice-evaluation-section"],[1,"question-results-grid"],["class","question-result-card",3,"class",4,"ngFor","ngForOf","ngForTrackBy"],["class","analysis-loading",4,"ngIf"],[1,"question-result-card"],[1,"semaforo-indicator"],[1,"decision-icon"],[1,"question-info"],[1,"question-id"],[1,"decision-status"],[1,"confidence-score"],["class","analysis-flags",4,"ngIf"],[1,"analysis-flags"],["class","flag-item",4,"ngFor","ngForOf"],[1,"flag-item"],[1,"analysis-loading"],[1,"loading-spinner"],[1,"loading-text"],[1,"resilience-summary-section"],[1,"resilience-overview"],[1,"resilience-score-display"],[1,"overall-score"],[1,"score-label"],[1,"score-value"],[1,"resilience-level"],[1,"category-breakdown"],[1,"category-item"],[1,"category-label"],[1,"category-score"],[1,"progress-info-section"],[1,"progress-details"],[1,"progress-item"],[1,"progress-label"],[1,"progress-value"],[1,"progress-bar-container"],[1,"progress-bar-fill"],[1,"completion-section"],[1,"completion-message"],[1,"success-icon"],[1,"completion-text"],[1,"score-display"],[1,"btn-primary",3,"click"]],template:function(t,n){if(t&1){let s=I();o(0,"div",1),x("click",function(d){return y(s),C(n.onOverlayClick(d))}),o(1,"div",2),x("click",function(d){return y(s),C(d.stopPropagation())}),o(2,"div",3)(3,"div",4)(4,"span",5),r(5,"\u{1F3A4}"),a(),o(6,"h2"),r(7,"Verificaci\xF3n Inteligente AVI"),a()(),o(8,"button",6),x("click",function(){return y(s),C(n.closeModal())}),r(9,"\u2715"),a()(),o(10,"div",7)(11,"div",8)(12,"div",9),h(13,lt,2,0,"span",10),o(14,"span",11),r(15),a()()(),o(16,"div",12)(17,"button",13,0),x("click",function(){return y(s),C(n.toggleRecording())}),o(19,"span",14),r(20,"\u{1F3A4}"),a()(),o(21,"div",15),h(22,dt,2,0,"p",16)(23,pt,5,3,"p",16)(24,mt,5,1,"p",16)(25,ut,2,0,"p",17),a()(),h(26,gt,5,1,"div",18)(27,xt,6,3,"div",19)(28,bt,28,7,"div",20)(29,yt,16,4,"div",21)(30,Ct,13,1,"div",22),o(31,"div",23)(32,"div",24)(33,"div",25)(34,"span",26),r(35,"1"),a(),o(36,"span",27),r(37,"Preguntas de Transporte"),a()(),o(38,"div",25)(39,"span",26),r(40,"2"),a(),o(41,"span",27),r(42,"Verificaci\xF3n Local"),a()(),o(43,"div",25)(44,"span",26),r(45,"3"),a(),o(46,"span",27),r(47,"Completado"),a()()()()(),o(48,"div",28)(49,"button",29),x("click",function(){return y(s),C(n.closeModal())}),r(50," Cancelar "),a(),h(51,St,2,0,"button",30),a()()()}t&2&&(c(11),H("recording-active",n.isRecording),c(2),p("ngIf",n.isRecording),c(2),b(" ",n.isRecording?"GRABANDO...":n.sessionData.status==="completed"?"VERIFICACI\xD3N COMPLETADA":"LISTO PARA GRABAR"," "),c(2),H("mic-recording",n.isRecording),p("disabled",n.sessionData.status==="completed"),c(5),p("ngIf",n.sessionData.status==="initializing"),c(),p("ngIf",n.sessionData.status==="asking_questions"&&n.getCurrentTransportQuestion()),c(),p("ngIf",n.sessionData.status==="micro_local_questions"&&n.currentQuestion),c(),p("ngIf",n.sessionData.status==="completed"),c(),p("ngIf",n.currentTranscript),c(),p("ngIf",n.questionResults.length>0),c(),p("ngIf",n.resilienceSummary&&n.sessionData.status==="completed"),c(),p("ngIf",n.sessionData.responses.length>0),c(),p("ngIf",n.sessionData.status==="completed"),c(3),H("step-active",n.sessionData.status==="asking_questions")("step-completed",n.isStepCompleted("asking_questions")),c(5),H("step-active",n.sessionData.status==="micro_local_questions")("step-completed",n.isStepCompleted("micro_local_questions")),c(5),H("step-active",n.sessionData.status==="completed")("step-completed",n.sessionData.status==="completed"),c(6),p("disabled",n.isRecording),c(2),p("ngIf",n.sessionData.status==="completed"))},dependencies:[U,Y,q],styles:['@charset "UTF-8";.avi-modal-overlay[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#000c;display:flex;align-items:center;justify-content:center;z-index:1000;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.avi-modal-container[_ngcontent-%COMP%]{width:90%;max-width:800px;height:90%;max-height:900px;background:#fff;border-radius:16px;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 40px #0000004d}.avi-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:24px 32px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff}.avi-title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px}.avi-icon[_ngcontent-%COMP%]{font-size:24px}.avi-title[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:24px;font-weight:600}.avi-close-btn[_ngcontent-%COMP%]{background:#fff3;border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:18px;display:flex;align-items:center;justify-content:center;transition:background .2s}.avi-close-btn[_ngcontent-%COMP%]:hover{background:#ffffff4d}.avi-content[_ngcontent-%COMP%]{flex:1;padding:32px;display:flex;flex-direction:column;gap:24px;overflow-y:auto}.recording-status[_ngcontent-%COMP%]{text-align:center;padding:16px;border-radius:12px;background:#f8fafc;transition:all .3s}.recording-status.recording-active[_ngcontent-%COMP%]{background:#fef2f2;border:2px solid #fecaca}.recording-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:8px}.recording-dot[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_pulse 1s infinite}@keyframes _ngcontent-%COMP%_pulse{0%,to{opacity:1}50%{opacity:.5}}.recording-text[_ngcontent-%COMP%]{font-weight:600;font-size:16px}.mic-section[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:24px;padding:32px 0}.mic-button[_ngcontent-%COMP%]{width:120px;height:120px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s;box-shadow:0 8px 24px #667eea4d}.mic-button[_ngcontent-%COMP%]:hover:not(:disabled){transform:scale(1.05);box-shadow:0 12px 32px #667eea66}.mic-button.mic-recording[_ngcontent-%COMP%]{background:linear-gradient(135deg,#ef4444,#dc2626);animation:_ngcontent-%COMP%_recordingPulse 1.5s infinite}@keyframes _ngcontent-%COMP%_recordingPulse{0%,to{transform:scale(1)}50%{transform:scale(1.1)}}.mic-button[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.mic-icon[_ngcontent-%COMP%]{font-size:48px;color:#fff}.mic-instructions[_ngcontent-%COMP%]{text-align:center;max-width:500px}.mic-instructions[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:16px;color:#6b7280;line-height:1.5}.success-message[_ngcontent-%COMP%]{color:#059669!important;font-weight:600!important}.transcription-section[_ngcontent-%COMP%]{background:#f8fafc;padding:20px;border-radius:12px;border-left:4px solid #667eea}.transcription-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 12px;color:#374151;font-size:16px;font-weight:600}.transcript-box[_ngcontent-%COMP%]{background:#fff;padding:16px;border-radius:8px;border:1px solid #e5e7eb;font-family:monospace;color:#1f2937;line-height:1.4;min-height:60px}.progress-info-section[_ngcontent-%COMP%]{background:#f0fdf4;padding:20px;border-radius:12px;border-left:4px solid #10b981}.progress-info-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;color:#374151;font-size:16px;font-weight:600}.progress-details[_ngcontent-%COMP%]{display:flex;justify-content:space-between;margin-bottom:16px}.progress-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.progress-label[_ngcontent-%COMP%]{font-size:12px;color:#6b7280;font-weight:600;text-transform:uppercase}.progress-value[_ngcontent-%COMP%]{font-size:18px;font-weight:700;color:#059669}.progress-bar-container[_ngcontent-%COMP%]{width:100%;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden}.progress-bar-fill[_ngcontent-%COMP%]{height:100%;background:linear-gradient(90deg,#10b981,#059669);transition:width .3s ease;border-radius:4px}.completion-section[_ngcontent-%COMP%]{margin-top:20px;padding:24px;background:linear-gradient(135deg,#f0f9ff,#e0f2fe);border-radius:16px;border:1px solid #bae6fd;text-align:center}.completion-message[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:16px}.success-icon[_ngcontent-%COMP%]{font-size:48px;line-height:1}.completion-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:#0c4a6e;font-size:24px;font-weight:700}.completion-text[_ngcontent-%COMP%]{margin:0;color:#075985;font-size:16px;line-height:1.6;max-width:400px}.score-display[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:16px 24px;background:#fffc;border-radius:12px;border:1px solid #bae6fd}.score-label[_ngcontent-%COMP%]{font-size:16px;color:#075985;font-weight:600}.score-value[_ngcontent-%COMP%]{font-size:28px;color:#0c4a6e;font-weight:700}.progress-section[_ngcontent-%COMP%]{margin-top:auto;padding-top:24px;border-top:1px solid #e5e7eb}.progress-steps[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;position:relative}.progress-steps[_ngcontent-%COMP%]:before{content:"";position:absolute;top:16px;left:32px;right:32px;height:2px;background:#e5e7eb;z-index:0}.progress-step[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:8px;position:relative;z-index:1}.step-number[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:50%;background:#e5e7eb;color:#6b7280;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px}.progress-step.step-active[_ngcontent-%COMP%]   .step-number[_ngcontent-%COMP%]{background:#667eea;color:#fff}.progress-step.step-completed[_ngcontent-%COMP%]   .step-number[_ngcontent-%COMP%]{background:#10b981;color:#fff}.step-label[_ngcontent-%COMP%]{font-size:12px;color:#6b7280;text-align:center;font-weight:500}.progress-step.step-active[_ngcontent-%COMP%]   .step-label[_ngcontent-%COMP%]{color:#667eea;font-weight:600}.progress-step.step-completed[_ngcontent-%COMP%]   .step-label[_ngcontent-%COMP%]{color:#10b981;font-weight:600}.avi-footer[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:24px 32px;background:#f8fafc;border-top:1px solid #e5e7eb}.btn-primary[_ngcontent-%COMP%], .btn-secondary[_ngcontent-%COMP%]{padding:12px 24px;border-radius:8px;font-weight:600;cursor:pointer;transition:all .2s;font-size:14px}.btn-primary[_ngcontent-%COMP%]{background:#667eea;color:#fff;border:none}.btn-primary[_ngcontent-%COMP%]:hover:not(:disabled){background:#5a67d8}.btn-secondary[_ngcontent-%COMP%]{background:#fff;color:#374151;border:1px solid #d1d5db}.btn-secondary[_ngcontent-%COMP%]:hover:not(:disabled){background:#f9fafb}.btn-primary[_ngcontent-%COMP%]:disabled, .btn-secondary[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}@media (max-width: 768px){.avi-modal-container[_ngcontent-%COMP%]{width:95%;height:95%}.avi-header[_ngcontent-%COMP%]{padding:16px 20px}.avi-title[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{font-size:20px}.avi-content[_ngcontent-%COMP%]{padding:20px;gap:20px}.mic-button[_ngcontent-%COMP%]{width:100px;height:100px}.mic-icon[_ngcontent-%COMP%]{font-size:40px}.avi-footer[_ngcontent-%COMP%]{padding:16px 20px}.progress-steps[_ngcontent-%COMP%]{flex-direction:column;gap:16px}.progress-steps[_ngcontent-%COMP%]:before{display:none}.voice-evaluation-section[_ngcontent-%COMP%]{gap:16px}.question-results-grid[_ngcontent-%COMP%]{grid-template-columns:1fr;gap:12px}.question-result-card[_ngcontent-%COMP%]{padding:16px}.resilience-overview[_ngcontent-%COMP%]{flex-direction:column;gap:20px}.category-breakdown[_ngcontent-%COMP%]{gap:12px}}.voice-evaluation-section[_ngcontent-%COMP%]{background:#f8fafc;padding:24px;border-radius:12px;border:1px solid #e2e8f0;display:flex;flex-direction:column;gap:20px}.voice-evaluation-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;color:#1f2937;font-size:18px;font-weight:600}.question-results-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px}.question-result-card[_ngcontent-%COMP%]{background:#fff;padding:20px;border-radius:12px;border:2px solid transparent;display:flex;align-items:center;gap:16px;transition:all .2s;box-shadow:0 2px 4px #0000000d}.question-result-card.result-go[_ngcontent-%COMP%]{border-color:#10b981;background:linear-gradient(135deg,#ecfdf5,#f0fdf4)}.question-result-card.result-nogo[_ngcontent-%COMP%]{border-color:#ef4444;background:linear-gradient(135deg,#fef2f2,#fef7f7)}.question-result-card.result-review[_ngcontent-%COMP%]{border-color:#f59e0b;background:linear-gradient(135deg,#fffbeb,#fefce8)}.semaforo-indicator[_ngcontent-%COMP%]{flex-shrink:0;width:48px;height:48px;display:flex;align-items:center;justify-content:center;border-radius:50%;background:#fff;box-shadow:0 2px 8px #0000001a}.decision-icon[_ngcontent-%COMP%]{font-size:24px;line-height:1}.question-info[_ngcontent-%COMP%]{flex:1;display:flex;flex-direction:column;gap:4px}.question-id[_ngcontent-%COMP%]{font-size:14px;font-weight:500;color:#6b7280;text-transform:uppercase;letter-spacing:.5px}.decision-status[_ngcontent-%COMP%]{font-size:16px;font-weight:600;color:#1f2937}.confidence-score[_ngcontent-%COMP%]{font-size:14px;color:#6b7280}.analysis-flags[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}.flag-item[_ngcontent-%COMP%]{background:#6b72801a;color:#6b7280;padding:4px 8px;border-radius:6px;font-size:12px;font-weight:500}.analysis-loading[_ngcontent-%COMP%]{display:flex;align-items:center;justify-content:center;gap:12px;padding:20px;color:#6b7280}.loading-spinner[_ngcontent-%COMP%]{width:20px;height:20px;border:2px solid #e5e7eb;border-top:2px solid #3b82f6;border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite}.loading-text[_ngcontent-%COMP%]{font-size:14px;font-weight:500}@keyframes _ngcontent-%COMP%_spin{0%{transform:rotate(0)}to{transform:rotate(360deg)}}.resilience-summary-section[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f3e8ff,#faf5ff);padding:24px;border-radius:12px;border:1px solid #e9d5ff}.resilience-summary-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 20px;color:#581c87;font-size:18px;font-weight:600}.resilience-overview[_ngcontent-%COMP%]{display:flex;gap:24px;align-items:flex-start}.resilience-score-display[_ngcontent-%COMP%]{background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px #00000014;text-align:center;min-width:200px}.overall-score[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px;margin-bottom:12px}.score-label[_ngcontent-%COMP%]{font-size:14px;color:#6b7280;font-weight:500}.score-value[_ngcontent-%COMP%]{font-size:32px;font-weight:700;line-height:1}.score-value.score-high[_ngcontent-%COMP%]{color:#10b981}.score-value.score-medium[_ngcontent-%COMP%]{color:#f59e0b}.score-value.score-low[_ngcontent-%COMP%]{color:#ef4444}.resilience-level[_ngcontent-%COMP%]{font-size:14px;font-weight:600;color:#581c87;text-transform:uppercase;letter-spacing:.5px}.category-breakdown[_ngcontent-%COMP%]{flex:1;background:#fff;padding:20px;border-radius:12px;box-shadow:0 2px 8px #00000014;display:flex;flex-direction:column;gap:16px}.category-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f3f4f6}.category-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.category-label[_ngcontent-%COMP%]{font-size:14px;color:#374151;font-weight:500}.category-score[_ngcontent-%COMP%]{font-size:16px;font-weight:600;color:#1f2937}']})}}return i})();function Pt(i,u){if(i&1&&(o(0,"span",18),r(1),a()),i&2){let e=m(2);P(e.getLabelColorClass()),c(),b(" ",e.label," ")}}function Et(i,u){if(i&1&&(o(0,"span",19),r(1),a()),i&2){let e=m(2);P(e.getPercentageColorClass()),c(),b(" ",e.getPercentage(),"% ")}}function Mt(i,u){if(i&1&&(o(0,"span",20),r(1),a()),i&2){let e=m(2);c(),W(" ",e.formatValue(e.progress)," / ",e.formatValue(e.goal)," ")}}function wt(i,u){if(i&1&&(o(0,"div",12)(1,"div",13),h(2,Pt,2,3,"span",14),o(3,"div",15),h(4,Et,2,3,"span",16)(5,Mt,2,2,"span",17),a()()()),i&2){let e=m();c(2),p("ngIf",e.label),c(2),p("ngIf",e.showPercentage),c(),p("ngIf",e.showValues&&e.currency)}}function Dt(i,u){if(i&1&&k(0,"div",21),i&2){let e=m();P(e.getShimmerClass())}}function It(i,u){if(i&1&&k(0,"div",22),i&2){let e=m();P(e.getStripesClass())}}function Ot(i,u){if(i&1&&(o(0,"div",23)(1,"div",24),r(2),a()()),i&2){let e=m();G("left",e.goal/e.max*100,"%"),c(2),b(" Meta: ",e.formatValue(e.goal)," ")}}function kt(i,u){if(i&1&&(o(0,"div",25)(1,"div",26),r(2),a()()),i&2){let e=u.$implicit,t=m();G("left",e.value/t.max*100,"%"),c(2),b(" ",e.label," ")}}function Tt(i,u){if(i&1&&k(0,"div",30),i&2){let e=u.$implicit,t=u.index,n=m(2);P(n.getSegmentClass(e,t)),G("background-color",e.color),p("title",e.label)}}function At(i,u){if(i&1&&(o(0,"div",27)(1,"div",28),h(2,Tt,1,5,"div",29),a()()),i&2){let e=m();c(2),p("ngForOf",e.segments)}}function Rt(i,u){if(i&1&&(o(0,"span",35),r(1),a()),i&2){let e=m(2);c(),b(" ",e.getRemainingMessage()," ")}}function Ft(i,u){if(i&1&&(o(0,"div",31)(1,"div",32)(2,"span",33),r(3),a(),h(4,Rt,2,1,"span",34),a()()),i&2){let e=m();c(2),P(e.getStatusMessageClass()),c(),b(" ",e.getStatusMessage()," "),c(),p("ngIf",e.showRemaining)}}function Vt(i,u){if(i&1){let e=I();o(0,"div",36)(1,"button",37),x("click",function(){y(e);let n=m();return C(n.onActionClick())}),r(2),a()()}if(i&2){let e=m();c(),P(e.getActionButtonClass()),p("disabled",e.actionDisabled),c(),b(" ",e.actionLabel," ")}}var Qe=(()=>{class i{constructor(){this.progress=0,this.goal=100,this.max=100,this.currency="MXN",this.theme="default",this.size="md",this.animated=!1,this.striped=!1,this.showPercentage=!0,this.showValues=!1,this.showMessages=!1,this.showRemaining=!1,this.goalMarker=!1,this.darkMode=!0,this.milestones=[],this.segments=[],this.actionDisabled=!1}getPercentage(){return this.max===0?0:Math.min(Math.round(this.progress/this.max*100),100)}getContainerClass(){return`progress-container size-${this.size}`}getTrackClass(){return`progress-track ${this.darkMode?"track-bg-dark":"track-bg-light"}`}getBackgroundClass(){return this.darkMode?"track-bg-dark":"track-bg-light"}getFillClass(){return`progress-fill theme-${this.theme}`}getLabelColorClass(){return this.darkMode?"label-dark":"label-light"}getPercentageColorClass(){let e=this.getPercentage();return e>=100?"percentage-success":e>=80?"percentage-primary":e>=60?this.darkMode?"percentage-dark":"percentage-light":e>=40?"percentage-warning":"percentage-danger"}getShimmerClass(){return"shimmer-effect"}getStripesClass(){return"stripes-pattern"}getSegmentClass(e,t){let n=this.progress-this.getSegmentStartValue(t);return n>=e.value?"segment segment-completed":n>0?"segment segment-active":"segment"}getSegmentStartValue(e){return this.segments.slice(0,e).reduce((t,n)=>t+n.value,0)}getStatusMessage(){let e=this.getPercentage();return e>=100?"\uFFFDObjetivo completado!":e>=80?"En buen camino":e>=60?"Progreso constante":e>=40?"Necesita atenci\uFFFDn":"Requiere acci\uFFFDn urgente"}getStatusMessageClass(){let e=this.getPercentage();return e>=100?"status-completed":e>=80||e>=60?"status-on-track":e>=40?"status-behind":"status-at-risk"}getRemainingMessage(){let e=this.goal-this.progress;return e<=0?"Meta alcanzada":`Faltan ${this.formatValue(e)}`}getActionButtonClass(){return this.getPercentage()>=100?"action-btn btn-success":"action-btn btn-primary"}formatValue(e){return this.currency==="MXN"?new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(e):e.toLocaleString()}onActionClick(){this.actionCallback&&!this.actionDisabled&&this.actionCallback()}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=$({type:i,selectors:[["app-progress-bar"]],inputs:{progress:"progress",goal:"goal",max:"max",label:"label",currency:"currency",theme:"theme",size:"size",animated:"animated",striped:"striped",showPercentage:"showPercentage",showValues:"showValues",showMessages:"showMessages",showRemaining:"showRemaining",goalMarker:"goalMarker",darkMode:"darkMode",milestones:"milestones",segments:"segments",actionLabel:"actionLabel",actionCallback:"actionCallback",actionDisabled:"actionDisabled"},standalone:!0,features:[z],decls:12,vars:18,consts:[[1,"progress-container"],["class","progress-header mb-2",4,"ngIf"],[1,"progress-track","relative","rounded-full","overflow-hidden"],[1,"track-background","absolute","inset-0"],[1,"progress-fill","h-full","rounded-full","transition-all","duration-500","ease-out","relative","overflow-hidden"],["class","shimmer-effect absolute inset-0 opacity-30",3,"class",4,"ngIf"],["class","stripes-pattern absolute inset-0",3,"class",4,"ngIf"],["class","goal-marker absolute top-0 w-0.5 h-full bg-white/80 z-10",3,"left",4,"ngIf"],["class","milestone-marker absolute top-0 w-0.5 h-full bg-gray-300 z-10",3,"left",4,"ngFor","ngForOf"],["class","progress-segments mt-2",4,"ngIf"],["class","progress-messages mt-2",4,"ngIf"],["class","progress-action mt-3",4,"ngIf"],[1,"progress-header","mb-2"],[1,"flex","justify-between","items-center"],["class","progress-label text-sm font-medium",3,"class",4,"ngIf"],[1,"progress-info","flex","items-center","gap-3"],["class","progress-percentage text-sm font-medium",3,"class",4,"ngIf"],["class","progress-values text-sm text-gray-400",4,"ngIf"],[1,"progress-label","text-sm","font-medium"],[1,"progress-percentage","text-sm","font-medium"],[1,"progress-values","text-sm","text-gray-400"],[1,"shimmer-effect","absolute","inset-0","opacity-30"],[1,"stripes-pattern","absolute","inset-0"],[1,"goal-marker","absolute","top-0","w-0.5","h-full","bg-white/80","z-10"],[1,"marker-tooltip","absolute","-top-8","left-1/2","transform","-translate-x-1/2","px-2","py-1","bg-gray-900","text-white","text-xs","rounded","whitespace-nowrap"],[1,"milestone-marker","absolute","top-0","w-0.5","h-full","bg-gray-300","z-10"],[1,"milestone-tooltip","absolute","-top-8","left-1/2","transform","-translate-x-1/2","px-2","py-1","bg-gray-700","text-white","text-xs","rounded","whitespace-nowrap","opacity-0","group-hover:opacity-100","transition-opacity"],[1,"progress-segments","mt-2"],[1,"segments-container","flex","gap-1"],["class","segment flex-1 h-1 rounded-full transition-all duration-300",3,"class","background-color","title",4,"ngFor","ngForOf"],[1,"segment","flex-1","h-1","rounded-full","transition-all","duration-300",3,"title"],[1,"progress-messages","mt-2"],[1,"flex","items-center","justify-between","text-xs"],[1,"status-message"],["class","remaining-message text-gray-500",4,"ngIf"],[1,"remaining-message","text-gray-500"],[1,"progress-action","mt-3"],[1,"action-btn","px-4","py-2","text-sm","font-medium","rounded-lg","transition-colors",3,"click","disabled"]],template:function(t,n){t&1&&(o(0,"div",0),h(1,wt,6,3,"div",1),o(2,"div",2),k(3,"div",3),o(4,"div",4),h(5,Dt,1,2,"div",5)(6,It,1,2,"div",6),a(),h(7,Ot,3,3,"div",7)(8,kt,3,3,"div",8),a(),h(9,At,3,1,"div",9)(10,Ft,5,4,"div",10)(11,Vt,3,4,"div",11),a()),t&2&&(P(n.getContainerClass()),c(),p("ngIf",n.label||n.showPercentage||n.showValues),c(),P(n.getTrackClass()),c(),P(n.getBackgroundClass()),c(),P(n.getFillClass()),G("width",n.getPercentage(),"%"),c(),p("ngIf",n.animated),c(),p("ngIf",n.striped),c(),p("ngIf",n.goalMarker&&n.goal<n.max),c(),p("ngForOf",n.milestones),c(),p("ngIf",n.segments&&n.segments.length>0),c(),p("ngIf",n.showMessages),c(),p("ngIf",n.actionLabel&&n.actionCallback))},dependencies:[U,Y,q],styles:[".progress-container[_ngcontent-%COMP%]{width:100%}.size-sm[_ngcontent-%COMP%]   .progress-track[_ngcontent-%COMP%]{height:.375rem}.size-md[_ngcontent-%COMP%]   .progress-track[_ngcontent-%COMP%]{height:.5rem}.size-lg[_ngcontent-%COMP%]   .progress-track[_ngcontent-%COMP%]{height:.75rem}.size-xl[_ngcontent-%COMP%]   .progress-track[_ngcontent-%COMP%]{height:1rem}.theme-default[_ngcontent-%COMP%]   .progress-fill[_ngcontent-%COMP%]{background:linear-gradient(90deg,#3b82f6,#1d4ed8)}.theme-success[_ngcontent-%COMP%]   .progress-fill[_ngcontent-%COMP%]{background:linear-gradient(90deg,#10b981,#059669)}.theme-warning[_ngcontent-%COMP%]   .progress-fill[_ngcontent-%COMP%]{background:linear-gradient(90deg,#f59e0b,#d97706)}.theme-danger[_ngcontent-%COMP%]   .progress-fill[_ngcontent-%COMP%]{background:linear-gradient(90deg,#ef4444,#dc2626)}.theme-info[_ngcontent-%COMP%]   .progress-fill[_ngcontent-%COMP%]{background:linear-gradient(90deg,#06b6d4,#0891b2)}.theme-gradient[_ngcontent-%COMP%]   .progress-fill[_ngcontent-%COMP%]{background:linear-gradient(90deg,#8b5cf6,#06b6d4,#10b981)}.track-bg-light[_ngcontent-%COMP%]{background-color:#f1f5f9}.track-bg-dark[_ngcontent-%COMP%]{background-color:#374151}.label-light[_ngcontent-%COMP%]{color:#374151}.label-dark[_ngcontent-%COMP%]{color:#f9fafb}.label-primary[_ngcontent-%COMP%]{color:#3b82f6}.percentage-light[_ngcontent-%COMP%]{color:#1f2937}.percentage-dark[_ngcontent-%COMP%]{color:#f3f4f6}.percentage-primary[_ngcontent-%COMP%]{color:#3b82f6}.percentage-success[_ngcontent-%COMP%]{color:#10b981}.percentage-warning[_ngcontent-%COMP%]{color:#f59e0b}.percentage-danger[_ngcontent-%COMP%]{color:#ef4444}.shimmer-effect[_ngcontent-%COMP%]{background:linear-gradient(90deg,transparent 0%,rgba(255,255,255,.4) 50%,transparent 100%);transform:translate(-100%);animation:_ngcontent-%COMP%_shimmer 2s infinite}@keyframes _ngcontent-%COMP%_shimmer{0%{transform:translate(-100%)}to{transform:translate(100%)}}.stripes-pattern[_ngcontent-%COMP%]{background-image:repeating-linear-gradient(45deg,transparent,transparent 6px,rgba(255,255,255,.1) 6px,rgba(255,255,255,.1) 12px);animation:_ngcontent-%COMP%_move-stripes 1s linear infinite}@keyframes _ngcontent-%COMP%_move-stripes{0%{background-position:0 0}to{background-position:17px 0}}.segment[_ngcontent-%COMP%]{opacity:.3;transition:opacity .3s ease}.segment.segment-active[_ngcontent-%COMP%], .segment.segment-completed[_ngcontent-%COMP%]{opacity:1}.status-on-track[_ngcontent-%COMP%]{color:#10b981}.status-behind[_ngcontent-%COMP%]{color:#f59e0b}.status-at-risk[_ngcontent-%COMP%]{color:#ef4444}.status-completed[_ngcontent-%COMP%]{color:#10b981}.action-btn.btn-primary[_ngcontent-%COMP%]{background-color:#3b82f6;color:#fff}.action-btn.btn-primary[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#2563eb}.action-btn.btn-success[_ngcontent-%COMP%]{background-color:#10b981;color:#fff}.action-btn.btn-success[_ngcontent-%COMP%]:hover:not(:disabled){background-color:#059669}.action-btn[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.goal-marker[_ngcontent-%COMP%]:hover   .marker-tooltip[_ngcontent-%COMP%], .milestone-marker[_ngcontent-%COMP%]:hover   .milestone-tooltip[_ngcontent-%COMP%]{opacity:1}@media (max-width: 768px){.progress-header[_ngcontent-%COMP%]{flex-direction:column;gap:.5rem;align-items:flex-start}.progress-info[_ngcontent-%COMP%]{flex-direction:column;gap:.25rem}}"]})}}return i})();function Nt(i,u){i&1&&(o(0,"span"),r(1,"\u2022"),a())}function Lt(i,u){if(i&1&&(o(0,"span",44),r(1),a()),i&2){let e=m().$implicit,t=m(3);c(),f(t.getEventTypeLabel(e.type))}}function $t(i,u){if(i&1&&(o(0,"div",45)(1,"div",46)(2,"span",47),r(3),a(),o(4,"div",48),r(5),a()()()),i&2){let e=m().$implicit,t=m(3);c(),P(t.getAmountDisplayClass(e)),c(2),f(t.formatCurrency((e.details==null?null:e.details.amount)||0)),c(2),f(t.getAmountLabel(e.type))}}function zt(i,u){if(i&1&&(o(0,"div",52)(1,"span",53),r(2,"M\xE9todo de Pago:"),a(),o(3,"span",54),r(4),a()()),i&2){let e=m(2).$implicit;c(4),f(e.details==null?null:e.details.paymentMethod)}}function qt(i,u){if(i&1&&(o(0,"div",52)(1,"span",53),r(2,"Referencia:"),a(),o(3,"span",55),r(4),a()()),i&2){let e=m(2).$implicit;c(4),f(e.details==null?null:e.details.reference)}}function Ut(i,u){if(i&1&&(o(0,"div",52)(1,"span",53),r(2,"Documento:"),a(),o(3,"span",54),r(4),a()()),i&2){let e=m(2).$implicit;c(4),f(e.details==null?null:e.details.documentName)}}function Bt(i,u){if(i&1&&(o(0,"div",52)(1,"span",53),r(2,"Estado:"),a(),o(3,"span",54),r(4),a()()),i&2){let e=m(2).$implicit;c(4),f(e.details==null?null:e.details.status)}}function Gt(i,u){if(i&1&&(o(0,"div",49)(1,"div",50),h(2,zt,5,1,"div",51)(3,qt,5,1,"div",51)(4,Ut,5,1,"div",51)(5,Bt,5,1,"div",51),a()()),i&2){let e=m().$implicit;c(2),p("ngIf",e.details==null?null:e.details.paymentMethod),c(),p("ngIf",e.details==null?null:e.details.reference),c(),p("ngIf",e.details==null?null:e.details.documentName),c(),p("ngIf",e.details==null?null:e.details.status)}}function jt(i,u){if(i&1){let e=I();o(0,"button",60),x("click",function(){y(e);let n=m(2).$implicit,s=m(3);return C(s.viewEventDetails(n))}),r(1," Ver Detalles "),a()}}function Qt(i,u){if(i&1){let e=I();o(0,"button",61),x("click",function(){y(e);let n=m(2).$implicit,s=m(3);return C(s.downloadReceipt(n))}),r(1," Descargar Recibo "),a()}}function Ht(i,u){if(i&1){let e=I();o(0,"button",62),x("click",function(){y(e);let n=m(2).$implicit,s=m(3);return C(s.reverseAction(n))}),r(1," Revertir "),a()}}function Wt(i,u){if(i&1&&(o(0,"div",56),h(1,jt,2,0,"button",57)(2,Qt,2,0,"button",58)(3,Ht,2,0,"button",59),a()),i&2){let e=m().$implicit,t=m(3);c(),p("ngIf",t.canViewDetails(e)),c(),p("ngIf",t.canDownloadReceipt(e)),c(),p("ngIf",t.canReverseAction(e))}}function Yt(i,u){if(i&1&&(o(0,"div",30),k(1,"div",31),o(2,"div",32)(3,"div",33)(4,"div",3)(5,"div",34),r(6),a(),o(7,"div",35)(8,"h5",36),r(9),a(),o(10,"div",37)(11,"span",38),r(12),a(),o(13,"span"),r(14,"\u2022"),a(),o(15,"span"),r(16),a(),h(17,Nt,2,0,"span",39)(18,Lt,2,1,"span",40),a()()(),h(19,$t,6,4,"div",41),a(),h(20,Gt,6,4,"div",42)(21,Wt,4,3,"div",43),a()()),i&2){let e=u.$implicit,t=m(3);c(),P(t.getEventNodeClass(e)),c(),P(t.getEventCardClass(e)),c(4),f(t.getEventIcon(e)),c(3),f(e.message),c(2),P(t.getActorBadgeClass(e.actor)),c(),b(" ",e.actor," "),c(4),f(t.formatTime(e.timestamp)),c(),p("ngIf",e.type!=="System"),c(),p("ngIf",e.type!=="System"),c(),p("ngIf",e.details==null?null:e.details.amount),c(),p("ngIf",t.hasEventDetails(e)),c(),p("ngIf",t.hasEventActions(e))}}function Xt(i,u){if(i&1&&(o(0,"div",21)(1,"div",22)(2,"div",23),k(3,"div",24),o(4,"h4",25),r(5),a(),k(6,"div",26),o(7,"span",27),r(8),a()()(),o(9,"div",28),h(10,Yt,22,15,"div",29),a()()),i&2){let e=u.$implicit,t=m(2);c(5),f(e.date),c(3),W(" ",e.events.length," evento",e.events.length!==1?"s":""," "),c(2),p("ngForOf",e.events)("ngForTrackBy",t.trackByEventId)}}function Jt(i,u){if(i&1&&(o(0,"div",16)(1,"div",17),k(2,"div",18),o(3,"div",19),h(4,Xt,11,5,"div",20),a()()()),i&2){let e=m();c(4),p("ngForOf",e.getEventGroups())("ngForTrackBy",e.trackByDate)}}function Kt(i,u){if(i&1&&(o(0,"span",82),r(1),a()),i&2){let e=m().$implicit,t=m(2);P(t.getAmountTextClass(e)),c(),b(" ",t.formatCurrency((e.details==null?null:e.details.amount)||0)," ")}}function Zt(i,u){i&1&&(o(0,"span",83),r(1,"-"),a())}function en(i,u){if(i&1){let e=I();o(0,"button",84),x("click",function(){y(e);let n=m().$implicit,s=m(2);return C(s.showEventActions(n))}),o(1,"span",85),r(2,"\u22EE"),a()()}}function tn(i,u){if(i&1&&(o(0,"div",71)(1,"div",72)(2,"span",73),r(3),a()(),o(4,"div",74)(5,"span",75),r(6),a()(),o(7,"div",76)(8,"span",77),r(9),a()(),o(10,"div",76),h(11,Kt,2,3,"span",78)(12,Zt,2,0,"span",79),a(),o(13,"div",76)(14,"span",80),r(15),a()(),o(16,"div",72),h(17,en,3,0,"button",81),a()()),i&2){let e=u.$implicit,t=m(2);c(3),f(t.getEventIcon(e)),c(3),f(e.message),c(2),P(t.getActorBadgeClass(e.actor)),c(),b(" ",e.actor," "),c(2),p("ngIf",e.details==null?null:e.details.amount),c(),p("ngIf",!(e.details!=null&&e.details.amount)),c(3),f(t.formatDateTime(e.timestamp)),c(2),p("ngIf",t.hasEventActions(e))}}function nn(i,u){if(i&1&&(o(0,"div",63)(1,"div",64)(2,"div",65)(3,"div",66),r(4,"Tipo"),a(),o(5,"div",67),r(6,"Evento"),a(),o(7,"div",68),r(8,"Actor"),a(),o(9,"div",68),r(10,"Monto"),a(),o(11,"div",68),r(12,"Fecha"),a(),o(13,"div",66),r(14,"Acciones"),a()(),o(15,"div",69),h(16,tn,18,9,"div",70),a()()()),i&2){let e=m();c(16),p("ngForOf",e.filteredEvents)("ngForTrackBy",e.trackByEventId)}}function on(i,u){if(i&1&&(o(0,"div",86)(1,"div",87),r(2,"\u{1F5D2}\uFE0F"),a(),o(3,"h4",88),r(4,"No hay eventos"),a(),o(5,"p",89),r(6),a()()),i&2){let e=m();c(6),f(e.getEmptyStateMessage())}}function an(i,u){if(i&1){let e=I();o(0,"div",90)(1,"button",91),x("click",function(){y(e);let n=m();return C(n.loadMoreEvents())}),r(2),a()()}if(i&2){let e=m();c(),p("disabled",e.isLoadingMore),c(),b(" ",e.isLoadingMore?"Cargando...":"Cargar M\xE1s Eventos"," ")}}var He=(()=>{class i{constructor(){this.events=[],this.maxEvents=50,this.showFilters=!0,this.showActions=!0,this.autoRefresh=!1,this.viewMode="timeline",this.eventFilter="all",this.filteredEvents=[],this.hasMoreEvents=!1,this.isLoadingMore=!1}ngOnInit(){this.updateFilteredEvents()}setViewMode(e){this.viewMode=e}setEventFilter(e){this.eventFilter=e,this.updateFilteredEvents()}updateFilteredEvents(){let e=[...this.events];switch(this.eventFilter){case"payments":e=e.filter(t=>t.type===E.Contribution||t.type===E.Collection);break;case"documents":e=e.filter(t=>t.type===E.AdvisorAction&&t.message.toLowerCase().includes("documento"));break;case"system":e=e.filter(t=>t.type===E.System);break}e.sort((t,n)=>new Date(n.timestamp).getTime()-new Date(t.timestamp).getTime()),this.filteredEvents=e.slice(0,this.maxEvents),this.hasMoreEvents=e.length>this.maxEvents}getEventGroups(){let e={};return this.filteredEvents.forEach(t=>{let n=this.formatDate(t.timestamp);e[n]||(e[n]=[]),e[n].push(t)}),Object.keys(e).map(t=>({date:t,events:e[t]}))}getEventIcon(e){return{[E.Contribution]:"\u{1F4B0}",[E.Collection]:"\u{1F69A}",[E.AdvisorAction]:"\u{1F464}",[E.ClientAction]:"\u{1F697}",[E.System]:"\u2699\uFE0F",[E.GoalAchieved]:"\u{1F3AF}"}[e.type]||"\u{1F4DD}"}getEventNodeClass(e){return e.type===E.Contribution?"event-node payment":e.type===E.Collection?"event-node collection":e.type===E.AdvisorAction?"event-node document":"event-node system"}getEventCardClass(e){return e.type===E.Contribution?"event-card payment":e.type===E.Collection?"event-card collection":e.type===E.AdvisorAction?"event-card document":"event-card system"}getActorBadgeClass(e){return{[de.Asesor]:"actor-badge asesor",[de.Cliente]:"actor-badge cliente",[de.Sistema]:"actor-badge sistema"}[e]||"actor-badge sistema"}getAmountDisplayClass(e){return e.type===E.Contribution||e.type===E.Collection?"amount-display income":"amount-display expense"}getAmountTextClass(e){return e.type===E.Contribution||e.type===E.Collection?"amount-text positive":"amount-text negative"}getAmountLabel(e){return{[E.Contribution]:"Aportaci\xF3n",[E.Collection]:"Recaudaci\xF3n",[E.AdvisorAction]:"Transacci\xF3n",[E.ClientAction]:"Transacci\xF3n",[E.System]:"Ajuste",[E.GoalAchieved]:"Meta"}[e]}getEventTypeLabel(e){return{[E.Contribution]:"Contribuci\xF3n",[E.Collection]:"Recaudaci\xF3n",[E.AdvisorAction]:"Acci\xF3n del Asesor",[E.ClientAction]:"Acci\xF3n del Cliente",[E.System]:"Sistema",[E.GoalAchieved]:"Meta Alcanzada"}[e]}getEmptyStateMessage(){return{all:"No se han registrado eventos a\xFAn",payments:"No se han registrado pagos",documents:"No se han subido documentos",system:"No hay eventos del sistema"}[this.eventFilter]}hasEventDetails(e){return!!(e.details&&(e.details.paymentMethod||e.details.reference||e.details.documentName||e.details.status))}hasEventActions(e){return this.showActions&&(this.canViewDetails(e)||this.canDownloadReceipt(e)||this.canReverseAction(e))}canViewDetails(e){return!!(e.details&&Object.keys(e.details).length>0)}canDownloadReceipt(e){return e.type===E.Contribution||e.type===E.Collection}canReverseAction(e){return e.actor===de.Asesor&&e.type===E.AdvisorAction}formatDate(e){let t=new Date(e),n=new Date,s=new Date(n);return s.setDate(s.getDate()-1),t.toDateString()===n.toDateString()?"Hoy":t.toDateString()===s.toDateString()?"Ayer":t.toLocaleDateString("es-MX",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}formatTime(e){return new Date(e).toLocaleTimeString("es-MX",{hour:"2-digit",minute:"2-digit"})}formatDateTime(e){return new Date(e).toLocaleDateString("es-MX",{month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}formatCurrency(e){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(e)}trackByDate(e,t){return t.date}trackByEventId(e,t){return t.id}viewEventDetails(e){console.log("View event details:",e)}downloadReceipt(e){console.log("Download receipt for event:",e)}reverseAction(e){console.log("Reverse action:",e)}showEventActions(e){console.log("Show event actions:",e)}loadMoreEvents(){this.isLoadingMore=!0,setTimeout(()=>{this.isLoadingMore=!1},1e3)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=$({type:i,selectors:[["app-event-log"]],inputs:{events:"events",maxEvents:"maxEvents",showFilters:"showFilters",showActions:"showActions",autoRefresh:"autoRefresh"},standalone:!0,features:[z],decls:30,vars:16,consts:[[1,"event-log","bg-gray-900","rounded-xl","border","border-gray-800","p-6"],[1,"log-header","mb-6"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"icon-container"],[1,"text-xl","font-bold","text-white"],[1,"text-sm","text-gray-400"],[1,"log-controls","flex","items-center","gap-3"],[1,"filter-buttons","flex","items-center","gap-2"],[1,"filter-btn","px-3","py-1","text-xs","font-medium","rounded-full","transition-colors",3,"click"],[1,"view-toggle","flex","items-center","bg-gray-700","rounded-lg","p-1"],[1,"toggle-btn","px-3","py-1","text-xs","font-medium","rounded-md","transition-colors",3,"click"],["class","timeline-view",4,"ngIf"],["class","list-view",4,"ngIf"],["class","empty-state text-center py-12",4,"ngIf"],["class","load-more text-center mt-6",4,"ngIf"],[1,"timeline-view"],[1,"timeline-container","relative"],[1,"timeline-line","absolute","left-8","top-0","bottom-0","w-0.5","bg-gradient-to-b","from-primary-cyan-500","via-primary-cyan-600","to-gray-600"],[1,"event-groups","space-y-8"],["class","event-group",4,"ngFor","ngForOf","ngForTrackBy"],[1,"event-group"],[1,"date-header","sticky","top-0","z-10","bg-gray-900/80","backdrop-blur-sm","py-3","mb-4"],[1,"flex","items-center","gap-4"],[1,"date-marker","w-4","h-4","bg-primary-cyan-500","rounded-full","relative","z-10","flex-shrink-0","ml-6"],[1,"text-lg","font-semibold","text-white"],[1,"date-line","flex-1","h-px","bg-gray-700"],[1,"event-count","px-3","py-1","bg-gray-800","text-gray-300","rounded-full","text-sm"],[1,"events-list","space-y-4","ml-4"],["class","event-item relative",4,"ngFor","ngForOf","ngForTrackBy"],[1,"event-item","relative"],[1,"event-node","absolute","left-4","top-4","w-3","h-3","rounded-full","border-2","border-gray-900","z-10"],[1,"event-card","ml-12","p-4","rounded-lg","border","transition-all","duration-200","hover:scale-[1.02]"],[1,"event-header","flex","items-center","justify-between","mb-3"],[1,"event-icon","text-xl"],[1,"event-meta"],[1,"event-title","font-semibold","text-white","text-sm"],[1,"event-details","flex","items-center","gap-2","text-xs","text-gray-400","mt-1"],[1,"actor-badge","px-2","py-1","rounded-full","font-medium"],[4,"ngIf"],["class","event-type",4,"ngIf"],["class","event-amount",4,"ngIf"],["class","event-details-section",4,"ngIf"],["class","event-actions mt-3 flex items-center gap-2",4,"ngIf"],[1,"event-type"],[1,"event-amount"],[1,"amount-display","px-3","py-2","rounded-lg"],[1,"amount-value","font-bold","text-lg"],[1,"amount-label","text-xs","opacity-80"],[1,"event-details-section"],[1,"details-grid","grid","grid-cols-1","md:grid-cols-2","gap-4"],["class","detail-item",4,"ngIf"],[1,"detail-item"],[1,"detail-label","text-gray-400","text-xs"],[1,"detail-value","text-white","text-sm","font-medium"],[1,"detail-value","text-white","text-sm","font-medium","font-mono"],[1,"event-actions","mt-3","flex","items-center","gap-2"],["class","action-btn px-3 py-1 bg-gray-700 hover:bg-gray-600 text-gray-300 hover:text-white rounded-md text-xs transition-colors",3,"click",4,"ngIf"],["class","action-btn px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded-md text-xs transition-colors",3,"click",4,"ngIf"],["class","action-btn px-3 py-1 bg-red-600 hover:bg-red-700 text-white rounded-md text-xs transition-colors",3,"click",4,"ngIf"],[1,"action-btn","px-3","py-1","bg-gray-700","hover:bg-gray-600","text-gray-300","hover:text-white","rounded-md","text-xs","transition-colors",3,"click"],[1,"action-btn","px-3","py-1","bg-emerald-600","hover:bg-emerald-700","text-white","rounded-md","text-xs","transition-colors",3,"click"],[1,"action-btn","px-3","py-1","bg-red-600","hover:bg-red-700","text-white","rounded-md","text-xs","transition-colors",3,"click"],[1,"list-view"],[1,"events-table"],[1,"table-header","grid","grid-cols-12","gap-4","p-3","bg-gray-800","rounded-t-lg","text-sm","font-medium","text-gray-300"],[1,"col-span-1"],[1,"col-span-4"],[1,"col-span-2"],[1,"table-body"],["class","table-row grid grid-cols-12 gap-4 p-3 border-b border-gray-700 hover:bg-gray-800/50 transition-colors",4,"ngFor","ngForOf","ngForTrackBy"],[1,"table-row","grid","grid-cols-12","gap-4","p-3","border-b","border-gray-700","hover:bg-gray-800/50","transition-colors"],[1,"col-span-1","flex","items-center"],[1,"event-type-icon","text-lg"],[1,"col-span-4","flex","items-center"],[1,"text-white","text-sm"],[1,"col-span-2","flex","items-center"],[1,"actor-badge","px-2","py-1","rounded-full","text-xs","font-medium"],["class","amount-text font-mono text-sm",3,"class",4,"ngIf"],["class","text-gray-500 text-sm",4,"ngIf"],[1,"text-gray-300","text-sm"],["class","action-menu-btn p-1 hover:bg-gray-700 rounded-md transition-colors",3,"click",4,"ngIf"],[1,"amount-text","font-mono","text-sm"],[1,"text-gray-500","text-sm"],[1,"action-menu-btn","p-1","hover:bg-gray-700","rounded-md","transition-colors",3,"click"],[1,"text-gray-400","hover:text-white"],[1,"empty-state","text-center","py-12"],[1,"empty-icon","text-6xl","mb-4"],[1,"text-xl","font-semibold","text-gray-300","mb-2"],[1,"text-gray-500"],[1,"load-more","text-center","mt-6"],[1,"load-more-btn","px-6","py-3","bg-gray-700","hover:bg-gray-600","text-white","rounded-lg","font-medium","transition-colors","disabled:opacity-50",3,"click","disabled"]],template:function(t,n){t&1&&(o(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4),r(5," \u{1F4DC} "),a(),o(6,"div")(7,"h3",5),r(8,"Historial de Eventos"),a(),o(9,"p",6),r(10,"Registro cronol\xF3gico de actividades"),a()()(),o(11,"div",7)(12,"div",8)(13,"button",9),x("click",function(){return n.setEventFilter("all")}),r(14," Todos "),a(),o(15,"button",9),x("click",function(){return n.setEventFilter("payments")}),r(16," Pagos "),a(),o(17,"button",9),x("click",function(){return n.setEventFilter("documents")}),r(18," Documentos "),a(),o(19,"button",9),x("click",function(){return n.setEventFilter("system")}),r(20," Sistema "),a()(),o(21,"div",10)(22,"button",11),x("click",function(){return n.setViewMode("timeline")}),r(23," Timeline "),a(),o(24,"button",11),x("click",function(){return n.setViewMode("list")}),r(25," Lista "),a()()()()(),h(26,Jt,5,2,"div",12)(27,nn,17,2,"div",13)(28,on,7,1,"div",14)(29,an,3,2,"div",15),a()),t&2&&(c(13),P(n.eventFilter==="all"?"bg-primary-cyan-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"),c(2),P(n.eventFilter==="payments"?"bg-emerald-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"),c(2),P(n.eventFilter==="documents"?"bg-amber-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"),c(2),P(n.eventFilter==="system"?"bg-blue-600 text-white":"bg-gray-700 text-gray-300 hover:bg-gray-600"),c(3),P(n.viewMode==="timeline"?"bg-primary-cyan-600 text-white":"text-gray-300 hover:text-white"),c(2),P(n.viewMode==="list"?"bg-primary-cyan-600 text-white":"text-gray-300 hover:text-white"),c(2),p("ngIf",n.viewMode==="timeline"&&n.filteredEvents.length>0),c(),p("ngIf",n.viewMode==="list"&&n.filteredEvents.length>0),c(),p("ngIf",n.filteredEvents.length===0),c(),p("ngIf",n.hasMoreEvents))},dependencies:[U,Y,q],styles:[".event-log[_ngcontent-%COMP%]{position:relative;max-height:600px;overflow-y:auto}.icon-container[_ngcontent-%COMP%]{font-size:2rem;opacity:.9}.timeline-line[_ngcontent-%COMP%]{background:linear-gradient(to bottom,#06b6d4,#0891b2,#6b7280)}.event-node.payment[_ngcontent-%COMP%]{background-color:#10b981;border-color:#059669}.event-node.document[_ngcontent-%COMP%]{background-color:#f59e0b;border-color:#d97706}.event-node.system[_ngcontent-%COMP%]{background-color:#3b82f6;border-color:#2563eb}.event-node.collection[_ngcontent-%COMP%]{background-color:#06b6d4;border-color:#0891b2}.event-card[_ngcontent-%COMP%]{background:#1f293780;border-color:#4b55634d;-webkit-backdrop-filter:blur(4px);backdrop-filter:blur(4px)}.event-card.payment[_ngcontent-%COMP%]{border-left:4px solid #10b981}.event-card.document[_ngcontent-%COMP%]{border-left:4px solid #f59e0b}.event-card.system[_ngcontent-%COMP%]{border-left:4px solid #3b82f6}.event-card.collection[_ngcontent-%COMP%]{border-left:4px solid #06b6d4}.actor-badge.asesor[_ngcontent-%COMP%]{background-color:#3b82f633;color:#3b82f6}.actor-badge.cliente[_ngcontent-%COMP%]{background-color:#10b98133;color:#10b981}.actor-badge.sistema[_ngcontent-%COMP%]{background-color:#6b728033;color:#6b7280}.amount-display.income[_ngcontent-%COMP%]{background-color:#10b9811a;border:1px solid rgba(16,185,129,.2);color:#10b981}.amount-display.expense[_ngcontent-%COMP%]{background-color:#ef44441a;border:1px solid rgba(239,68,68,.2);color:#ef4444}.amount-text.positive[_ngcontent-%COMP%]{color:#10b981}.amount-text.negative[_ngcontent-%COMP%]{color:#ef4444}.detail-item[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:.25rem}.event-item[_ngcontent-%COMP%]:hover   .event-card[_ngcontent-%COMP%]{background:#1f2937cc}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.event-item[_ngcontent-%COMP%]{animation:_ngcontent-%COMP%_fadeIn .3s ease-out}.date-header[_ngcontent-%COMP%]{-webkit-backdrop-filter:blur(8px);backdrop-filter:blur(8px)}@media (max-width: 768px){.log-controls[_ngcontent-%COMP%]{flex-direction:column;gap:.75rem}.filter-buttons[_ngcontent-%COMP%]{flex-wrap:wrap}.event-card[_ngcontent-%COMP%]{margin-left:1rem}.table-row[_ngcontent-%COMP%]{grid-template-columns:1fr;gap:.5rem}.table-header[_ngcontent-%COMP%]{display:none}.table-row[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center}.table-row[_ngcontent-%COMP%] > div[_ngcontent-%COMP%]:before{content:attr(data-label);font-weight:600;color:#9ca3af;font-size:.75rem}}"]})}}return i})();var We=(()=>{class i{constructor(e){this.http=e,this.baseUrl="https://graph.facebook.com/v18.0",this.phoneNumberId=ne.whatsappPhoneNumberId||"your-phone-number-id",this.accessToken=ne.whatsappAccessToken||"your-access-token",this.webhookVerifyToken=ne.whatsappWebhookVerifyToken||"your-verify-token"}getHeaders(){return new Te({Authorization:`Bearer ${this.accessToken}`,"Content-Type":"application/json"})}sendMessage(e){let t=`${this.baseUrl}/${this.phoneNumberId}/messages`;return this.http.post(t,M({messaging_product:"whatsapp"},e),{headers:this.getHeaders()}).pipe(xe(2),v(this.handleError))}sendTextMessage(e,t){let n={recipient_type:"individual",to:this.formatPhoneNumber(e),type:"text",text:{body:t}};return this.sendMessage(n)}sendTemplateMessage(e,t,n="es_MX",s=[]){let l={recipient_type:"individual",to:this.formatPhoneNumber(e),type:"template",template:{name:t,language:{code:n},components:s}};return this.sendMessage(l)}sendPaymentNotification(e,t){let n=[{type:"body",parameters:[{type:"text",text:t.client_name},{type:"currency",currency:{fallback_value:`$${t.amount.toLocaleString("es-MX")}`,code:"MXN",amount_1000:t.amount*1e3}},{type:"text",text:t.due_date},{type:"text",text:t.reference}]},{type:"button",sub_type:"url",index:0,parameters:[{type:"text",text:t.payment_link}]}];return this.sendTemplateMessage(e,"payment_notification","es_MX",n)}sendGNVOverageNotification(e,t){let n=[{type:"body",parameters:[{type:"text",text:t.client_name},{type:"text",text:t.month},{type:"text",text:t.total_consumption.toString()},{type:"currency",currency:{fallback_value:`$${t.overage_amount.toLocaleString("es-MX")}`,code:"MXN",amount_1000:t.overage_amount*1e3}}]},{type:"button",sub_type:"url",index:0,parameters:[{type:"text",text:t.payment_link}]}];return this.sendTemplateMessage(e,"gnv_overage_notification","es_MX",n)}sendDocumentPendingNotification(e,t,n,s){let l=[{type:"body",parameters:[{type:"text",text:t},{type:"text",text:n},{type:"text",text:s}]}];return this.sendTemplateMessage(e,"document_pending","es_MX",l)}sendContractApprovedNotification(e,t,n,s){let l=[{type:"body",parameters:[{type:"text",text:t},{type:"text",text:n},{type:"text",text:s}]}];return this.sendTemplateMessage(e,"contract_approved","es_MX",l)}sendWelcomeMessage(e,t,n,s){let l=[{type:"body",parameters:[{type:"text",text:t},{type:"text",text:n},{type:"text",text:s}]}];return this.sendTemplateMessage(e,"welcome_message","es_MX",l)}verifyWebhook(e,t,n){return e==="subscribe"&&t===this.webhookVerifyToken?n:null}processWebhook(e){e.entry.forEach(t=>{t.changes.forEach(n=>{n.field==="messages"&&(n.value.statuses&&n.value.statuses.forEach(s=>{this.handleMessageStatus(s)}),n.value.messages&&n.value.messages.forEach(s=>{this.handleIncomingMessage(s)}))})})}handleMessageStatus(e){console.log("Message status update:",e),this.updateMessageStatus(e.id,e.status,e.timestamp).subscribe({next:t=>console.log("Status updated:",t),error:t=>console.error("Failed to update status:",t)})}handleIncomingMessage(e){console.log("Incoming message:",e),this.processIncomingMessage(e).subscribe({next:t=>console.log("Message processed:",t),error:t=>console.error("Failed to process message:",t)})}updateMessageStatus(e,t,n){return this.http.patch(`${ne.apiUrl}/whatsapp/messages/${e}/status`,{status:t,timestamp:n},{headers:{Authorization:`Bearer ${this.getBackendToken()}`}})}processIncomingMessage(e){return this.http.post(`${ne.apiUrl}/whatsapp/messages/incoming`,{message:e},{headers:{Authorization:`Bearer ${this.getBackendToken()}`}})}formatPhoneNumber(e){let t=e.replace(/\D/g,"");return t.startsWith("52")||t.startsWith("1")&&t.length===11?t:t.length===10?"52"+t:t}getBackendToken(){return localStorage.getItem("auth_token")||""}handleError(e){console.error("WhatsApp API Error:",e);let t="WhatsApp message failed";return e.error&&e.error.error&&(t=e.error.error.message||t),ge(()=>new Error(t))}sendBulkPaymentNotifications(e){let t=[],n=0,s=0;return new ye(l=>{let d=e.map(g=>Z(this,null,function*(){try{let S=yield this.sendPaymentNotification(g.phone,g.data).toPromise();t.push({phone:g.phone,success:!0,result:S}),n++}catch(S){t.push({phone:g.phone,success:!1,error:S}),s++}}));Promise.all(d).then(()=>{l.next({successful:n,failed:s,results:t}),l.complete()}).catch(g=>{l.error(g)})})}getTemplateStatus(e){let t=`${this.baseUrl}/${this.phoneNumberId}/message_templates`;return this.http.get(t,{headers:this.getHeaders(),params:{name:e}}).pipe(xe(2),v(this.handleError))}getMessageAnalytics(e,t){return this.http.get(`${ne.apiUrl}/whatsapp/analytics`,{params:{start_date:e,end_date:t},headers:{Authorization:`Bearer ${this.getBackendToken()}`}})}getDeliveryReport(e){return this.http.get(`${ne.apiUrl}/whatsapp/messages/${e}/report`,{headers:{Authorization:`Bearer ${this.getBackendToken()}`}})}static{this.\u0275fac=function(t){return new(t||i)(Se(te))}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Ye=(()=>{class i{constructor(){this.http=R(te),this.whatsappService=R(We),this.baseUrl=window.__BFF_BASE__??"/api",this.milestoneTemplates={pedidoPlanta:{name:"import_milestone_factory_order",title:"\u{1F4CB} Pedido Enviado a Planta",description:"Tu vagoneta ha sido solicitada a la planta manufacturera"},unidadFabricada:{name:"import_milestone_unit_manufactured",title:"\u{1F3ED} Unidad Fabricada",description:"Tu vagoneta ha sido fabricada y est\xE1 lista para env\xEDo"},transitoMaritimo:{name:"import_milestone_maritime_transit",title:"\u{1F6A2} En Tr\xE1nsito Mar\xEDtimo",description:"Tu vagoneta est\xE1 navegando hacia M\xE9xico"},enAduana:{name:"import_milestone_in_customs",title:"\u{1F6C3} En Proceso Aduanal",description:"Tu vagoneta est\xE1 siendo procesada en aduana"},liberada:{name:"import_milestone_customs_released",title:"\u2705 Liberada de Aduana",description:"Tu vagoneta ha sido liberada y est\xE1 lista para entrega"}}}sendMilestoneNotification(e,t,n,s,l){return console.log(`\u{1F4F1} Enviando notificaci\xF3n de milestone ${t} (${n}) para cliente ${e}`),this.getNotificationSettings(e).pipe(w(d=>{if(!d||!d.isActive)throw new Error("Notificaciones desactivadas para este cliente");if(!this.shouldSendNotification(d,t,n))throw new Error("Notificaci\xF3n filtrada por configuraci\xF3n del cliente");return d}),w(d=>this.buildNotificationTemplate(d,t,n,s,l)),w(d=>this.selectWhatsAppTemplate(t,n,d)),ee(({templateName:d,templateData:g})=>this.whatsappService.sendTemplateMessage(g.client_phone,d,g.language||"es_MX",this.buildWhatsAppComponents(g))),w(d=>{let g={messageId:d.messages?.[0]?.id||"unknown",clientId:e,phoneNumber:l?.phone||"unknown",milestone:t,notificationType:this.getNotificationType(n),templateUsed:this.milestoneTemplates[t].name,sentAt:new Date,success:!0,whatsappResponse:d};return this.logNotificationSent(g).subscribe(),g}),v(d=>{console.error("\u274C Error enviando notificaci\xF3n de milestone:",d);let g={messageId:"failed",clientId:e,phoneNumber:l?.phone||"unknown",milestone:t,notificationType:this.getNotificationType(n),templateUsed:this.milestoneTemplates[t].name,sentAt:new Date,success:!1,errorMessage:d.message||"Error desconocido"};return _(g)}))}sendDeliveryUpdateNotification(e,t,n,s){return console.log(`\u{1F4E6} Enviando notificaci\xF3n de delivery ${n} para cliente ${e}`),this.getNotificationSettings(e).pipe(w(l=>{if(!l||!l.isActive)throw new Error("Notificaciones desactivadas para este cliente");return l}),w(l=>({templateData:{client_name:s?.clientName||"Cliente",client_phone:l.phoneNumber,delivery_order_id:t,update_type:n,message:this.getDeliveryUpdateMessage(n,s),tracking_url:`${window.location.origin}/tracking/client/${e}`,language:l.language||"es_MX"},settings:l})),ee(({templateData:l})=>this.whatsappService.sendTemplateMessage(l.client_phone,"delivery_update_notification",l.language,[{type:"body",parameters:[{type:"text",text:l.client_name},{type:"text",text:l.delivery_order_id},{type:"text",text:l.message}]},{type:"button",sub_type:"url",index:0,parameters:[{type:"text",text:l.tracking_url}]}])),w(l=>{let d={messageId:l.messages?.[0]?.id||"unknown",clientId:e,phoneNumber:s?.clientPhone||"unknown",milestone:"liberada",notificationType:"delivery_update",templateUsed:"delivery_update_notification",sentAt:new Date,success:!0,whatsappResponse:l};return this.logNotificationSent(d).subscribe(),d}),v(l=>(console.error("\u274C Error enviando notificaci\xF3n de delivery:",l),_({messageId:"failed",clientId:e,phoneNumber:s?.clientPhone||"unknown",milestone:"liberada",notificationType:"delivery_update",templateUsed:"delivery_update_notification",sentAt:new Date,success:!1,errorMessage:l.message||"Error desconocido"}))))}updateNotificationSettings(e,t){return this.http.patch(`${this.baseUrl}/v1/clients/${e}/import-notification-settings`,t).pipe(O(n=>{console.log(`\u2699\uFE0F Configuraci\xF3n de notificaciones actualizada para cliente ${e}`)}),v(()=>_(this.getDefaultNotificationSettings(e))))}getNotificationSettings(e){return this.http.get(`${this.baseUrl}/v1/clients/${e}/import-notification-settings`).pipe(v(()=>_(this.getDefaultNotificationSettings(e))))}getNotificationHistory(e,t=50){return this.http.get(`${this.baseUrl}/v1/clients/${e}/import-notifications`,{params:{limit:t.toString()}}).pipe(v(()=>_([])))}sendBulkMilestoneNotifications(e,t,n){console.log(`\u{1F4E2} Enviando notificaciones masivas de ${e} (${n}) a ${t.length} clientes`);let s=t.map(l=>this.sendMilestoneNotification(l,e,n,{}).toPromise());return Ce(s).pipe(w(l=>l.filter(d=>d!==null)),O(l=>{let d=l.filter(S=>S.success).length,g=l.length-d;console.log(`\u{1F4CA} Notificaciones masivas completadas: ${d} exitosas, ${g} fallidas`)}),v(l=>(console.error("Error en notificaciones masivas:",l),_([]))))}getDefaultNotificationSettings(e){return{clientId:e,phoneNumber:"",milestones:{pedidoPlanta:{onStart:!0,onCompletion:!0,onDelay:!0},unidadFabricada:{onStart:!0,onCompletion:!0,onDelay:!0},transitoMaritimo:{onStart:!0,onCompletion:!0,onDelay:!0},enAduana:{onStart:!0,onCompletion:!0,onDelay:!0},liberada:{onStart:!0,onCompletion:!0,onDelay:!1}},language:"es_MX",timezone:"America/Mexico_City",notificationHours:{start:8,end:20},isActive:!0}}shouldSendNotification(e,t,n){let s=e.milestones[t];if(!s||n==="in_progress"&&!s.onStart||n==="completed"&&!s.onCompletion||n==="delayed"&&!s.onDelay)return!1;let d=new Date().getHours();return!(d<e.notificationHours.start||d>e.notificationHours.end)}buildNotificationTemplate(e,t,n,s,l){let d=this.milestoneTemplates[t],g=n==="in_progress"?"En Progreso":n==="completed"?"Completado":"Con Retraso";return{client_name:l?.name||"Cliente",milestone_name:d.title,milestone_description:d.description,vehicle_type:"Vagoneta H6C",estimated_days:s?.[t]?.estimatedDays,estimated_date:s?.estimatedDeliveryDate?.toLocaleDateString("es-MX"),current_status:g,delivery_order_id:s?.deliveryOrderId,tracking_url:`${window.location.origin}/tracking/client/${e.clientId}`,advisor_name:"Tu Asesor",advisor_phone:"+52 55 1234-5678"}}selectWhatsAppTemplate(e,t,n){let s=this.milestoneTemplates[e];return{templateName:t==="delayed"?`${s.name}_delayed`:s.name,templateData:D(M({},n),{client_phone:n.tracking_url,language:"es_MX"})}}buildWhatsAppComponents(e){return[{type:"body",parameters:[{type:"text",text:e.client_name},{type:"text",text:e.milestone_name},{type:"text",text:e.milestone_description},{type:"text",text:e.current_status}]},{type:"button",sub_type:"url",index:0,parameters:[{type:"text",text:e.tracking_url}]}]}getNotificationType(e){switch(e){case"in_progress":return"milestone_start";case"completed":return"milestone_completed";case"delayed":return"milestone_delayed";default:return"delivery_update"}}getDeliveryUpdateMessage(e,t){return{order_created:"Tu orden de entrega ha sido creada y el proceso de importaci\xF3n ha iniciado.",status_changed:`El estado de tu orden ha cambiado a: ${t?.newStatus||"actualizado"}.`,delay_alert:`Se ha detectado un retraso en tu entrega. Tiempo estimado adicional: ${t?.delayDays||"por determinar"} d\xEDas.`,ready_for_pickup:"Tu vagoneta est\xE1 lista para entrega. Por favor contacta a tu asesor para coordinar la entrega."}[e]||"Tu entrega ha sido actualizada."}logNotificationSent(e){return this.http.post(`${this.baseUrl}/v1/import-notifications/log`,e).pipe(v(()=>_()))}handleError(e="operation"){return t=>{console.error(`ImportWhatsAppNotificationsService.${e} failed:`,t);let n="Error en el sistema de notificaciones de importaci\xF3n";throw t.status===404?n="Configuraci\xF3n de notificaciones no encontrada":t.status===403?n="No tienes permisos para gestionar notificaciones":t.status===400?n=t.error?.message||"Solicitud de notificaci\xF3n inv\xE1lida":t.status>=500&&(n="Error del servidor. Intenta m\xE1s tarde"),{operation:e,originalError:t,userMessage:n,timestamp:new Date().toISOString()}}}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Xe=(()=>{class i{constructor(){this.assignmentUpdatesSubject=new ue(null),this.assignmentUpdates$=this.assignmentUpdatesSubject.asObservable()}assignVehicleToClient(e){console.log("\u{1F69B} Asignando unidad espec\xEDfica al cliente:",e.clientId);try{let t={id:this.generateUnitId(),vin:e.vin,serie:e.serie,modelo:e.modelo,year:e.year,color:"Blanco",numeroMotor:e.numeroMotor,transmission:e.transmission,fuelType:"Gasolina",assignedAt:new Date,assignedBy:e.assignedBy,productionBatch:e.productionBatch,factoryLocation:e.factoryLocation,notes:e.notes},n={success:!0,assignedUnit:t,client:this.updateClientWithAssignedUnit(e.clientId,t)};return this.assignmentUpdatesSubject.next(n),console.log("\u2705 Unidad asignada exitosamente:",{clientId:e.clientId,vin:t.vin,serie:t.serie,modelo:t.modelo}),_(n)}catch(t){let n={success:!1,error:`Error asignando unidad: ${t}`};return console.error("\u274C Error en asignaci\xF3n de unidad:",t),this.assignmentUpdatesSubject.next(n),_(n)}}getAssignedVehicle(e){console.log("\u{1F50D} Obteniendo unidad asignada para cliente:",e);try{let t=localStorage.getItem("vehicle_assignments");if(t){let s=JSON.parse(t)[e];if(s)return console.log("\u2705 Unidad encontrada:",s),_(s)}return console.log("\u2139\uFE0F No hay unidad asignada para este cliente"),_(null)}catch(t){return console.error("\u274C Error obteniendo unidad asignada:",t),_(null)}}getAllAssignedVehicles(){try{let e=localStorage.getItem("vehicle_assignments"),t=e?JSON.parse(e):{};return console.log("\u{1F4CB} Listando todas las asignaciones:",Object.keys(t).length),_(t)}catch(e){return console.error("\u274C Error listando asignaciones:",e),_({})}}validateVehicleData(e){let t=[];return e.clientId?.trim()||t.push("ID del cliente es requerido"),e.vin?.trim()||t.push("VIN es requerido"),e.serie?.trim()||t.push("Serie es requerida"),e.modelo?.trim()||t.push("Modelo es requerido"),(!e.year||e.year<2020||e.year>new Date().getFullYear()+2)&&t.push("A\xF1o debe estar entre 2020 y "+(new Date().getFullYear()+2)),e.numeroMotor?.trim()||t.push("N\xFAmero de motor es requerido"),e.assignedBy?.trim()||t.push("Usuario asignador es requerido"),e.vin&&e.vin.length!==17&&t.push("VIN debe tener exactamente 17 caracteres"),{valid:t.length===0,errors:t}}isVehicleAlreadyAssigned(e){return this.getAllAssignedVehicles().pipe(w(t=>{for(let[n,s]of Object.entries(t))if(s.vin===e)return{assigned:!0,clientId:n};return{assigned:!1}}),v(()=>_({assigned:!1})))}generateUnitId(){return"unit_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}updateClientWithAssignedUnit(e,t){try{let n=localStorage.getItem("vehicle_assignments")||"{}",s=JSON.parse(n);return s[e]=t,localStorage.setItem("vehicle_assignments",JSON.stringify(s)),{id:e,name:"Cliente Mock",avatarUrl:"",flow:"VentaPlazo",status:"Activo",documents:[],events:[],importStatus:{pedidoPlanta:{status:"completed"},unidadFabricada:{status:"completed"},transitoMaritimo:{status:"pending"},enAduana:{status:"pending"},liberada:{status:"pending"},assignedUnit:t}}}catch(n){throw console.error("Error actualizando cliente con unidad:",n),n}}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Je=(()=>{class i{constructor(){this.contractTemplates=[],this.flowRules=[],this.initializeContractTemplates(),this.initializeFlowRules()}getRequiredContractType(e,t){let n=this.flowRules.find(s=>s.market===e.market&&s.flow===e.flow&&s.stage===t);return _(n?.requiredContract||null).pipe(Q(100))}generateContract(e,t,n){let s=this.contractTemplates.find(S=>S.type===t&&S.market===e.market&&S.flow===e.flow);if(!s)throw new Error(`No template found for contract type: ${t}`);let l=s.requiredFields.filter(S=>S.required&&!n[S.id]).map(S=>S.name);if(l.length>0)throw new Error(`Missing required fields: ${l.join(", ")}`);let d=[{id:"client",name:e.name,role:"client",signatureMethod:"digital",status:"pending"},{id:"company_rep",name:"Representante Legal",role:"representative",signatureMethod:"digital",status:"pending"}];e.market==="edomex"&&t==="contrato_venta_plazo_colectivo"&&d.push({id:"route_rep",name:"Representante de la Ruta",role:"witness",signatureMethod:"physical",status:"pending"});let g={id:`contract-${Date.now()}-${e.id}`,clientId:e.id,clientName:e.name,templateId:s.id,contractType:t,market:e.market||"aguascalientes",flow:e.flow,contractData:n,status:"draft",createdDate:new Date,signatories:d,legalNotes:this.generateLegalNotes(t,e.market||"aguascalientes",e.flow)};return _(g).pipe(Q(500))}getPopulatedContract(e){return _(`
      <div class="contract-document">
        <h1>CONTRATO DE VENTA A PLAZO</h1>
        <p>Entre [CLIENTE_NOMBRE] y [EMPRESA_NOMBRE]...</p>
        <div class="contract-content">
          <!-- Contenido del contrato poblado con datos reales -->
        </div>
        <div class="signatures">
          <div class="signature-block">
            <p>Firma del Cliente</p>
            <div class="signature-line"></div>
          </div>
          <div class="signature-block">
            <p>Representante Legal</p>
            <div class="signature-line"></div>
          </div>
        </div>
      </div>
    `).pipe(Q(300))}processSignature(e,t,n,s="digital"){let l={id:e,clientId:"client-123",clientName:"Cliente Ejemplo",templateId:"template-1",contractType:"contrato_venta_plazo_individual",market:"edomex",flow:V.VentaPlazo,contractData:{},status:"signed",createdDate:new Date,signedDate:new Date,signatories:[{id:t,name:"Cliente Ejemplo",role:"client",signatureDate:new Date,signatureMethod:s,signatureData:n,status:"signed"}]};return _({success:!0,contract:l}).pipe(Q(400))}getClientContracts(e){return _([]).pipe(Q(200))}getExecutionRequirements(e,t){let n={requiredDocuments:this.getRequiredDocumentsForExecution(e,t),requiredApprovals:this.getRequiredApprovalsForExecution(e,t),executionSteps:this.getExecutionSteps(e,t),estimatedTimeframe:this.getEstimatedTimeframe(e)};return _(n).pipe(Q(200))}executeContract(e,t){let n={success:!0,executionDate:new Date,legalReference:`REF-${Date.now()}`};return _(n).pipe(Q(300))}initializeContractTemplates(){this.contractTemplates=[{id:"ags-promesa-compraventa",name:"Promesa de Compraventa - AGS",type:"promesa_compraventa",market:"aguascalientes",flow:V.VentaDirecta,template:"<div>Template for AGS promesa compraventa</div>",requiredFields:[{id:"cliente_nombre",name:"Nombre del Cliente",type:"text",required:!0,description:"Nombre completo del cliente"},{id:"vehiculo_tipo",name:"Tipo de Veh\xEDculo",type:"text",required:!0,description:"Vagoneta H6C 19 Pasajeros"},{id:"precio_total",name:"Precio Total",type:"currency",required:!0,description:"Precio total del veh\xEDculo"},{id:"enganche",name:"Enganche",type:"currency",required:!0,description:"Monto del enganche (50%)"}],version:"1.0",effectiveDate:new Date("2024-01-01"),status:"active"},{id:"ags-venta-plazo",name:"Contrato Venta a Plazo - AGS",type:"contrato_venta_plazo_individual",market:"aguascalientes",flow:V.VentaPlazo,template:"<div>Template for AGS venta plazo</div>",requiredFields:[{id:"cliente_nombre",name:"Nombre del Cliente",type:"text",required:!0,description:"Nombre completo del cliente"},{id:"precio_total",name:"Precio Total",type:"currency",required:!0,description:"Precio total del veh\xEDculo"},{id:"enganche",name:"Enganche",type:"currency",required:!0,description:"Enganche 60%"},{id:"plazo_meses",name:"Plazo en Meses",type:"number",required:!0,description:"12 o 24 meses"},{id:"pago_mensual",name:"Pago Mensual",type:"currency",required:!0,description:"Pago mensual calculado"},{id:"tasa_interes",name:"Tasa de Inter\xE9s",type:"percentage",required:!0,description:"25.5% anual"}],version:"1.0",effectiveDate:new Date("2024-01-01"),status:"active"},{id:"edomex-promesa-compraventa",name:"Promesa de Compraventa - EdoMex",type:"promesa_compraventa",market:"edomex",flow:V.VentaDirecta,template:"<div>Template for EdoMex promesa compraventa</div>",requiredFields:[{id:"cliente_nombre",name:"Nombre del Cliente",type:"text",required:!0,description:"Nombre completo del cliente"},{id:"ruta_nombre",name:"Nombre de la Ruta",type:"text",required:!0,description:"Ruta/ecosistema del cliente"},{id:"vehiculo_tipo",name:"Tipo de Veh\xEDculo",type:"text",required:!0,description:"Vagoneta H6C Ventanas"},{id:"precio_total",name:"Precio Total",type:"currency",required:!0,description:"Precio total con conversi\xF3n y bancas"},{id:"enganche",name:"Enganche",type:"currency",required:!0,description:"Monto del enganche (50%)"}],version:"1.0",effectiveDate:new Date("2024-01-01"),status:"active"},{id:"edomex-venta-plazo-individual",name:"Contrato Venta a Plazo Individual - EdoMex",type:"contrato_venta_plazo_individual",market:"edomex",flow:V.VentaPlazo,template:"<div>Template for EdoMex venta plazo individual</div>",requiredFields:[{id:"cliente_nombre",name:"Nombre del Cliente",type:"text",required:!0,description:"Nombre completo del cliente"},{id:"ruta_nombre",name:"Nombre de la Ruta",type:"text",required:!0,description:"Ruta/ecosistema del cliente"},{id:"precio_total",name:"Precio Total",type:"currency",required:!0,description:"Precio total con componentes"},{id:"enganche",name:"Enganche",type:"currency",required:!0,description:"Enganche 20-25%"},{id:"plazo_meses",name:"Plazo en Meses",type:"number",required:!0,description:"48 o 60 meses"},{id:"pago_mensual",name:"Pago Mensual",type:"currency",required:!0,description:"Pago mensual calculado"},{id:"tasa_interes",name:"Tasa de Inter\xE9s",type:"percentage",required:!0,description:"29.9% anual"}],version:"1.0",effectiveDate:new Date("2024-01-01"),status:"active"},{id:"edomex-venta-plazo-colectivo",name:"Contrato Cr\xE9dito Colectivo - EdoMex",type:"contrato_venta_plazo_colectivo",market:"edomex",flow:V.CreditoColectivo,template:"<div>Template for EdoMex cr\xE9dito colectivo</div>",requiredFields:[{id:"grupo_nombre",name:"Nombre del Grupo",type:"text",required:!0,description:"Nombre del grupo colectivo"},{id:"ruta_nombre",name:"Nombre de la Ruta",type:"text",required:!0,description:"Ruta/ecosistema del grupo"},{id:"miembros_count",name:"N\xFAmero de Miembros",type:"number",required:!0,description:"Entre 5 y 20 miembros"},{id:"precio_total",name:"Precio Total",type:"currency",required:!0,description:"Precio total con componentes"},{id:"enganche",name:"Enganche",type:"currency",required:!0,description:"Enganche 15-20%"},{id:"plazo_meses",name:"Plazo en Meses",type:"number",required:!0,description:"60 meses fijo"},{id:"pago_mensual",name:"Pago Mensual",type:"currency",required:!0,description:"Pago mensual calculado"}],version:"1.0",effectiveDate:new Date("2024-01-01"),status:"active"},{id:"edomex-convenio-dacion",name:"Convenio de Daci\xF3n en Pago - EdoMex",type:"convenio_dacion_pago",market:"edomex",flow:V.VentaPlazo,template:"<div>Template for EdoMex convenio daci\xF3n en pago</div>",requiredFields:[{id:"cliente_nombre",name:"Nombre del Cliente",type:"text",required:!0,description:"Nombre completo del cliente"},{id:"ruta_nombre",name:"Nombre de la Ruta",type:"text",required:!0,description:"Ruta/ecosistema del cliente"},{id:"vehiculo_actual",name:"Veh\xEDculo Actual",type:"text",required:!0,description:"Veh\xEDculo que se da en pago"},{id:"valor_dacion",name:"Valor de Daci\xF3n",type:"currency",required:!0,description:"Valor del veh\xEDculo en daci\xF3n"}],version:"1.0",effectiveDate:new Date("2024-01-01"),status:"active"}]}initializeFlowRules(){this.flowRules=[{market:"aguascalientes",flow:V.VentaDirecta,stage:"initial",requiredContract:"promesa_compraventa",description:"Promesa de compraventa para compra de contado en AGS",triggerCondition:"Al momento de solicitud"},{market:"aguascalientes",flow:V.VentaDirecta,stage:"post_payment",requiredContract:"contrato_compraventa",description:"Contrato de compraventa tras aportaci\xF3n inicial",triggerCondition:"Despu\xE9s de enganche 50%"},{market:"aguascalientes",flow:V.VentaPlazo,stage:"initial",requiredContract:"contrato_venta_plazo_individual",description:"Contrato de venta a plazo individual para AGS",triggerCondition:"Despu\xE9s de validaci\xF3n documental"},{market:"edomex",flow:V.VentaDirecta,stage:"initial",requiredContract:"promesa_compraventa",description:"Promesa de compraventa para compra de contado en EdoMex",triggerCondition:"Al momento de solicitud"},{market:"edomex",flow:V.VentaDirecta,stage:"post_payment",requiredContract:"contrato_compraventa",description:"Contrato de compraventa tras aportaci\xF3n inicial",triggerCondition:"Despu\xE9s de enganche 50%"},{market:"edomex",flow:V.VentaPlazo,stage:"initial",requiredContract:"contrato_venta_plazo_individual",description:"Contrato de venta a plazo individual para EdoMex",triggerCondition:"Despu\xE9s de validaci\xF3n documental y ecosistema"},{market:"edomex",flow:V.VentaPlazo,stage:"post_onboarding",requiredContract:"convenio_dacion_pago",description:"Convenio de daci\xF3n en pago despu\xE9s del onboarding",triggerCondition:"Despu\xE9s de completar onboarding en EdoMex"},{market:"edomex",flow:V.CreditoColectivo,stage:"initial",requiredContract:"contrato_venta_plazo_colectivo",description:"Contrato de cr\xE9dito colectivo para EdoMex",triggerCondition:"Despu\xE9s de formar grupo y validar ecosistema"}]}generateLegalNotes(e,t,n){let s=[];return t==="edomex"&&(s.push("Aplican regulaciones espec\xEDficas del Estado de M\xE9xico"),s.push("Requiere validaci\xF3n de ecosistema/ruta"),e==="convenio_dacion_pago"&&(s.push("Este convenio es obligatorio para EdoMex post-onboarding"),s.push("El veh\xEDculo dado en pago debe tener documentaci\xF3n en regla"))),e==="contrato_venta_plazo_colectivo"&&(s.push("Todos los miembros del grupo son solidariamente responsables"),s.push("El incumplimiento de un miembro afecta a todo el grupo")),s.push("Este contrato se rige por las leyes mexicanas"),s.push("Cualquier disputa ser\xE1 resuelta en tribunales competentes"),s}getRequiredDocumentsForExecution(e,t){let n=["Identificaci\xF3n oficial","Comprobante de domicilio"];return t==="edomex"&&n.push("Carta Aval de Ruta","Acta Constitutiva de la Ruta"),e.includes("colectivo")&&n.push("Acta de constituci\xF3n del grupo","Identificaciones de todos los miembros"),n}getRequiredApprovalsForExecution(e,t){let n=["Aprobaci\xF3n crediticia","Validaci\xF3n documental"];return t==="edomex"&&n.push("Validaci\xF3n de ecosistema"),e==="contrato_venta_plazo_colectivo"&&n.push("Aprobaci\xF3n del grupo colectivo"),n}getExecutionSteps(e,t){let n=["1. Revisi\xF3n y validaci\xF3n de documentos","2. Firma de todas las partes","3. Registro en sistema legal"];return t==="edomex"&&e==="convenio_dacion_pago"&&(n.push("4. Valoraci\xF3n del veh\xEDculo en daci\xF3n"),n.push("5. Transferencia de propiedad")),n}getEstimatedTimeframe(e){switch(e){case"promesa_compraventa":return"1-2 d\xEDas h\xE1biles";case"contrato_compraventa":return"2-3 d\xEDas h\xE1biles";case"contrato_venta_plazo_individual":return"3-5 d\xEDas h\xE1biles";case"contrato_venta_plazo_colectivo":return"5-7 d\xEDas h\xE1biles";case"convenio_dacion_pago":return"7-10 d\xEDas h\xE1biles";default:return"3-5 d\xEDas h\xE1biles"}}assignVehicleToContract(e,t){console.log("\u{1F69B} Asignando unidad espec\xEDfica al contrato:",{contractId:e,vin:t.vin,modelo:t.modelo,year:t.year});try{let n=this.getContractById(e);if(!n)return _({success:!1,error:`Contrato ${e} no encontrado`});let s=D(M({},n),{assignedVehicle:t,vehicleAssignedDate:new Date,contractData:D(M({},n.contractData),{vehiculo_vin:t.vin,vehiculo_serie:t.serie,vehiculo_modelo:t.modelo,vehiculo_year:t.year,vehiculo_color:t.color,vehiculo_numero_motor:t.numeroMotor,vehiculo_combustible:t.fuelType,vehiculo_transmision:t.transmission,vehiculo_lote_produccion:t.productionBatch,vehiculo_planta:t.factoryLocation})});return this.saveUpdatedContract(s),console.log("\u2705 Unidad asignada al contrato exitosamente:",{contractId:e,vehicleId:t.id,vin:t.vin,assignedAt:s.vehicleAssignedDate}),_({success:!0,contract:s})}catch(n){return console.error("\u274C Error asignando unidad al contrato:",n),_({success:!1,error:`Error interno: ${n.message}`})}}getContractById(e){return{id:e,clientId:"client-123",clientName:"Cliente Ejemplo",templateId:"template-1",contractType:"contrato_venta_plazo_individual",market:"aguascalientes",flow:V.VentaPlazo,contractData:{cliente_nombre:"Cliente Ejemplo",precio_total:85e4,enganche:51e4,plazo_meses:24,pago_mensual:25e3,tasa_interes:25.5},status:"signed",createdDate:new Date(Date.now()-2592e6),signedDate:new Date(Date.now()-1296e6),signatories:[{id:"client-sig",name:"Cliente Ejemplo",role:"client",signatureDate:new Date(Date.now()-1296e6),signatureMethod:"digital",status:"signed"}]}}saveUpdatedContract(e){console.log("\u{1F4BE} Contrato actualizado guardado:",{id:e.id,assignedVehicle:e.assignedVehicle?.vin,vehicleAssignedDate:e.vehicleAssignedDate})}getContractsWithAssignedVehicles(){return console.log("\u{1F50D} Obteniendo contratos con unidades asignadas"),_([]).pipe(Q(200))}getVehicleFromContract(e){console.log("\u{1F50D} Obteniendo informaci\xF3n de veh\xEDculo del contrato:",e);let t=this.getContractById(e);return _(t.assignedVehicle||null).pipe(Q(100))}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var Ke=(()=>{class i{constructor(){this.http=R(te),this.contractTriggersService=R(Ue),this.deliveriesService=R(qe),this.importWhatsAppService=R(Ye),this.vehicleAssignmentService=R(Xe),this.contractService=R(Je),this.baseUrl=window.__BFF_BASE__??"/api",this.importStatusCache$=new ue(new Map),this.initializeIntegration()}initializeIntegration(){this.contractTriggersService.getTriggerHistory(10).subscribe(e=>{e.forEach(t=>{t.deliveryOrderCreated&&t.deliveryOrderId&&this.syncImportStatusWithDeliveryOrder(t.deliveryOrderId,t.clientId)})})}getIntegratedImportStatus(e){return fe([this.http.get(`${this.baseUrl}/v1/clients/${e}/import-status`).pipe(v(()=>_(null))),this.contractTriggersService.getTriggerHistory(50).pipe(w(t=>t.filter(n=>n.clientId===e))),this.deliveriesService.list({clientId:e,limit:10}).pipe(w(t=>t.items),v(()=>_([])))]).pipe(w(([t,n,s])=>{if(!t)return null;let l=s[0],d=n[0],g=D(M({},t),{triggerHistory:n,deliveryOrderId:l?.id,contractId:d?.contractId,syncStatus:this.determineSyncStatus(t,s,n),lastSyncDate:new Date,estimatedDeliveryDate:this.calculateEstimatedDeliveryDate(t),actualDeliveryDate:l?.updatedAt?new Date(l.updatedAt):void 0}),S=this.importStatusCache$.value;return S.set(e,g),this.importStatusCache$.next(S),g}),v(()=>_(null)))}updateImportMilestone(e,t,n,s){return this.http.patch(`${this.baseUrl}/v1/clients/${e}/import-status`,{milestone:t,status:n,metadata:D(M({},s),{updatedBy:"integrated_tracker",updatedAt:new Date().toISOString()})}).pipe(O(l=>{this.recordMilestoneEvent(e,t,n,s),this.syncMilestoneWithDeliveryOrder(e,t,n),t==="unidadFabricada"&&n==="completed"&&this.triggerVehicleAssignmentFlow(e,s),this.sendMilestoneNotifications(e,t,n,l,s)}),w(l=>D(M({},l),{syncStatus:"synced",lastSyncDate:new Date})),v(()=>_({})))}onTriggerCreatedDeliveryOrder(e,t){return!e.clientId||!t.id?_():(console.log(`\u{1F517} Integrando trigger ${e.id} con import tracker para cliente ${e.clientId}`),this.initializeImportTrackingForDeliveryOrder(e.clientId,t).pipe(O(()=>{this.refreshImportStatusCache(e.clientId),this.importWhatsAppService.sendDeliveryUpdateNotification(e.clientId,t.id,"order_created",{clientName:"Cliente",market:t.market}).subscribe({next:n=>{n.success&&console.log(`\u2705 Notificaci\xF3n WhatsApp enviada para nueva orden: ${n.messageId}`)},error:n=>{console.error("Error enviando notificaci\xF3n WhatsApp:",n)}})}),w(()=>{}),v(n=>(console.error("Error integrando trigger con import tracker:",n),_(void 0)))))}initializeImportTrackingForDeliveryOrder(e,t){let n={pedidoPlanta:{status:"in_progress",startedAt:new Date,estimatedDays:3},unidadFabricada:{status:"pending",estimatedDays:30},transitoMaritimo:{status:"pending",estimatedDays:21},enAduana:{status:"pending",estimatedDays:7},liberada:{status:"pending",estimatedDays:2}};return this.http.post(`${this.baseUrl}/v1/clients/${e}/import-status`,D(M({},n),{deliveryOrderId:t.id,createdBy:"automatic_trigger",createdAt:new Date().toISOString(),metadata:{triggerSource:"contract_payment_threshold",market:t.market,sku:t.sku}})).pipe(O(s=>{console.log(`\u2705 Import tracking inicializado para cliente ${e}, orden ${t.id}`),this.recordMilestoneEvent(e,"pedidoPlanta","in_progress",{notes:"Tracking iniciado autom\xE1ticamente por trigger de contrato",estimatedDate:new Date(Date.now()+3*24*60*60*1e3)})}),v(()=>_({})))}syncImportStatusWithDeliveryOrder(e,t){return this.deliveriesService.get(e).pipe(O(n=>{let s=this.mapDeliveryStatusToImportMilestones(n.status);s&&this.updateImportMilestone(t,s.milestone,s.status,{notes:`Actualizado autom\xE1ticamente desde orden de entrega ${e}`,actualDate:s.actualDate}).subscribe()}),w(()=>{}),v(()=>_(void 0)))}syncMilestoneWithDeliveryOrder(e,t,n){return this.getDeliveryOrderForClient(e).pipe(O(s=>{if(!s)return;let l=this.mapImportMilestoneToDeliveryStatus(t,n);if(l&&s.status!==l){let g={PO_ISSUED:"ISSUE_PO",IN_PRODUCTION:"START_PROD",READY_AT_FACTORY:"FACTORY_READY",AT_ORIGIN_PORT:"LOAD_ORIGIN",ON_VESSEL:"DEPART_VESSEL",AT_DEST_PORT:"ARRIVE_DEST",IN_CUSTOMS:"CUSTOMS_CLEAR",RELEASED:"RELEASE",AT_WH:"ARRIVE_WH",READY_FOR_HANDOVER:"SCHEDULE_HANDOVER"}[l];g&&this.deliveriesService.transition(s.id,{event:g,meta:{milestone:t,updatedFromImportTracker:!0}}).subscribe()}}),w(()=>{}),v(()=>_(void 0)))}getImportTrackerMetrics(){return this.http.get(`${this.baseUrl}/v1/import-tracker/metrics`).pipe(v(()=>_({totalActiveImports:0,averageTransitTime:0,onTimeDeliveryRate:0,delayedImports:0,milestoneStats:{},monthlyImportVolume:[],delayTrends:[]})))}getImportMilestoneHistory(e,t=50){return this.http.get(`${this.baseUrl}/v1/clients/${e}/import-milestones`,{params:{limit:t.toString()}}).pipe(v(()=>_([])))}generateIntegratedTrackingReport(e){return fe([this.getIntegratedImportStatus(e),this.deliveriesService.list({clientId:e}),this.contractTriggersService.getTriggerHistory(100),this.getImportMilestoneHistory(e)]).pipe(w(([t,n,s,l])=>{let d=s.filter(S=>S.clientId===e),g={client:{id:e},importStatus:t,deliveryOrders:n.items,triggerHistory:d,milestoneHistory:l,timeline:this.generateIntegratedTimeline(t,n.items,d,l)};return{reportUrl:`${this.baseUrl}/v1/reports/integrated-tracking/${e}`,reportData:g}}),v(()=>_({reportUrl:`${this.baseUrl}/v1/reports/integrated-tracking/${e}`,reportData:{client:{id:e},importStatus:null,deliveryOrders:[],triggerHistory:[],milestoneHistory:[],timeline:[]}})))}determineSyncStatus(e,t,n){let s=t.length>0,l=n.some(d=>d.deliveryOrderCreated);return s&&l?"synced":l&&!s?"error":"pending"}calculateEstimatedDeliveryDate(e){let t=0,n=["pedidoPlanta","unidadFabricada","transitoMaritimo","enAduana","liberada"];for(let l of n){let d=e[l];d&&d.status==="pending"&&(t+=d.estimatedDays||0)}let s=new Date;return s.setDate(s.getDate()+t),s}mapDeliveryStatusToImportMilestones(e){let n={PO_ISSUED:{milestone:"pedidoPlanta",status:"completed"},IN_PRODUCTION:{milestone:"unidadFabricada",status:"in_progress"},READY_AT_FACTORY:{milestone:"unidadFabricada",status:"completed"},AT_ORIGIN_PORT:{milestone:"transitoMaritimo",status:"in_progress"},ON_VESSEL:{milestone:"transitoMaritimo",status:"in_progress"},AT_DEST_PORT:{milestone:"transitoMaritimo",status:"completed"},IN_CUSTOMS:{milestone:"enAduana",status:"in_progress"},RELEASED:{milestone:"enAduana",status:"completed"},AT_WH:{milestone:"liberada",status:"in_progress"},READY_FOR_HANDOVER:{milestone:"liberada",status:"completed"}}[e];return n?D(M({},n),{actualDate:new Date}):null}mapImportMilestoneToDeliveryStatus(e,t){return t==="pending"?null:{pedidoPlanta:{in_progress:"PO_ISSUED",completed:"PO_ISSUED"},unidadFabricada:{in_progress:"IN_PRODUCTION",completed:"READY_AT_FACTORY"},transitoMaritimo:{in_progress:"ON_VESSEL",completed:"AT_DEST_PORT"},enAduana:{in_progress:"IN_CUSTOMS",completed:"RELEASED"},liberada:{in_progress:"AT_WH",completed:"READY_FOR_HANDOVER"}}[e]?.[t]||null}getDeliveryOrderForClient(e){return this.deliveriesService.list({clientId:e,limit:1}).pipe(w(t=>t.items[0]||null),v(()=>_(null)))}recordMilestoneEvent(e,t,n,s){let l={id:`milestone-${Date.now()}-${e}-${t}`,clientId:e,milestone:t,previousStatus:"pending",newStatus:n,timestamp:new Date,triggeredBy:"manual",metadata:s,notificationsSent:{client:!1,advisor:!1,whatsapp:!1}};return this.http.post(`${this.baseUrl}/v1/clients/${e}/import-milestones`,l).pipe(v(()=>_(void 0)))}sendMilestoneNotifications(e,t,n,s,l){n!=="pending"&&this.getClientData(e).subscribe({next:d=>{this.importWhatsAppService.sendMilestoneNotification(e,t,n,s,d).subscribe({next:g=>{g.success?console.log(`\u2705 Notificaci\xF3n WhatsApp enviada para milestone ${t}: ${g.messageId}`):console.warn(`\u26A0\uFE0F Notificaci\xF3n WhatsApp fall\xF3 para milestone ${t}: ${g.errorMessage}`)},error:g=>{console.error("\u274C Error enviando notificaci\xF3n WhatsApp de milestone:",g)}})},error:d=>{console.error("Error obteniendo datos del cliente para notificaci\xF3n:",d)}})}getClientData(e){return this.http.get(`${this.baseUrl}/v1/clients/${e}`).pipe(v(()=>_({id:e,name:"Cliente",phone:"",market:"aguascalientes"})))}refreshImportStatusCache(e){this.getIntegratedImportStatus(e).subscribe()}generateIntegratedTimeline(e,t,n,s){let l=[];return n.forEach(d=>{l.push({type:"trigger",date:d.triggerDate,title:`Trigger Activado: ${d.eventType}`,description:`Umbral alcanzado: ${d.triggerPercentage}%`,success:d.deliveryOrderCreated})}),t.forEach(d=>{l.push({type:"delivery_order",date:d.createdAt,title:"Orden de Entrega Creada",description:`Orden ${d.id}`,success:!0})}),s.forEach(d=>{l.push({type:"milestone",date:d.timestamp,title:`Milestone: ${d.milestone}`,description:`Estado: ${d.newStatus}`,success:d.newStatus==="completed"})}),l.sort((d,g)=>new Date(d.date).getTime()-new Date(g.date).getTime())}triggerVehicleAssignmentFlow(e,t){console.log("\u{1F69B} Triggering vehicle assignment flow for client:",e),console.log("\u{1F4CB} Unidad fabricada completada - Lista para asignaci\xF3n:",{clientId:e,completedAt:t?.actualDate||new Date,notes:t?.notes}),this.sendUnitReadyNotification(e,t)}sendUnitReadyNotification(e,t){let n={type:"UNIT_READY_FOR_ASSIGNMENT",clientId:e,message:"La unidad ha completado fabricaci\xF3n y est\xE1 lista para asignaci\xF3n de datos espec\xEDficos (VIN, Serie, N\xFAmero de Motor)",timestamp:new Date,metadata:{completedAt:t?.actualDate||new Date,notes:t?.notes||"Unidad fabricada - Pendiente asignaci\xF3n de datos espec\xEDficos"}};console.log("\u{1F4E7} Unit ready notification sent:",n)}assignVehicleToClient(e,t){return console.log("\u{1F69B} Assigning vehicle to client through integrated tracker:",e),this.getIntegratedImportStatus(e).pipe(w(n=>{if(!n||n.unidadFabricada.status!=="completed")throw new Error('El cliente debe tener el milestone "unidadFabricada" completado para asignar unidad');return n}),O(()=>{let n={clientId:e,vin:t.vin,serie:t.serie,modelo:t.modelo,year:t.year,numeroMotor:t.numeroMotor,transmission:t.transmission,productionBatch:t.productionBatch,factoryLocation:t.factoryLocation,assignedBy:t.assignedBy,notes:t.notes},s=this.vehicleAssignmentService.validateVehicleData(n);if(!s.valid)throw new Error(`Datos de veh\xEDculo inv\xE1lidos: ${s.errors.join(", ")}`);this.vehicleAssignmentService.assignVehicleToClient(n).subscribe({next:l=>{l.success&&l.assignedUnit?(console.log("\u2705 Vehicle assigned successfully:",l.assignedUnit),this.updateImportStatusWithAssignedUnit(e,l.assignedUnit),this.updateContractWithAssignedVehicle(e,l.assignedUnit),this.sendVehicleAssignmentNotification(e,l.assignedUnit)):console.error("\u274C Vehicle assignment failed:",l.error)},error:l=>{console.error("\u274C Vehicle assignment error:",l)}})}),w(()=>({success:!0})),v(n=>(console.error("\u274C Assignment validation error:",n),_({success:!1,error:n.message}))))}updateImportStatusWithAssignedUnit(e,t){console.log("\u{1F4DD} Updating import status with assigned unit:",{clientId:e,unitId:t.id,vin:t.vin});let n=this.importStatusCache$.value,s=n.get(e);if(s){let l=D(M({},s),{assignedUnit:t,syncStatus:"synced",lastSyncDate:new Date});n.set(e,l),this.importStatusCache$.next(n),console.log("\u2705 Import status updated with assigned unit in cache")}}sendVehicleAssignmentNotification(e,t){let n={type:"VEHICLE_ASSIGNED",clientId:e,message:`Unidad asignada exitosamente: ${t.modelo} ${t.year}`,vehicleDetails:{vin:t.vin,serie:t.serie,modelo:t.modelo,year:t.year,numeroMotor:t.numeroMotor},timestamp:new Date};console.log("\u{1F389} Vehicle assignment notification sent:",n)}updateContractWithAssignedVehicle(e,t){console.log("\u{1F4DC} Actualizando contratos con unidad asignada:",{clientId:e,vin:t.vin,modelo:t.modelo}),this.contractService.getClientContracts(e).subscribe({next:n=>{if(n.length===0){console.log("\u2139\uFE0F No se encontraron contratos para el cliente:",e);return}console.log(`\u{1F50D} Encontrados ${n.length} contratos para actualizar`),n.forEach(s=>{s.assignedVehicle?console.log(`\u2139\uFE0F Contrato ${s.id} ya tiene unidad asignada: ${s.assignedVehicle.vin}`):this.contractService.assignVehicleToContract(s.id,t).subscribe({next:l=>{l.success?(console.log(`\u2705 Contrato ${s.id} actualizado con unidad ${t.vin}`),this.logContractVehicleAssignment(e,s.id,t)):console.error(`\u274C Error actualizando contrato ${s.id}:`,l.error)},error:l=>{console.error(`\u274C Error en asignaci\xF3n a contrato ${s.id}:`,l)}})})},error:n=>{console.error("\u274C Error obteniendo contratos del cliente:",n)}})}logContractVehicleAssignment(e,t,n){let s={type:"CONTRACT_VEHICLE_ASSIGNMENT",timestamp:new Date,clientId:e,contractId:t,vehicleData:{id:n.id,vin:n.vin,serie:n.serie,modelo:n.modelo,year:n.year,numeroMotor:n.numeroMotor},source:"integrated_import_tracker"};console.log("\u{1F4CA} Contract-Vehicle assignment logged:",s)}getClientContractsWithVehicles(e){return console.log("\u{1F50D} Obteniendo contratos con veh\xEDculos para cliente:",e),this.contractService.getClientContracts(e).pipe(w(t=>t.filter(n=>n.assignedVehicle)),O(t=>{console.log(`\u2705 Encontrados ${t.length} contratos con veh\xEDculos asignados`)}),v(t=>(console.error("\u274C Error obteniendo contratos con veh\xEDculos:",t),_([]))))}getCompleteAssignmentSummary(e){return console.log("\u{1F4CB} Generando resumen completo de asignaciones para cliente:",e),fe([this.getIntegratedImportStatus(e),this.getClientContractsWithVehicles(e)]).pipe(w(([t,n])=>{let s=this.validateAssignmentConsistency(t,n);return{importStatus:t,contractsWithVehicles:n,assignmentConsistency:s}}),O(t=>{console.log("\u{1F4CA} Resumen completo generado:",{clientId:e,hasAssignedUnit:!!t.importStatus?.assignedUnit,contractsWithVehicles:t.contractsWithVehicles.length,consistent:t.assignmentConsistency.consistent})}))}validateAssignmentConsistency(e,t){let n=[];if(!e)return{consistent:!1,issues:["No hay estado de importaci\xF3n"]};let s=!!e.assignedUnit,l=t.length>0;if(s&&!l&&n.push("Import status tiene unidad asignada pero contratos no est\xE1n actualizados"),!s&&l&&n.push("Contratos tienen unidades asignadas pero import status no"),s&&l){let d=e.assignedUnit.vin,g=t.filter(S=>S.assignedVehicle?.vin!==d);g.length>0&&n.push(`${g.length} contratos tienen VINs diferentes al import status`)}return{consistent:n.length===0,issues:n}}completeDeliveryPhase(e,t){return console.log("\u{1F4E6} Completing delivery phase for client:",e),this.updateImportMilestone(e,"entregada","completed",{actualDate:t.fechaEntrega,notes:`Entregado con od\xF3metro ${t.odometroEntrega} km`}).pipe(O(()=>{this.storeDeliveryData(e,t),this.sendDeliveryCompletionNotification(e,t)}))}completeDocumentsPhase(e,t){return console.log("\u{1F4DC} Completing legal documents phase for client:",e),this.updateImportMilestone(e,"documentosTransferidos","completed",{actualDate:t.fechaTransferencia,documents:[t.factura.filename,t.polizaSeguro.filename,...t.contratos?.map(n=>n.filename)||[]],notes:`Documentos transferidos - Titular: ${t.titular}`}).pipe(O(()=>{this.storeLegalDocuments(e,t),this.sendDocumentsCompletionNotification(e,t)}))}updateVehicleAssignment(e,t){return console.log("\u{1F504} Updating vehicle assignment for client",e,t),_({success:!0})}completePlatesPhase(e,t){return console.log("\u{1F697} Completing plates phase for client:",e),this.updateImportMilestone(e,"placasEntregadas","completed",{actualDate:t.fechaAlta,notes:`Placas entregadas: ${t.numeroPlacas} (${t.estado})`}).pipe(O(()=>{console.log("\u{1F3AF} ALL DELIVERY PHASES COMPLETED - TRIGGERING POST-SALES HANDOVER"),this.triggerPostSalesHandover(e,t)}),w(()=>({success:!0})),v(n=>(console.error("\u274C Error completing plates phase:",n),_({success:!1,error:n.message}))))}triggerPostSalesHandover(e,t){console.log("\u{1F680} TRIGGERING POST-SALES HANDOVER for client:",e),this.getIntegratedImportStatus(e).subscribe(n=>{if(!n||!n.assignedUnit){console.error("\u274C Cannot trigger handover: Missing import status or assigned unit");return}let s={event:"vehicle.delivered",timestamp:new Date,payload:{clientId:e,vehicle:{vin:n.assignedUnit.vin,modelo:n.assignedUnit.modelo,numeroMotor:n.assignedUnit.numeroMotor,odometer_km_delivery:n.deliveryData?.odometroEntrega||0,placas:t.numeroPlacas,estado:t.estado},contract:{id:n.contractId||"unknown",servicePackage:"basic",warranty_start:new Date,warranty_end:new Date(Date.now()+2*365*24*60*60*1e3)},contacts:{primary:{name:"Cliente",phone:"+52xxxxxxxxxx",email:"cliente@example.com"},whatsapp_optin:!0},delivery:n.deliveryData,legalDocuments:this.getLegalDocumentsFromCache(e),plates:t}};this.sendVehicleDeliveredEvent(s),this.initializePostSalesRecord(s),console.log("\u2705 POST-SALES HANDOVER COMPLETED - Vehicle delivered event sent")})}sendVehicleDeliveredEvent(e){console.log("\u{1F4E1} Sending vehicle.delivered event to Post-Sales API:",e),this.http.post(`${this.baseUrl}/events/vehicle-delivered`,e).subscribe({next:t=>{console.log("\u2705 Vehicle delivered event sent successfully:",t)},error:t=>{console.error("\u274C Failed to send vehicle delivered event:",t),this.storeFailedEvent(e,t)}})}initializePostSalesRecord(e){let t={id:`psr_${Date.now()}_${e.payload.vehicle.vin.substr(-6)}`,vin:e.payload.vehicle.vin,clientId:e.payload.clientId,postSalesAgent:"auto_assigned",warrantyStatus:"active",servicePackage:e.payload.contract.servicePackage,nextMaintenanceDate:new Date(Date.now()+7776e6),nextMaintenanceKm:e.payload.vehicle.odometer_km_delivery+5e3,odometroEntrega:e.payload.vehicle.odometer_km_delivery,createdAt:new Date,warrantyStart:e.payload.contract.warranty_start,warrantyEnd:e.payload.contract.warranty_end};this.storePostSalesRecord(t),console.log("\u{1F4CA} Post-sales record initialized:",t)}storeDeliveryData(e,t){let n=`delivery_${e}`;localStorage.setItem(n,JSON.stringify(t)),console.log("\u{1F4BE} Delivery data stored for client:",e)}storeLegalDocuments(e,t){let n=`legal_${e}`;localStorage.setItem(n,JSON.stringify(t)),console.log("\u{1F4CB} Legal documents stored for client:",e)}getLegalDocumentsFromCache(e){let t=`legal_${e}`,n=localStorage.getItem(t);return n?JSON.parse(n):null}storePostSalesRecord(e){let t=`postsales_${e.vin}`;localStorage.setItem(t,JSON.stringify(e)),this.http.post(`${this.baseUrl}/post-sales/record`,e).subscribe({next:n=>{console.log("\u2705 Post-sales record stored in API:",n)},error:n=>{console.error("\u274C Failed to store post-sales record:",n)}})}storeFailedEvent(e,t){let n=JSON.parse(localStorage.getItem("failed_events")||"[]");n.push({event:e,error:t.message,timestamp:new Date,retryCount:0}),localStorage.setItem("failed_events",JSON.stringify(n)),console.log("\u{1F4BE} Failed event stored for retry:",e.payload.vehicle.vin)}getPostSalesRecord(e){return this.http.get(`${this.baseUrl}/post-sales/${e}`).pipe(v(()=>{let t=`postsales_${e}`,n=localStorage.getItem(t);return _(n?JSON.parse(n):null)}))}canCompletePostSalesPhase(e,t){return this.getIntegratedImportStatus(e).pipe(w(n=>{if(!n)return{canComplete:!1,reason:"Import status no encontrado"};if(t==="entregada"){if(!n.liberada||n.liberada.status!=="completed")return{canComplete:!1,reason:'Debe completar fase "liberada" primero'};if(!n.assignedUnit)return{canComplete:!1,reason:"Debe tener unidad asignada"}}return t==="documentosTransferidos"&&(!n.entregada||n.entregada.status!=="completed")?{canComplete:!1,reason:'Debe completar fase "entregada" primero'}:t==="placasEntregadas"&&(!n.documentosTransferidos||n.documentosTransferidos.status!=="completed")?{canComplete:!1,reason:'Debe completar fase "documentosTransferidos" primero'}:{canComplete:!0}}))}sendDeliveryCompletionNotification(e,t){console.log("\u{1F4E7} Sending delivery completion notification:",e)}sendDocumentsCompletionNotification(e,t){console.log("\u{1F4E7} Sending documents completion notification:",e)}handleError(e="operation"){return t=>{console.error(`IntegratedImportTrackerService.${e} failed:`,t);let n="Error en el sistema de seguimiento integrado";return t.status===404?n="Informaci\xF3n de seguimiento no encontrada":t.status===403?n="No tienes permisos para acceder al seguimiento":t.status===400?n=t.error?.message||"Solicitud de seguimiento inv\xE1lida":t.status>=500&&(n="Error del servidor. Intenta m\xE1s tarde"),_(void 0)}}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function rn(i,u){if(i&1&&(o(0,"p",31),r(1),a()),i&2){let e,t=m();c(),b(" Orden: ",(e=t.integratedStatus())==null?null:e.deliveryOrderId," ")}}function sn(i,u){i&1&&k(0,"div",54)}function cn(i,u){i&1&&(o(0,"div",55)(1,"span",56),r(2,"\u2714\uFE0F"),a()())}function ln(i,u){if(i&1){let e=I();o(0,"button",57),x("click",function(n){y(e);let s=m().$implicit;return m().updateMilestone(s.key),C(n.stopPropagation())}),r(1," Actualizar "),a()}}function dn(i,u){if(i&1){let e=I();o(0,"button",58),x("click",function(n){y(e);let s=m().$implicit;return m().completeMilestone(s.key),C(n.stopPropagation())}),r(1," Completar "),a()}}function pn(i,u){if(i&1&&(o(0,"div",59)(1,"span"),r(2,"\u{1F4C5}"),a(),o(3,"span"),r(4),a()()),i&2){let e=m().$implicit,t=m();c(4),b("Completado ",t.getCompletionDate(e.key),"")}}function mn(i,u){if(i&1&&(o(0,"div",60)(1,"span",61),r(2,"\u23F3"),a(),o(3,"span"),r(4),a()()),i&2){let e=m().$implicit,t=m();c(4),b("En progreso desde ",t.getStartDate(e.key),"")}}function un(i,u){if(i&1&&(o(0,"li"),r(1),a()),i&2){let e=u.$implicit;c(),f(e)}}function gn(i,u){if(i&1&&(o(0,"div",73)(1,"span",74),r(2),a(),o(3,"span",75),r(4),a()()),i&2){let e=u.$implicit;c(2),b("",e.role,":"),c(2),W("",e.name," - ",e.phone,"")}}function fn(i,u){if(i&1&&(o(0,"div",76)(1,"div",2)(2,"span",48),r(3),a(),o(4,"span",77),r(5),ce(6,"date"),a()()()),i&2){let e=u.$implicit;c(3),f(e.description),c(2),f(le(6,2,e.timestamp,"short"))}}function hn(i,u){if(i&1&&(o(0,"div",62)(1,"div",63)(2,"div",64)(3,"h5",65),r(4,"Documentos Requeridos"),a(),o(5,"ul",66),h(6,un,2,1,"li",67),a()(),o(7,"div",64)(8,"h5",65),r(9,"Contactos Relevantes"),a(),o(10,"div",68),h(11,gn,5,3,"div",69),a()()(),o(12,"div",70)(13,"h5",65),r(14,"Historial de Acciones"),a(),o(15,"div",71),h(16,fn,7,5,"div",72),a()()()),i&2){let e=m().$implicit,t=m();c(6),p("ngForOf",t.getMilestoneDocuments(e.key)),c(5),p("ngForOf",t.getMilestoneContacts(e.key)),c(5),p("ngForOf",t.getMilestoneActions(e.key))}}function vn(i,u){if(i&1){let e=I();o(0,"div",32),x("click",function(){let n=y(e).$implicit,s=m();return C(s.onMilestoneClick(n))}),o(1,"div",33)(2,"div",34)(3,"span",35),r(4),a(),h(5,sn,1,0,"div",36)(6,cn,3,0,"div",37),a(),o(7,"div",38)(8,"div",39)(9,"h4",40),r(10),a(),o(11,"div",41),h(12,ln,2,0,"button",42)(13,dn,2,0,"button",43),a()(),o(14,"p",44),r(15),a(),o(16,"div",45)(17,"div",46)(18,"span",47),r(19,"\u23F1\uFE0F"),a(),o(20,"span",48),r(21),a()(),h(22,pn,5,1,"div",49)(23,mn,5,1,"div",50),a()(),o(24,"div",51)(25,"span",52),r(26),a()()(),h(27,hn,17,3,"div",53),a()}if(i&2){let e=u.$implicit,t=u.index,n=m();P(n.getMilestoneClass(e,t)),c(2),P(n.getMilestoneCircleClass(e)),c(2),f(e.icon),c(),p("ngIf",n.getMilestoneStatus(e)==="in-progress"),c(),p("ngIf",n.getMilestoneStatus(e)==="completed"),c(4),f(e.label),c(2),p("ngIf",n.getMilestoneStatus(e)==="pending"&&n.canUpdate(e)),c(),p("ngIf",n.getMilestoneStatus(e)==="in-progress"),c(2),f(e.description),c(6),b("",e.estimatedDays," d\xEDas estimados"),c(),p("ngIf",n.getMilestoneStatus(e)==="completed"),c(),p("ngIf",n.getMilestoneStatus(e)==="in-progress"),c(2),P(n.getStatusBadgeClass(e)),c(),b(" ",n.getStatusText(e)," "),c(),p("ngIf",n.selectedMilestone===e.key)}}var Ze=(()=>{class i{constructor(){this.onUpdateMilestone=new se,this.destroy$=new B,this.integratedTrackerService=R(Ke),this.integratedStatus=K(null),this.loading=K(!1),this.computedImportStatus=N(()=>{let e=this.integratedStatus();return e?{pedidoPlanta:e.pedidoPlanta,unidadFabricada:e.unidadFabricada,transitoMaritimo:e.transitoMaritimo,enAduana:e.enAduana,liberada:e.liberada}:this.client?.importStatus}),this.milestones=[{key:"pedidoPlanta",label:"Pedido a Planta",description:"Solicitud de fabricaci\xF3n enviada a la planta manufacturera",icon:"\u{1F4DD}",estimatedDays:3,color:"blue"},{key:"unidadFabricada",label:"Unidad Fabricada",description:"La unidad ha sido completamente fabricada y est\xE1 lista para env\xEDo",icon:"\u{1F3ED}",estimatedDays:30,color:"purple"},{key:"transitoMaritimo",label:"Tr\xE1nsito Mar\xEDtimo",description:"La unidad est\xE1 en tr\xE1nsito mar\xEDtimo hacia el puerto de destino",icon:"\u{1F6A2}",estimatedDays:21,color:"blue"},{key:"enAduana",label:"En Aduana",description:"Procesando documentos aduaneros y tr\xE1mites de importaci\xF3n",icon:"\u{1F6C3}",estimatedDays:7,color:"amber"},{key:"liberada",label:"Liberada",description:"Unidad liberada de aduana y lista para entrega final",icon:"\u2705",estimatedDays:2,color:"emerald"}]}ngOnInit(){this.client?.id&&this.loadIntegratedStatus()}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}loadIntegratedStatus(){this.client?.id&&(this.loading.set(!0),this.integratedTrackerService.getIntegratedImportStatus(this.client.id).pipe(oe(this.destroy$)).subscribe({next:e=>{this.integratedStatus.set(e),this.loading.set(!1)},error:e=>{console.error("Error loading integrated import status:",e),this.loading.set(!1)}}))}getMilestoneStatus(e){let t=this.computedImportStatus();if(!t)return"pending";let n=t[e.key];return n?.status==="completed"?"completed":n?.status==="in_progress"?"in-progress":"pending"}getMilestoneClass(e,t){let s=`milestone-item ${this.getMilestoneStatus(e)}`;return this.selectedMilestone===e.key?`${s} selected`:s}getMilestoneCircleClass(e){return`milestone-circle ${this.getMilestoneStatus(e)}`}getStatusBadgeClass(e){return`status-badge ${this.getMilestoneStatus(e)}`}getStatusText(e){let t=this.getMilestoneStatus(e);return{completed:"Completado","in-progress":"En Progreso",pending:"Pendiente"}[t]}getOverallProgress(){let e=this.milestones.length,t=this.milestones.filter(s=>this.getMilestoneStatus(s)==="completed").length,n=this.milestones.filter(s=>this.getMilestoneStatus(s)==="in-progress").length;return Math.round((t+n*.5)/e*100)}getOverallStatus(){let e=this.getOverallProgress();return e===100?"Entregada":e>0?"En Tr\xE1nsito":"Pendiente Fabricaci\xF3n"}getOverallStatusClass(){let e=this.getOverallProgress();return e===100?"status-indicator completed":e>0?"status-indicator in-transit":"status-indicator delayed"}getStatusDotClass(){let e=this.getOverallProgress();return e===100?"status-dot completed":e>0?"status-dot active":"status-dot delayed"}getCompletedMilestones(){return this.milestones.filter(e=>this.getMilestoneStatus(e)==="completed").length}getEstimatedDaysRemaining(){return this.milestones.filter(t=>this.getMilestoneStatus(t)==="pending").reduce((t,n)=>t+n.estimatedDays,0)}getExpectedDeliveryDate(){let e=this.getEstimatedDaysRemaining(),t=new Date;return t.setDate(t.getDate()+e),t.toLocaleDateString("es-MX",{month:"short",day:"numeric",year:"numeric"})}canUpdate(e){let t=this.milestones.findIndex(s=>s.key===e.key);if(t===0)return!0;let n=this.milestones[t-1];return this.getMilestoneStatus(n)==="completed"}updateMilestone(e){this.client?.id&&(this.loading.set(!0),this.integratedTrackerService.updateImportMilestone(this.client.id,e,"in_progress",{notes:"Milestone actualizado desde Import Tracker",estimatedDate:new Date}).pipe(oe(this.destroy$)).subscribe({next:t=>{this.integratedStatus.set(t),this.onUpdateMilestone.emit(e),this.loading.set(!1)},error:t=>{console.error("Error updating milestone:",t),this.loading.set(!1)}}))}completeMilestone(e){this.client?.id&&(this.loading.set(!0),this.integratedTrackerService.updateImportMilestone(this.client.id,e,"completed",{notes:"Milestone completado desde Import Tracker",actualDate:new Date}).pipe(oe(this.destroy$)).subscribe({next:t=>{this.integratedStatus.set(t),this.onUpdateMilestone.emit(e),this.loading.set(!1)},error:t=>{console.error("Error completing milestone:",t),this.loading.set(!1)}}))}onMilestoneClick(e){this.selectedMilestone=this.selectedMilestone===e.key?void 0:e.key}getCompletionDate(e){let t=this.client?.importStatus?.[e];return t?.completedAt?new Date(t.completedAt).toLocaleDateString("es-MX",{month:"short",day:"numeric"}):""}getStartDate(e){let t=this.client?.importStatus?.[e];return t?.startedAt?new Date(t.startedAt).toLocaleDateString("es-MX",{month:"short",day:"numeric"}):""}getMilestoneDocuments(e){return{pedidoPlanta:["Orden de compra","Especificaciones t\xE9cnicas","Contrato de fabricaci\xF3n"],unidadFabricada:["Certificado de fabricaci\xF3n","Factura comercial","Packing list"],transitoMaritimo:["Bill of lading","Manifiesto de carga","Seguro de transporte"],enAduana:["Factura comercial","Certificado de origen","Pedimento de importaci\xF3n"],liberada:["Pedimento liberado","Certificado de inspecci\xF3n","Documentos de entrega"]}[e]||[]}getMilestoneContacts(e){return{pedidoPlanta:[{role:"Coordinador Planta",name:"Carlos M\xE9ndez",phone:"+52 55 1234-5678"}],unidadFabricada:[{role:"QC Manager",name:"Ana Garc\xEDa",phone:"+52 55 2345-6789"}],transitoMaritimo:[{role:"Agente Naviero",name:"Roberto S\xE1nchez",phone:"+52 55 3456-7890"}],enAduana:[{role:"Agente Aduanal",name:"Mar\xEDa L\xF3pez",phone:"+52 55 4567-8901"}],liberada:[{role:"Coordinador Entrega",name:"Juan Hern\xE1ndez",phone:"+52 55 5678-9012"}]}[e]||[]}getMilestoneActions(e){return[{description:"Etapa iniciada",timestamp:new Date},{description:"Documentos recibidos",timestamp:new Date}]}generateTrackingReport(){this.client?.id&&(this.loading.set(!0),this.integratedTrackerService.generateIntegratedTrackingReport(this.client.id).pipe(oe(this.destroy$)).subscribe({next:e=>{console.log("\u{1F4C4} Reporte de seguimiento integrado generado:",e),window.open(e.reportUrl,"_blank"),this.loading.set(!1)},error:e=>{console.error("Error generating integrated tracking report:",e),this.loading.set(!1)}}))}notifyClient(){this.client?.id&&console.log("\u{1F4F1} Notificando cliente sobre estado de importaci\xF3n")}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=$({type:i,selectors:[["app-import-tracker"]],inputs:{client:"client"},outputs:{onUpdateMilestone:"onUpdateMilestone"},standalone:!0,features:[z],decls:62,vars:14,consts:[[1,"import-tracker","bg-gray-900","rounded-xl","border","border-gray-800","p-6"],[1,"tracker-header","mb-6"],[1,"flex","items-center","justify-between"],[1,"flex","items-center","gap-3"],[1,"icon-container"],[1,"text-xl","font-bold","text-white"],[1,"text-sm","text-gray-400"],["class","text-xs text-blue-400",4,"ngIf"],[1,"status-indicator"],[1,"flex","items-center","gap-2","px-3","py-2","rounded-full"],[1,"status-dot","w-2","h-2","rounded-full","animate-pulse"],[1,"text-sm","font-medium"],[1,"timeline-container"],[1,"timeline-progress-bar","mb-8"],[1,"progress-track","w-full","h-2","bg-gray-700","rounded-full","relative"],[1,"progress-fill","h-2","bg-gradient-to-r","from-blue-500","to-emerald-500","rounded-full","transition-all","duration-500"],[1,"progress-percentage","absolute","-top-6","right-0","text-sm","font-medium","text-primary-cyan-400"],[1,"milestones-grid","space-y-4"],["class","milestone-item p-4 rounded-lg border transition-all duration-200",3,"class","click",4,"ngFor","ngForOf"],[1,"summary-stats","mt-6","grid","grid-cols-3","gap-4"],[1,"stat-card","p-4","bg-gradient-to-br","from-blue-500/10","to-blue-600/10","rounded-lg","border","border-blue-500/20"],[1,"stat-icon","text-2xl"],[1,"stat-value","text-xl","font-bold","text-blue-400"],[1,"stat-label","text-sm","text-gray-400"],[1,"stat-card","p-4","bg-gradient-to-br","from-amber-500/10","to-amber-600/10","rounded-lg","border","border-amber-500/20"],[1,"stat-value","text-xl","font-bold","text-amber-400"],[1,"stat-card","p-4","bg-gradient-to-br","from-emerald-500/10","to-emerald-600/10","rounded-lg","border","border-emerald-500/20"],[1,"stat-value","text-xl","font-bold","text-emerald-400"],[1,"tracker-actions","mt-6","flex","gap-3"],[1,"generate-report-btn","flex-1","px-4","py-3","bg-blue-600","hover:bg-blue-700","text-white","rounded-lg","font-medium","transition-colors","flex","items-center","justify-center","gap-2",3,"click"],[1,"notify-btn","px-6","py-3","bg-emerald-600","hover:bg-emerald-700","text-white","rounded-lg","font-medium","transition-colors","flex","items-center","gap-2",3,"click"],[1,"text-xs","text-blue-400"],[1,"milestone-item","p-4","rounded-lg","border","transition-all","duration-200",3,"click"],[1,"flex","items-center","gap-4"],[1,"milestone-circle","w-12","h-12","rounded-full","flex","items-center","justify-center","relative"],[1,"text-xl"],["class","absolute -top-1 -right-1 w-4 h-4 bg-amber-500 rounded-full animate-ping",4,"ngIf"],["class","absolute -top-1 -right-1 w-4 h-4 bg-emerald-500 rounded-full",4,"ngIf"],[1,"milestone-info","flex-1"],[1,"flex","items-center","justify-between","mb-2"],[1,"font-semibold","text-white"],[1,"milestone-actions"],["class","update-btn px-3 py-1 bg-primary-cyan-600 hover:bg-primary-cyan-700 text-white rounded-lg text-sm font-medium transition-colors",3,"click",4,"ngIf"],["class","complete-btn px-3 py-1 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg text-sm font-medium transition-colors",3,"click",4,"ngIf"],[1,"text-sm","text-gray-400","mb-3"],[1,"timeline-estimate","flex","items-center","gap-4"],[1,"estimated-time","flex","items-center","gap-2","text-sm"],[1,"time-icon"],[1,"text-gray-300"],["class","completed-date flex items-center gap-2 text-sm text-emerald-400",4,"ngIf"],["class","in-progress-indicator flex items-center gap-2 text-sm text-amber-400",4,"ngIf"],[1,"milestone-badge"],[1,"status-badge","px-3","py-1","rounded-full","text-xs","font-medium"],["class","milestone-details mt-4 pt-4 border-t border-gray-700",4,"ngIf"],[1,"absolute","-top-1","-right-1","w-4","h-4","bg-amber-500","rounded-full","animate-ping"],[1,"absolute","-top-1","-right-1","w-4","h-4","bg-emerald-500","rounded-full"],[1,"text-xs"],[1,"update-btn","px-3","py-1","bg-primary-cyan-600","hover:bg-primary-cyan-700","text-white","rounded-lg","text-sm","font-medium","transition-colors",3,"click"],[1,"complete-btn","px-3","py-1","bg-emerald-600","hover:bg-emerald-700","text-white","rounded-lg","text-sm","font-medium","transition-colors",3,"click"],[1,"completed-date","flex","items-center","gap-2","text-sm","text-emerald-400"],[1,"in-progress-indicator","flex","items-center","gap-2","text-sm","text-amber-400"],[1,"animate-spin"],[1,"milestone-details","mt-4","pt-4","border-t","border-gray-700"],[1,"details-grid","grid","grid-cols-1","md:grid-cols-2","gap-4"],[1,"detail-card","p-3","bg-gray-800/50","rounded-lg"],[1,"font-medium","text-white","text-sm","mb-2"],[1,"text-sm","text-gray-400","space-y-1"],[4,"ngFor","ngForOf"],[1,"contacts-list","text-sm","text-gray-400","space-y-1"],["class","contact-item",4,"ngFor","ngForOf"],[1,"milestone-actions-log","mt-4"],[1,"actions-list","space-y-2"],["class","action-item p-2 bg-gray-800/30 rounded-lg text-sm",4,"ngFor","ngForOf"],[1,"contact-item"],[1,"contact-role","font-medium"],[1,"contact-info"],[1,"action-item","p-2","bg-gray-800/30","rounded-lg","text-sm"],[1,"text-gray-500","text-xs"]],template:function(t,n){if(t&1&&(o(0,"div",0)(1,"div",1)(2,"div",2)(3,"div",3)(4,"div",4),r(5," \u{1F6A2} "),a(),o(6,"div")(7,"h3",5),r(8,"Seguimiento de Importaci\xF3n"),a(),o(9,"p",6),r(10),a(),h(11,rn,2,1,"p",7),a()(),o(12,"div",8)(13,"div",9),k(14,"span",10),o(15,"span",11),r(16),a()()()()(),o(17,"div",12)(18,"div",13)(19,"div",14),k(20,"div",15),o(21,"div",16),r(22),a()()(),o(23,"div",17),h(24,vn,28,18,"div",18),a()(),o(25,"div",19)(26,"div",20)(27,"div",3)(28,"div",21),r(29,"\u2705"),a(),o(30,"div")(31,"div",22),r(32),a(),o(33,"div",23),r(34,"Etapas Completadas"),a()()()(),o(35,"div",24)(36,"div",3)(37,"div",21),r(38,"\u23F3"),a(),o(39,"div")(40,"div",25),r(41),a(),o(42,"div",23),r(43,"D\xEDas Restantes"),a()()()(),o(44,"div",26)(45,"div",3)(46,"div",21),r(47,"\u{1F4C5}"),a(),o(48,"div")(49,"div",27),r(50),a(),o(51,"div",23),r(52,"Entrega Estimada"),a()()()()(),o(53,"div",28)(54,"button",29),x("click",function(){return n.generateTrackingReport()}),o(55,"span"),r(56,"\u{1F4C4}"),a(),r(57," Generar Reporte "),a(),o(58,"button",30),x("click",function(){return n.notifyClient()}),o(59,"span"),r(60,"\u{1F514}"),a(),r(61," Notificar Cliente "),a()()()),t&2){let s;c(10),b("Unidad: ",(n.client==null||n.client.vehicleInfo==null?null:n.client.vehicleInfo.model)||"N/A",""),c(),p("ngIf",(s=n.integratedStatus())==null?null:s.deliveryOrderId),c(2),P(n.getOverallStatusClass()),c(),P(n.getStatusDotClass()),c(2),f(n.getOverallStatus()),c(4),G("width",n.getOverallProgress(),"%"),c(2),b(" ",n.getOverallProgress(),"% Completado "),c(2),p("ngForOf",n.milestones),c(8),f(n.getCompletedMilestones()),c(9),f(n.getEstimatedDaysRemaining()),c(9),f(n.getExpectedDeliveryDate())}},dependencies:[U,Y,q,he],styles:['.import-tracker[_ngcontent-%COMP%]{position:relative;overflow:hidden}.import-tracker[_ngcontent-%COMP%]:before{content:"";position:absolute;top:0;left:0;right:0;height:4px;background:linear-gradient(90deg,#3b82f6,#10b981)}.icon-container[_ngcontent-%COMP%]{font-size:2rem;opacity:.9}.status-indicator.in-transit[_ngcontent-%COMP%]{background-color:#3b82f61a;color:#3b82f6;border:1px solid rgba(59,130,246,.2)}.status-indicator.completed[_ngcontent-%COMP%]{background-color:#10b9811a;color:#10b981;border:1px solid rgba(16,185,129,.2)}.status-indicator.delayed[_ngcontent-%COMP%]{background-color:#ef44441a;color:#ef4444;border:1px solid rgba(239,68,68,.2)}.status-dot.active[_ngcontent-%COMP%]{background-color:#3b82f6}.status-dot.completed[_ngcontent-%COMP%]{background-color:#10b981}.status-dot.delayed[_ngcontent-%COMP%]{background-color:#ef4444}.milestone-item[_ngcontent-%COMP%]{transition:all .2s ease;cursor:pointer}.milestone-item.completed[_ngcontent-%COMP%]{background-color:#10b9810d;border-color:#10b98133}.milestone-item.in-progress[_ngcontent-%COMP%]{background-color:#f59e0b0d;border-color:#f59e0b33}.milestone-item.pending[_ngcontent-%COMP%]{background-color:#6b72800d;border-color:#6b728033}.milestone-item[_ngcontent-%COMP%]:hover{transform:translateY(-1px);border-color:#3b82f64d}.milestone-circle.completed[_ngcontent-%COMP%]{background-color:#10b98133;border:2px solid rgb(16,185,129)}.milestone-circle.in-progress[_ngcontent-%COMP%]{background-color:#f59e0b33;border:2px solid rgb(245,158,11)}.milestone-circle.pending[_ngcontent-%COMP%]{background-color:#6b728033;border:2px solid rgb(107,114,128)}.status-badge.completed[_ngcontent-%COMP%]{background-color:#10b98133;color:#10b981}.status-badge.in-progress[_ngcontent-%COMP%]{background-color:#f59e0b33;color:#f59e0b}.status-badge.pending[_ngcontent-%COMP%]{background-color:#6b728033;color:#6b7280}.progress-fill[_ngcontent-%COMP%]{transition:width .5s ease-in-out}@media (max-width: 768px){.milestone-item[_ngcontent-%COMP%]   .flex[_ngcontent-%COMP%]{flex-direction:column;gap:1rem;align-items:flex-start}.tracker-actions[_ngcontent-%COMP%]{flex-direction:column}.summary-stats[_ngcontent-%COMP%]{grid-template-columns:1fr}}']})}}return i})();var et=[{from:"IDLE",to:"ELIGIBLE",action:"trigger",requiredRole:"system"},{from:"ELIGIBLE",to:"PENDING_APPROVAL",action:"select_scenario",requiredRole:"client"},{from:"PENDING_APPROVAL",to:"READY_TO_SIGN",action:"approve",requiredRole:"admin"},{from:"PENDING_APPROVAL",to:"REJECTED",action:"deny",requiredRole:"admin"},{from:"READY_TO_SIGN",to:"SIGNED",action:"sign_document",requiredRole:"client"},{from:"SIGNED",to:"APPLIED",action:"apply_changes",requiredRole:"system"},{from:"APPLIED",to:"IDLE",action:"reset_eligibility",requiredRole:"system"},{from:"ELIGIBLE",to:"EXPIRED",action:"expire_window",requiredRole:"system"},{from:"REJECTED",to:"IDLE",action:"cooldown_complete",requiredRole:"system"},{from:"EXPIRED",to:"IDLE",action:"reset_after_expiry",requiredRole:"system"}];function me(i,u,e){return et.some(t=>t.from===i&&t.to===u&&t.action===e)}function tt(i){return et.filter(u=>u.from===i)}var _e={DEFER:{title:"Diferimiento",description:"Suspende pagos temporalmente, capitaliza inter\xE9s",icon:"\u23F8\uFE0F",maxDuration:"6 meses"},STEPDOWN:{title:"Reducci\xF3n Temporal",description:"Reduce el pago mensual por per\xEDodo limitado",icon:"\u{1F4C9}",maxDuration:"12 meses"},RECALENDAR:{title:"Recalendarizaci\xF3n",description:"Extiende el plazo del contrato",icon:"\u{1F4C5}",maxDuration:"24 meses adicionales"},COLLECTIVE:{title:"Fondo Colectivo",description:"Usa fondo grupal para cubrir pagos",icon:"\u{1F465}",maxDuration:"Seg\xFAn disponibilidad"}},nt={IDLE:{title:"Inactivo",description:"Protecci\xF3n disponible si es necesaria",color:"#6b7280",icon:"\u{1F4A4}"},ELIGIBLE:{title:"Elegible",description:"Puede activar protecci\xF3n ahora",color:"#f59e0b",icon:"\u{1F7E1}"},PENDING_APPROVAL:{title:"Pendiente Aprobaci\xF3n",description:"Esperando revisi\xF3n administrativa",color:"#3b82f6",icon:"\u23F3"},READY_TO_SIGN:{title:"Listo para Firmar",description:"Aprobado, esperando firma digital",color:"#10b981",icon:"\u270D\uFE0F"},SIGNED:{title:"Firmado",description:"Documento firmado, aplicando cambios",color:"#8b5cf6",icon:"\u{1F4DD}"},APPLIED:{title:"Aplicado",description:"Protecci\xF3n activa en el contrato",color:"#059669",icon:"\u2705"},REJECTED:{title:"Rechazado",description:"Solicitud denegada por pol\xEDticas",color:"#dc2626",icon:"\u274C"},EXPIRED:{title:"Expirado",description:"Ventana de oportunidad cerrada",color:"#6b7280",icon:"\u231B"}};var it=(()=>{class i{constructor(){this.http=R(te),this.baseUrl=window.__BFF_BASE__??"/api"}getPlan(e){return this.http.get(`${this.baseUrl}/v1/protection/plan/${e}`).pipe(v(this.handleError("getPlan")))}simulate(e){return this.http.post(`${this.baseUrl}/v1/protection/simulate`,e).pipe(v(this.handleError("simulate")))}select(e){return this.http.post(`${this.baseUrl}/v1/protection/select`,e).pipe(w(t=>{if(!me("ELIGIBLE",t.newState,"select_scenario"))throw new Error(`Invalid state transition: ELIGIBLE -> ${t.newState}`);return t}),v(this.handleError("select")))}approve(e){return this.http.post(`${this.baseUrl}/v1/protection/approve`,e).pipe(w(t=>{if(!me("PENDING_APPROVAL",t.newState,"approve"))throw new Error(`Invalid state transition: PENDING_APPROVAL -> ${t.newState}`);return t}),v(this.handleError("approve")))}deny(e){return this.http.post(`${this.baseUrl}/v1/protection/deny`,e).pipe(w(t=>{if(!me("PENDING_APPROVAL",t.newState,"deny"))throw new Error(`Invalid state transition: PENDING_APPROVAL -> ${t.newState}`);return t}),v(this.handleError("deny")))}sign(e){return this.http.post(`${this.baseUrl}/v1/protection/sign`,e).pipe(w(t=>{if(!me("READY_TO_SIGN",t.newState,"sign_document"))throw new Error(`Invalid state transition: READY_TO_SIGN -> ${t.newState}`);return t}),v(this.handleError("sign")))}apply(e){return this.http.post(`${this.baseUrl}/v1/protection/apply`,e).pipe(v(this.handleError("apply")))}expire(e){return this.http.post(`${this.baseUrl}/v1/protection/expire`,{contractId:e}).pipe(v(this.handleError("expire")))}triggerHealthEvent(e){return this.http.post(`${this.baseUrl}/v1/health/events`,e).pipe(v(this.handleError("triggerHealthEvent")))}getUsageHistory(e){return this.http.get(`${this.baseUrl}/v1/protection/history/${e}`).pipe(v(this.handleError("getUsageHistory")))}getPolicyLimits(e,t){return this.http.get(`${this.baseUrl}/v1/protection/policy/${e}/${t}`).pipe(v(this.handleError("getPolicyLimits")))}checkEligibility(e){return this.http.get(`${this.baseUrl}/v1/protection/eligibility/${e}`).pipe(v(this.handleError("checkEligibility")))}getMifielSigningUrl(e,t){return this.http.post(`${this.baseUrl}/v1/protection/mifiel/create`,{contractId:e,scenarioType:t}).pipe(v(this.handleError("getMifielSigningUrl")))}validateScenario(e,t){return this.http.post(`${this.baseUrl}/v1/protection/validate`,{contractId:e,scenario:t}).pipe(v(this.handleError("validateScenario")))}getNotifications(e){return this.http.get(`${this.baseUrl}/v1/protection/notifications/${e}`).pipe(v(this.handleError("getNotifications")))}markNotificationRead(e){return this.http.patch(`${this.baseUrl}/v1/protection/notifications/${e}`,{read:!0}).pipe(v(this.handleError("markNotificationRead")))}handleError(e){return t=>{console.error(`ProtectionService.${e} failed:`,t);let n="Error en el servicio de protecci\xF3n";return t.status===404?n="Plan de protecci\xF3n no encontrado":t.status===403?n="No tienes permisos para esta acci\xF3n":t.status===400?n=t.error?.message||"Solicitud inv\xE1lida":t.status===409?n="Estado de protecci\xF3n inconsistente":t.status>=500&&(n="Error del servidor. Intenta m\xE1s tarde"),ge(()=>({operation:e,originalError:t,userMessage:n,timestamp:new Date().toISOString()}))}}canPerformAction(e,t){return{simulate:["IDLE","ELIGIBLE"],select:["ELIGIBLE"],approve:["PENDING_APPROVAL"],deny:["PENDING_APPROVAL"],sign:["READY_TO_SIGN"],apply:["SIGNED"],expire:["ELIGIBLE","PENDING_APPROVAL","READY_TO_SIGN"]}[t]?.includes(e)||!1}getStatusMessage(e){switch(e.state){case"IDLE":return{message:"Tu protecci\xF3n est\xE1 disponible si la necesitas",urgency:"low"};case"ELIGIBLE":return{message:"Puedes activar tu protecci\xF3n ahora",action:"simulate",actionLabel:"Ver Opciones",urgency:"high"};case"PENDING_APPROVAL":return{message:"Tu solicitud est\xE1 en revisi\xF3n administrativa",urgency:"medium"};case"READY_TO_SIGN":return{message:"\xA1Aprobado! Firma tu documento de protecci\xF3n",action:"sign",actionLabel:"Firmar Ahora",urgency:"high"};case"SIGNED":return{message:"Aplicando cambios a tu contrato...",urgency:"medium"};case"APPLIED":return{message:"Tu protecci\xF3n est\xE1 activa",action:"view_schedule",actionLabel:"Ver Nuevo Calendario",urgency:"low"};case"REJECTED":return{message:"Tu solicitud fue denegada. Puedes intentar m\xE1s tarde",urgency:"low"};case"EXPIRED":return{message:"La ventana de protecci\xF3n expir\xF3. Se evaluar\xE1 nuevamente si es necesario",urgency:"low"};default:return{message:"Estado desconocido",urgency:"low"}}}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();var ot=(()=>{class i{constructor(){this.protectionService=R(it),this.toastService=R(ve),this._currentPlan=K(null),this._loading=K(!1),this._error=K(null),this._simulatingScenarios=K(!1),this._lastAction=K(null),this.loadPlanTrigger=new B,this.simulateTrigger=new B,this.selectScenarioTrigger=new B,this.healthEventTrigger=new B,this.currentPlan=this._currentPlan.asReadonly(),this.loading=this._loading.asReadonly(),this.error=this._error.asReadonly(),this.simulatingScenarios=this._simulatingScenarios.asReadonly(),this.lastAction=this._lastAction.asReadonly(),this.hasActivePlan=N(()=>this._currentPlan()!==null),this.currentState=N(()=>this._currentPlan()?.state||"IDLE"),this.availableScenarios=N(()=>this._currentPlan()?.scenarios||[]),this.selectedScenario=N(()=>this._currentPlan()?.selected),this.canSimulate=N(()=>{let e=this.currentState();return["IDLE","ELIGIBLE"].includes(e)&&!this._loading()}),this.canSelect=N(()=>{let e=this.currentState(),t=this.availableScenarios().length>0;return e==="ELIGIBLE"&&t&&!this._loading()}),this.canApprove=N(()=>this.currentState()==="PENDING_APPROVAL"&&!this._loading()),this.canSign=N(()=>this.currentState()==="READY_TO_SIGN"&&!this._loading()),this.isEligible=N(()=>this.currentState()==="ELIGIBLE"),this.needsAttention=N(()=>{let e=this.currentState();return["ELIGIBLE","READY_TO_SIGN"].includes(e)}),this.statusInfo=N(()=>{let e=this._currentPlan();if(!e)return null;let t=nt[e.state],n=this.protectionService.getStatusMessage(e);return D(M(M({},t),n),{plan:e})}),this.eligibilityInfo=N(()=>{let e=this._currentPlan();return e?{isEligible:e.state==="ELIGIBLE",reason:e.eligibilityReason,usageRemaining:e.used,nextEligibility:e.nextEligibilityDate}:null}),this.validTransitions=N(()=>{let e=this.currentState();return tt(e)}),this.setupReactiveStreams()}setupReactiveStreams(){let e=this.loadPlanTrigger.pipe(O(()=>{this._loading.set(!0),this._error.set(null),this._lastAction.set("loading")}),ee(l=>this.protectionService.getPlan(l).pipe(O(d=>{this._currentPlan.set(d),this._lastAction.set("loaded")}),v(d=>(this._error.set(d.userMessage||"Error loading protection plan"),this.toastService.error("Error al cargar plan de protecci\xF3n"),j)),J(()=>this._loading.set(!1))))),t=this.simulateTrigger.pipe(O(()=>{this._simulatingScenarios.set(!0),this._error.set(null),this._lastAction.set("simulating")}),ee(l=>this.protectionService.simulate(l).pipe(O(d=>{let g=this._currentPlan();if(g){let S=D(M({},g),{scenarios:d.scenarios,state:"ELIGIBLE",eligibilityReason:d.eligibilityCheck.reason});this._currentPlan.set(S),this._lastAction.set("simulated"),d.scenarios.length===0?this.toastService.info("No hay escenarios de protecci\xF3n disponibles en este momento"):this.toastService.success(`${d.scenarios.length} opciones de protecci\xF3n disponibles`)}}),v(d=>(this._error.set(d.userMessage||"Error simulating scenarios"),this.toastService.error("Error al simular escenarios de protecci\xF3n"),j)),J(()=>this._simulatingScenarios.set(!1))))),n=this.selectScenarioTrigger.pipe(O(()=>{this._loading.set(!0),this._error.set(null),this._lastAction.set("selecting")}),ee(l=>this.protectionService.select(l).pipe(O(d=>{let g=this._currentPlan();if(g&&d.success){let S=D(M({},g),{selected:l.scenario,state:d.newState,audit:D(M({},g.audit),{updatedAt:new Date().toISOString()})});this._currentPlan.set(S),this._lastAction.set("selected"),this.toastService.success("Escenario seleccionado, esperando aprobaci\xF3n")}}),v(d=>(this._error.set(d.userMessage||"Error selecting scenario"),this.toastService.error("Error al seleccionar escenario"),j)),J(()=>this._loading.set(!1))))),s=this.healthEventTrigger.pipe(ee(l=>this.protectionService.triggerHealthEvent(l).pipe(O(d=>{if(d.triggered&&d.newState){let g=this._currentPlan();if(g){let S=D(M({},g),{state:d.newState,eligibilityReason:d.reason,audit:D(M({},g.audit),{updatedAt:new Date().toISOString(),triggeredBy:"automatic",reason:d.reason})});this._currentPlan.set(S),d.newState==="ELIGIBLE"&&this.toastService.info("Protecci\xF3n disponible por cambio en situaci\xF3n financiera")}}}),v(d=>(console.error("Health event trigger failed:",d),j)))));e.subscribe(),t.subscribe(),n.subscribe(),s.subscribe()}loadPlan(e){this.loadPlanTrigger.next(e)}simulateScenarios(e,t,n={}){let s={contractId:e,monthK:t,options:n};this.simulateTrigger.next(s)}selectScenario(e,t,n){if(!this.canSelect()){this.toastService.error("No puedes seleccionar escenarios en este momento");return}let s={contractId:e,scenario:t,reason:n};this.selectScenarioTrigger.next(s)}approveScenario(e,t,n){if(!this.canApprove()){this.toastService.error("No puedes aprobar en este momento");return}this._loading.set(!0),this._lastAction.set("approving"),this.protectionService.approve({contractId:e,approvedBy:t,notes:n}).pipe(O(s=>{if(s.success){let l=this._currentPlan();if(l){let d=D(M({},l),{state:s.newState,audit:D(M({},l.audit),{updatedAt:new Date().toISOString(),approvedBy:t})});this._currentPlan.set(d),this._lastAction.set("approved"),this.toastService.success("Protecci\xF3n aprobada, listo para firmar")}}}),v(s=>(this._error.set(s.userMessage||"Error approving scenario"),this.toastService.error("Error al aprobar protecci\xF3n"),j)),J(()=>this._loading.set(!1))).subscribe()}denyScenario(e,t,n){this._loading.set(!0),this._lastAction.set("denying"),this.protectionService.deny({contractId:e,deniedBy:t,reason:n}).pipe(O(s=>{if(s.success){let l=this._currentPlan();if(l){let d=D(M({},l),{state:s.newState,audit:D(M({},l.audit),{updatedAt:new Date().toISOString(),rejectedReason:n})});this._currentPlan.set(d),this._lastAction.set("denied"),this.toastService.info("Solicitud de protecci\xF3n denegada")}}}),v(s=>(this._error.set(s.userMessage||"Error denying scenario"),this.toastService.error("Error al denegar protecci\xF3n"),j)),J(()=>this._loading.set(!1))).subscribe()}signDocument(e){if(!this.canSign()){this.toastService.error("No puedes firmar en este momento");return}this._loading.set(!0),this._lastAction.set("creating_mifiel"),this.protectionService.getMifielSigningUrl(e,this.selectedScenario()?.type||"DEFER").pipe(O(t=>{let n=window.open(t.signingUrl,"mifiel_signing","width=800,height=600,scrollbars=yes,resizable=yes"),s=setInterval(()=>{n?.closed&&(clearInterval(s),this.handleMifielCompletion(e,t.sessionId,t.documentId))},1e3)}),v(t=>(this._error.set(t.userMessage||"Error creating signing session"),this.toastService.error("Error al crear sesi\xF3n de firma"),j)),J(()=>this._loading.set(!1))).subscribe()}handleMifielCompletion(e,t,n){this._loading.set(!0),this._lastAction.set("signing"),this.protectionService.sign({contractId:e,mifielSessionId:t,signedDocumentUrl:n}).pipe(O(s=>{if(s.success){let l=this._currentPlan();if(l){let d=D(M({},l),{state:s.newState,mifielSessionId:t,signedDocumentUrl:n,audit:D(M({},l.audit),{updatedAt:new Date().toISOString()})});this._currentPlan.set(d),this._lastAction.set("signed"),this.toastService.success("Documento firmado exitosamente, aplicando cambios"),setTimeout(()=>this.applyProtection(e),2e3)}}}),v(s=>(this._error.set(s.userMessage||"Error confirming signature"),this.toastService.error("Error al confirmar firma"),j)),J(()=>this._loading.set(!1))).subscribe()}applyProtection(e,t){this._loading.set(!0),this._lastAction.set("applying"),this.protectionService.apply({contractId:e,effectiveDate:t}).pipe(O(n=>{if(n.success){let s=this._currentPlan();if(s){let l=D(M({},s),{state:"APPLIED",newPaymentSchedule:n.newSchedule,audit:D(M({},s.audit),{updatedAt:new Date().toISOString()})});this._currentPlan.set(l),this._lastAction.set("applied"),this.toastService.success("\xA1Protecci\xF3n aplicada exitosamente!")}}}),v(n=>(this._error.set(n.userMessage||"Error applying protection"),this.toastService.error("Error al aplicar protecci\xF3n"),j)),J(()=>this._loading.set(!1))).subscribe()}triggerHealthEvent(e){this.healthEventTrigger.next(e)}canTransitionTo(e){let t=this.currentState();return this.validTransitions().some(s=>s.to===e)}getScenarioById(e){return this.availableScenarios().find(t=>t.type===e)}clearError(){this._error.set(null)}reset(){this._currentPlan.set(null),this._loading.set(!1),this._error.set(null),this._simulatingScenarios.set(!1),this._lastAction.set(null)}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275prov=F({token:i,factory:i.\u0275fac,providedIn:"root"})}}return i})();function _n(i,u){if(i&1&&(o(0,"p",12),r(1),a()),i&2){let e=m();c(),b(" Gesti\xF3n de protecci\xF3n para ",e.client.name," ")}}function xn(i,u){if(i&1&&(o(0,"div",13)(1,"div",14)(2,"span",15),r(3),a(),o(4,"span",16),r(5),a()(),o(6,"p",17),r(7),a()()),i&2){let e=m();c(),P("status-"+e.statusInfo().color.replace("#","")),c(2),f(e.statusInfo().icon),c(2),f(e.statusInfo().title),c(2),f(e.statusInfo().message)}}function bn(i,u){if(i&1&&(o(0,"div",18),k(1,"div",19),o(2,"p"),r(3),a()()),i&2){let e=m();c(3),f(e.getLoadingMessage())}}function yn(i,u){if(i&1){let e=I();o(0,"div",20)(1,"div",21)(2,"span",22),r(3,"\u26A0\uFE0F"),a(),o(4,"div",23)(5,"h4"),r(6,"Error en Protecci\xF3n"),a(),o(7,"p"),r(8),a()(),o(9,"button",24),x("click",function(){y(e);let n=m();return C(n.retryLastAction())}),r(10," Reintentar "),a()()()}if(i&2){let e=m();c(8),f(e.protectionState.error())}}function Cn(i,u){if(i&1){let e=I();o(0,"div",25)(1,"div",26)(2,"div",27),r(3,"\u{1F6E1}\uFE0F"),a(),o(4,"h3"),r(5,"Protecci\xF3n No Activada"),a(),o(6,"p"),r(7,"Este contrato no tiene un plan de protecci\xF3n activo o no es elegible."),a(),o(8,"button",28),x("click",function(){y(e);let n=m();return C(n.checkEligibility())}),r(9," Verificar Elegibilidad "),a()()()}if(i&2){let e=m();c(8),p("disabled",e.protectionState.loading())}}function Sn(i,u){if(i&1){let e=I();o(0,"div",44)(1,"div",45)(2,"span",46),r(3,"\u{1F6A8}"),a(),o(4,"div",47)(5,"h4"),r(6,"\xA1Protecci\xF3n Disponible!"),a(),o(7,"p"),r(8),a()(),o(9,"button",48),x("click",function(){y(e);let n=m(2);return C(n.simulateScenarios())}),r(10),a()()()}if(i&2){let e,t=m(2);c(8),f(((e=t.eligibilityInfo())==null?null:e.reason)||"Puedes activar tu protecci\xF3n ahora"),c(),p("disabled",t.protectionState.simulatingScenarios()),c(),b(" ",t.protectionState.simulatingScenarios()?"Simulando...":"Ver Opciones"," ")}}function Pn(i,u){if(i&1&&(o(0,"div",49)(1,"div",50)(2,"span"),r(3,"Diferimientos:"),a(),o(4,"span"),r(5),a()(),o(6,"div",50)(7,"span"),r(8,"Reducciones:"),a(),o(9,"span"),r(10),a()(),o(11,"div",50)(12,"span"),r(13,"Recalendarizaciones:"),a(),o(14,"span"),r(15),a()()()),i&2){let e=m(2);c(5),W("",e.currentPlan().used.defer,"/",e.currentPlan().policy.difMax,""),c(5),b("",e.currentPlan().used.stepdown,"/3"),c(5),b("",e.currentPlan().used.recalendar,"/2")}}function En(i,u){if(i&1&&(o(0,"div",51)(1,"div",52)(2,"span"),r(3,"Diferimiento m\xE1x:"),a(),o(4,"span"),r(5),a()(),o(6,"div",52)(7,"span"),r(8,"TIR m\xEDnima:"),a(),o(9,"span"),r(10),a()(),o(11,"div",52)(12,"span"),r(13,"Pago m\xEDnimo:"),a(),o(14,"span"),r(15),a()()()),i&2){let e=m(2);c(5),b("",e.currentPlan().policy.difMax," meses"),c(5),b("",(e.currentPlan().policy.irrMin*100).toFixed(1),"%"),c(5),f(e.formatCurrency(e.currentPlan().policy.mMin))}}function Mn(i,u){if(i&1&&(o(0,"div",67)(1,"span"),r(2,"Nuevo pago:"),a(),o(3,"span",68),r(4),a()()),i&2){let e=m().$implicit,t=m(3);c(4),f(t.formatCurrency(e.Mprime))}}function wn(i,u){if(i&1&&(o(0,"div",67)(1,"span"),r(2,"Nuevo plazo:"),a(),o(3,"span",68),r(4),a()()),i&2){let e=m().$implicit;c(4),b("",e.nPrime," meses")}}function Dn(i,u){if(i&1&&(o(0,"div",67)(1,"span"),r(2,"Pago global:"),a(),o(3,"span",68),r(4),a()()),i&2){let e=m().$implicit,t=m(3);c(4),f(t.formatCurrency(e.balloon))}}function In(i,u){if(i&1&&(o(0,"div",67)(1,"span"),r(2,"TIR:"),a(),o(3,"span",68),r(4),a()()),i&2){let e=m().$implicit;c(4),b("",(e.irr*100).toFixed(2),"%")}}function On(i,u){if(i&1&&(o(0,"div",71),r(1),a()),i&2){let e=u.$implicit;c(),b(" \u26A0\uFE0F ",e," ")}}function kn(i,u){if(i&1&&(o(0,"div",69),h(1,On,2,1,"div",70),a()),i&2){let e=m().$implicit;c(),p("ngForOf",e.warnings)}}function Tn(i,u){if(i&1){let e=I();o(0,"div",56)(1,"div",57)(2,"span",58),r(3),a(),o(4,"h4"),r(5),a(),o(6,"div",59),r(7),a()(),o(8,"div",60)(9,"p",61),r(10),a(),o(11,"div",62),h(12,Mn,5,1,"div",63)(13,wn,5,1,"div",63)(14,Dn,5,1,"div",63)(15,In,5,1,"div",63),a(),h(16,kn,2,1,"div",64),o(17,"div",65)(18,"button",66),x("click",function(){let n=y(e).$implicit,s=m(3);return C(s.selectScenario(n))}),r(19),a()()()()}if(i&2){let e=u.$implicit,t=m(3);H("selected",t.isSelectedScenario(e)),c(3),f(t.getScenarioIcon(e.type)),c(2),f(t.getScenarioTitle(e.type)),c(),H("tir-ok",e.tirOK),c(),b(" ",e.tirOK?"\u2705 TIR OK":"\u26A0\uFE0F TIR Bajo"," "),c(3),f(t.getScenarioDescription(e.type)),c(2),p("ngIf",e.Mprime),c(),p("ngIf",e.nPrime),c(),p("ngIf",e.balloon),c(),p("ngIf",e.irr),c(),p("ngIf",e.warnings&&e.warnings.length>0),c(2),H("selected",t.isSelectedScenario(e)),p("disabled",!t.protectionState.canSelect()||!e.tirOK),c(),b(" ",t.isSelectedScenario(e)?"Seleccionado":"Seleccionar"," ")}}function An(i,u){if(i&1&&(o(0,"div",53)(1,"h3"),r(2,"\u{1F3AF} Opciones de Protecci\xF3n Disponibles"),a(),o(3,"div",54),h(4,Tn,20,17,"div",55),a()()),i&2){let e=m(2);c(4),p("ngForOf",e.protectionState.availableScenarios())("ngForTrackBy",e.trackScenario)}}function Rn(i,u){if(i&1){let e=I();o(0,"div",83)(1,"button",84),x("click",function(){y(e);let n=m(4);return C(n.approveScenario())}),r(2," Aprobar "),a(),o(3,"button",85),x("click",function(){y(e);let n=m(4);return C(n.showDenyDialog())}),r(4," Denegar "),a()()}}function Fn(i,u){if(i&1&&(o(0,"div",81)(1,"p"),r(2,"Esperando aprobaci\xF3n administrativa..."),a(),h(3,Rn,5,0,"div",82),a()),i&2){let e=m(3);c(3),p("ngIf",e.canApprove)}}function Vn(i,u){if(i&1){let e=I();o(0,"div",86)(1,"p"),r(2,"\u2705 Aprobado - Listo para firmar"),a(),o(3,"button",87),x("click",function(){y(e);let n=m(3);return C(n.signDocument())}),r(4," Firmar Documento "),a()()}}function Nn(i,u){i&1&&(o(0,"div",88)(1,"p"),r(2,"\u{1F4DD} Documento firmado - Aplicando cambios..."),a(),o(3,"div",89)(4,"div",90),k(5,"div",91),a()()())}function Ln(i,u){if(i&1){let e=I();o(0,"div",92)(1,"p"),r(2,"\u{1F389} \xA1Protecci\xF3n aplicada exitosamente!"),a(),o(3,"button",93),x("click",function(){y(e);let n=m(3);return C(n.viewNewSchedule())}),r(4," Ver Nuevo Calendario de Pagos "),a()()}}function $n(i,u){if(i&1&&(o(0,"div",72)(1,"h3"),r(2,"\u2705 Escenario Seleccionado"),a(),o(3,"div",73)(4,"div",74)(5,"span",75),r(6),a(),o(7,"h4"),r(8),a()(),o(9,"div",76),h(10,Fn,4,1,"div",77)(11,Vn,5,0,"div",78)(12,Nn,6,0,"div",79)(13,Ln,5,0,"div",80),a()()()),i&2){let e=m(2);c(6),f(e.getScenarioIcon(e.protectionState.selectedScenario().type)),c(2),f(e.getScenarioTitle(e.protectionState.selectedScenario().type)),c(2),p("ngIf",e.protectionState.currentState()==="PENDING_APPROVAL"),c(),p("ngIf",e.protectionState.currentState()==="READY_TO_SIGN"),c(),p("ngIf",e.protectionState.currentState()==="SIGNED"),c(),p("ngIf",e.protectionState.currentState()==="APPLIED")}}function zn(i,u){if(i&1&&(o(0,"tr")(1,"td"),r(2),a(),o(3,"td",98),r(4),a(),o(5,"td",99),r(6),a(),o(7,"td",100),r(8),a(),o(9,"td",101),r(10),a()()),i&2){let e=u.$implicit,t=m(3);c(2),f(e.month),c(2),f(t.formatCurrency(e.payment)),c(2),f(t.formatCurrency(e.principal)),c(2),f(t.formatCurrency(e.interest)),c(2),f(t.formatCurrency(e.balance))}}function qn(i,u){if(i&1&&(o(0,"div",94)(1,"h3"),r(2,"\u{1F4C5} Nuevo Calendario de Pagos"),a(),o(3,"div",95)(4,"table",96)(5,"thead")(6,"tr")(7,"th"),r(8,"Mes"),a(),o(9,"th"),r(10,"Pago"),a(),o(11,"th"),r(12,"Capital"),a(),o(13,"th"),r(14,"Inter\xE9s"),a(),o(15,"th"),r(16,"Saldo"),a()()(),o(17,"tbody"),h(18,zn,11,5,"tr",97),a()()()()),i&2){let e=m(2);c(18),p("ngForOf",e.getDisplaySchedule())("ngForTrackBy",e.trackPayment)}}function Un(i,u){if(i&1&&(o(0,"div",29),h(1,Sn,11,3,"div",30),o(2,"div",31)(3,"h3"),r(4,"\u{1F4CA} Estado del Plan"),a(),o(5,"div",32)(6,"div",33)(7,"div",34)(8,"span",35),r(9,"\u{1F4C8}"),a(),o(10,"h4"),r(11,"Estado Actual"),a()(),o(12,"div",36)(13,"div",37)(14,"span",38),r(15),a(),o(16,"p"),r(17),a()()()(),o(18,"div",33)(19,"div",34)(20,"span",35),r(21,"\u{1F504}"),a(),o(22,"h4"),r(23,"Uso Anual"),a()(),o(24,"div",36),h(25,Pn,16,4,"div",39),a()(),o(26,"div",33)(27,"div",34)(28,"span",35),r(29,"\u2699\uFE0F"),a(),o(30,"h4"),r(31,"Pol\xEDticas"),a()(),o(32,"div",36),h(33,En,16,3,"div",40),a()()()(),h(34,An,5,2,"div",41)(35,$n,14,6,"div",42)(36,qn,19,2,"div",43),a()),i&2){let e,t,n,s=m();c(),p("ngIf",s.protectionState.isEligible()),c(13),G("background-color",(e=s.statusInfo())==null?null:e.color),c(),b(" ",s.protectionState.currentState()," "),c(2),f((t=s.statusInfo())==null?null:t.description),c(8),p("ngIf",s.currentPlan()),c(8),p("ngIf",s.currentPlan()),c(),p("ngIf",s.protectionState.availableScenarios().length>0),c(),p("ngIf",s.protectionState.selectedScenario()),c(),p("ngIf",(n=s.currentPlan())==null?null:n.newPaymentSchedule)}}function Bn(i,u){if(i&1){let e=I();o(0,"div",102)(1,"button",103),x("click",function(){y(e);let n=m();return C(n.performStatusAction())}),r(2),a()()}if(i&2){let e=m();c(),p("disabled",e.protectionState.loading()),c(),b(" ",e.statusInfo().actionLabel||"Acci\xF3n"," ")}}function Gn(i,u){if(i&1){let e=I();o(0,"div",104),x("click",function(){y(e);let n=m();return C(n.hideDenyDialog())}),o(1,"div",105),x("click",function(n){return y(e),C(n.stopPropagation())}),o(2,"h3"),r(3,"Denegar Solicitud de Protecci\xF3n"),a(),o(4,"textarea",106),Oe("ngModelChange",function(n){y(e);let s=m();return Ie(s.denyReason,n)||(s.denyReason=n),C(n)}),a(),o(5,"div",107)(6,"button",108),x("click",function(){y(e);let n=m();return C(n.hideDenyDialog())}),r(7,"Cancelar"),a(),o(8,"button",109),x("click",function(){y(e);let n=m();return C(n.confirmDeny())}),r(9,"Confirmar Rechazo"),a()()()()}if(i&2){let e=m();c(4),De("ngModel",e.denyReason)}}var at=(()=>{class i{constructor(){this.destroy$=new B,this.router=R(Re),this.toastService=R(ve),this.protectionState=R(ot),this.showDenyModal=!1,this.denyReason="",this.canApprove=!1,this.currentPlan=this.protectionState.currentPlan,this.statusInfo=this.protectionState.statusInfo,this.eligibilityInfo=this.protectionState.eligibilityInfo,ke(()=>{let e=this.currentPlan();e&&console.log("Protection plan updated:",e.state,e)})}ngOnInit(){if(this.contractId||this.client?.id){let e=this.contractId||`contract-${this.client.id}`;this.protectionState.loadPlan(e)}this.canApprove=!0}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}checkEligibility(){if(this.contractId||this.client?.id){let e=this.contractId||`contract-${this.client.id}`;this.protectionState.loadPlan(e)}}simulateScenarios(){if(this.contractId||this.client?.id){let e=this.contractId||`contract-${this.client.id}`;this.protectionState.simulateScenarios(e,12,{triggerReason:"Manual request from client"})}}selectScenario(e){if(this.contractId||this.client?.id){let t=this.contractId||`contract-${this.client.id}`;this.protectionState.selectScenario(t,e,"Client selection from available options")}}approveScenario(){if(this.contractId||this.client?.id){let e=this.contractId||`contract-${this.client.id}`;this.protectionState.approveScenario(e,"admin-user","Approved by admin")}}showDenyDialog(){this.showDenyModal=!0,this.denyReason=""}hideDenyDialog(){this.showDenyModal=!1,this.denyReason=""}confirmDeny(){if(!this.denyReason.trim()){this.toastService.error("Debes proporcionar un motivo para el rechazo");return}if(this.contractId||this.client?.id){let e=this.contractId||`contract-${this.client.id}`;this.protectionState.denyScenario(e,"admin-user",this.denyReason),this.hideDenyDialog()}}signDocument(){if(this.contractId||this.client?.id){let e=this.contractId||`contract-${this.client.id}`;this.protectionState.signDocument(e)}}viewNewSchedule(){let e=document.querySelector(".schedule-section");e&&e.scrollIntoView({behavior:"smooth"})}performStatusAction(){let e=this.statusInfo();if(e?.action)switch(e.action){case"simulate":this.simulateScenarios();break;case"sign":this.signDocument();break;case"view_schedule":this.viewNewSchedule();break;default:console.log("Unknown action:",e.action)}}retryLastAction(){switch(this.protectionState.clearError(),this.protectionState.lastAction()){case"loading":this.checkEligibility();break;case"simulating":this.simulateScenarios();break;default:this.checkEligibility()}}getLoadingMessage(){switch(this.protectionState.lastAction()){case"loading":return"Cargando plan de protecci\xF3n...";case"simulating":return"Simulando escenarios de protecci\xF3n...";case"selecting":return"Seleccionando escenario...";case"approving":return"Procesando aprobaci\xF3n...";case"signing":return"Procesando firma...";case"applying":return"Aplicando cambios al contrato...";default:return"Procesando..."}}isSelectedScenario(e){return this.protectionState.selectedScenario()?.type===e.type}getScenarioIcon(e){return _e[e]?.icon||"\u{1F6E1}\uFE0F"}getScenarioTitle(e){return _e[e]?.title||e}getScenarioDescription(e){return _e[e]?.description||"Opci\xF3n de protecci\xF3n"}getDisplaySchedule(){return(this.currentPlan()?.newPaymentSchedule||[]).slice(0,12)}formatCurrency(e){return new Intl.NumberFormat("es-MX",{style:"currency",currency:"MXN"}).format(e)}trackScenario(e,t){return t.type}trackPayment(e,t){return t.month}static{this.\u0275fac=function(t){return new(t||i)}}static{this.\u0275cmp=$({type:i,selectors:[["app-protection-real"]],inputs:{client:"client",contractId:"contractId"},standalone:!0,features:[z],decls:13,vars:8,consts:[[1,"protection-container"],[1,"protection-header"],[1,"header-content"],[1,"protection-title"],["class","protection-subtitle",4,"ngIf"],["class","status-section",4,"ngIf"],["class","loading-section",4,"ngIf"],["class","error-section",4,"ngIf"],["class","no-plan-section",4,"ngIf"],["class","protection-dashboard",4,"ngIf"],["class","action-buttons",4,"ngIf"],["class","modal-overlay",3,"click",4,"ngIf"],[1,"protection-subtitle"],[1,"status-section"],[1,"status-badge"],[1,"status-icon"],[1,"status-text"],[1,"status-description"],[1,"loading-section"],[1,"loading-spinner"],[1,"error-section"],[1,"error-content"],[1,"error-icon"],[1,"error-text"],[1,"btn-retry",3,"click"],[1,"no-plan-section"],[1,"no-plan-content"],[1,"no-plan-icon"],[1,"btn-check-eligibility",3,"click","disabled"],[1,"protection-dashboard"],["class","eligibility-banner",4,"ngIf"],[1,"plan-info-section"],[1,"plan-grid"],[1,"plan-card"],[1,"card-header"],[1,"card-icon"],[1,"card-content"],[1,"state-info"],[1,"state-badge"],["class","usage-info",4,"ngIf"],["class","policy-info",4,"ngIf"],["class","scenarios-section",4,"ngIf"],["class","selected-scenario-section",4,"ngIf"],["class","schedule-section",4,"ngIf"],[1,"eligibility-banner"],[1,"banner-content"],[1,"banner-icon"],[1,"banner-text"],[1,"btn-simulate",3,"click","disabled"],[1,"usage-info"],[1,"usage-item"],[1,"policy-info"],[1,"policy-item"],[1,"scenarios-section"],[1,"scenarios-grid"],["class","scenario-card",3,"selected",4,"ngFor","ngForOf","ngForTrackBy"],[1,"scenario-card"],[1,"scenario-header"],[1,"scenario-icon"],[1,"scenario-badge"],[1,"scenario-content"],[1,"scenario-description"],[1,"scenario-details"],["class","detail-item",4,"ngIf"],["class","scenario-warnings",4,"ngIf"],[1,"scenario-actions"],[1,"btn-select-scenario",3,"click","disabled"],[1,"detail-item"],[1,"value"],[1,"scenario-warnings"],["class","warning-item",4,"ngFor","ngForOf"],[1,"warning-item"],[1,"selected-scenario-section"],[1,"selected-scenario-card"],[1,"selected-header"],[1,"selected-icon"],[1,"selected-actions"],["class","approval-actions",4,"ngIf"],["class","signing-actions",4,"ngIf"],["class","applying-actions",4,"ngIf"],["class","applied-actions",4,"ngIf"],[1,"approval-actions"],["class","admin-actions",4,"ngIf"],[1,"admin-actions"],[1,"btn-approve",3,"click"],[1,"btn-deny",3,"click"],[1,"signing-actions"],[1,"btn-sign",3,"click"],[1,"applying-actions"],[1,"progress-indicator"],[1,"progress-bar"],[1,"progress-fill"],[1,"applied-actions"],[1,"btn-view-schedule",3,"click"],[1,"schedule-section"],[1,"schedule-table-container"],[1,"schedule-table"],[4,"ngFor","ngForOf","ngForTrackBy"],[1,"amount"],[1,"amount","principal"],[1,"amount","interest"],[1,"amount","balance"],[1,"action-buttons"],[1,"btn-primary","action-btn",3,"click","disabled"],[1,"modal-overlay",3,"click"],[1,"modal-content",3,"click"],["placeholder","Motivo del rechazo...",1,"deny-textarea",3,"ngModelChange","ngModel"],[1,"modal-actions"],[1,"btn-cancel",3,"click"],[1,"btn-confirm-deny",3,"click"]],template:function(t,n){if(t&1&&(o(0,"div",0)(1,"div",1)(2,"div",2)(3,"h2",3),r(4," \u{1F6E1}\uFE0F Sistema de Protecci\xF3n Conductores "),a(),h(5,_n,2,1,"p",4),a(),h(6,xn,8,5,"div",5),a(),h(7,bn,4,1,"div",6)(8,yn,11,1,"div",7)(9,Cn,10,1,"div",8)(10,Un,37,10,"div",9)(11,Bn,3,2,"div",10)(12,Gn,10,1,"div",11),a()),t&2){let s;c(5),p("ngIf",n.client),c(),p("ngIf",n.statusInfo()),c(),p("ngIf",n.protectionState.loading()),c(),p("ngIf",n.protectionState.error()),c(),p("ngIf",!n.protectionState.hasActivePlan()&&!n.protectionState.loading()&&!n.protectionState.error()),c(),p("ngIf",n.protectionState.hasActivePlan()&&!n.protectionState.loading()),c(),p("ngIf",(s=n.statusInfo())==null?null:s.action),c(),p("ngIf",n.showDenyModal)}},dependencies:[U,Y,q,Le,Fe,Ve,Ne],styles:[".protection-container[_ngcontent-%COMP%]{padding:24px;max-width:1400px;margin:0 auto;background:#0f1419;color:#fff;min-height:100vh}.protection-header[_ngcontent-%COMP%]{margin-bottom:32px}.header-content[_ngcontent-%COMP%]{text-align:center;margin-bottom:24px}.protection-title[_ngcontent-%COMP%]{font-size:28px;font-weight:700;margin:0 0 8px;color:#06d6a0}.protection-subtitle[_ngcontent-%COMP%]{margin:0;color:#a0aec0;font-size:16px}.status-section[_ngcontent-%COMP%]{text-align:center}.status-badge[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:8px;padding:12px 24px;border-radius:24px;font-weight:600;margin-bottom:8px}.status-description[_ngcontent-%COMP%]{margin:0;color:#a0aec0}.loading-section[_ngcontent-%COMP%]{text-align:center;padding:64px}.loading-spinner[_ngcontent-%COMP%]{width:48px;height:48px;border:4px solid #2d3748;border-left-color:#06d6a0;border-radius:50%;animation:_ngcontent-%COMP%_spin 1s linear infinite;margin:0 auto 16px}@keyframes _ngcontent-%COMP%_spin{to{transform:rotate(360deg)}}.error-section[_ngcontent-%COMP%]{background:#2d1b1b;border:1px solid #e53e3e;border-radius:12px;padding:24px;margin-bottom:24px}.error-content[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:16px}.error-icon[_ngcontent-%COMP%]{font-size:24px;flex-shrink:0}.error-text[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 8px;color:#feb2b2}.error-text[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;color:#fca5a5}.btn-retry[_ngcontent-%COMP%]{padding:8px 16px;background:#e53e3e;color:#fff;border:none;border-radius:6px;cursor:pointer}.no-plan-section[_ngcontent-%COMP%]{text-align:center;padding:64px;background:#1a1f2e;border-radius:12px;margin-bottom:24px}.no-plan-icon[_ngcontent-%COMP%]{font-size:64px;margin-bottom:16px}.no-plan-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 8px;color:#a0aec0}.no-plan-section[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0 0 24px;color:#718096}.btn-check-eligibility[_ngcontent-%COMP%]{padding:12px 24px;background:#06d6a0;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer}.eligibility-banner[_ngcontent-%COMP%]{background:linear-gradient(135deg,#f59e0b,#d97706);border-radius:12px;padding:20px;margin-bottom:24px}.banner-content[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px}.banner-icon[_ngcontent-%COMP%]{font-size:32px;flex-shrink:0}.banner-text[_ngcontent-%COMP%]{flex:1}.banner-text[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 4px;color:#fff}.banner-text[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;color:#ffffffe6}.btn-simulate[_ngcontent-%COMP%]{padding:12px 20px;background:#fff;color:#d97706;border:none;border-radius:8px;font-weight:600;cursor:pointer}.plan-info-section[_ngcontent-%COMP%]{margin-bottom:32px}.plan-info-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;color:#06d6a0}.plan-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px}.plan-card[_ngcontent-%COMP%]{background:#1a1f2e;border-radius:12px;padding:20px;border:1px solid #2d3748}.card-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:16px}.card-icon[_ngcontent-%COMP%]{font-size:24px}.card-header[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0;color:#e2e8f0}.state-badge[_ngcontent-%COMP%]{padding:6px 12px;border-radius:16px;font-size:12px;font-weight:600;color:#fff;margin-bottom:8px;display:inline-block}.usage-info[_ngcontent-%COMP%], .policy-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px}.usage-item[_ngcontent-%COMP%], .policy-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;color:#a0aec0}.scenarios-section[_ngcontent-%COMP%]{margin-bottom:32px}.scenarios-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;color:#06d6a0}.scenarios-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(350px,1fr));gap:20px}.scenario-card[_ngcontent-%COMP%]{background:#1a1f2e;border:2px solid #2d3748;border-radius:12px;padding:20px;transition:all .2s}.scenario-card.selected[_ngcontent-%COMP%]{border-color:#06d6a0;background:#0d2818}.scenario-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:16px}.scenario-icon[_ngcontent-%COMP%]{font-size:24px}.scenario-header[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0;flex:1;color:#e2e8f0}.scenario-badge[_ngcontent-%COMP%]{padding:4px 8px;border-radius:12px;font-size:11px;font-weight:600}.scenario-badge.tir-ok[_ngcontent-%COMP%]{background:#065f46;color:#10b981}.scenario-badge[_ngcontent-%COMP%]:not(.tir-ok){background:#7c2d12;color:#f59e0b}.scenario-description[_ngcontent-%COMP%]{color:#a0aec0;margin:0 0 16px;font-size:14px}.scenario-details[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}.detail-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;color:#a0aec0;font-size:14px}.detail-item[_ngcontent-%COMP%]   .value[_ngcontent-%COMP%]{color:#e2e8f0;font-weight:600;font-family:monospace}.scenario-warnings[_ngcontent-%COMP%]{margin-bottom:16px}.warning-item[_ngcontent-%COMP%]{color:#fbbf24;font-size:12px;margin-bottom:4px}.scenario-actions[_ngcontent-%COMP%]{text-align:center}.btn-select-scenario[_ngcontent-%COMP%]{width:100%;padding:10px;background:#2d3748;color:#a0aec0;border:2px solid #4a5568;border-radius:8px;cursor:pointer;font-weight:600;transition:all .2s}.btn-select-scenario[_ngcontent-%COMP%]:not(:disabled):hover{background:#4a5568;border-color:#06d6a0;color:#06d6a0}.btn-select-scenario.selected[_ngcontent-%COMP%]{background:#065f46;border-color:#10b981;color:#10b981}.btn-select-scenario[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.selected-scenario-section[_ngcontent-%COMP%]{margin-bottom:32px}.selected-scenario-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;color:#06d6a0}.selected-scenario-card[_ngcontent-%COMP%]{background:#0d2818;border:2px solid #065f46;border-radius:12px;padding:20px}.selected-header[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;margin-bottom:16px}.selected-icon[_ngcontent-%COMP%]{font-size:24px}.selected-header[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0;color:#10b981}.approval-actions[_ngcontent-%COMP%], .signing-actions[_ngcontent-%COMP%], .applying-actions[_ngcontent-%COMP%], .applied-actions[_ngcontent-%COMP%]{text-align:center}.admin-actions[_ngcontent-%COMP%]{display:flex;gap:12px;justify-content:center;margin-top:16px}.btn-approve[_ngcontent-%COMP%]{padding:10px 20px;background:#059669;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer}.btn-deny[_ngcontent-%COMP%]{padding:10px 20px;background:#dc2626;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer}.btn-sign[_ngcontent-%COMP%], .btn-view-schedule[_ngcontent-%COMP%]{padding:12px 24px;background:#06d6a0;color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:16px}.progress-indicator[_ngcontent-%COMP%]{margin-top:16px}.progress-bar[_ngcontent-%COMP%]{width:100%;height:6px;background:#2d3748;border-radius:3px;overflow:hidden}.progress-fill[_ngcontent-%COMP%]{width:100%;height:100%;background:linear-gradient(90deg,#06d6a0,#10b981);animation:_ngcontent-%COMP%_progress-fill 3s ease-in-out infinite}@keyframes _ngcontent-%COMP%_progress-fill{0%,to{transform:translate(-100%)}50%{transform:translate(0)}}.schedule-section[_ngcontent-%COMP%]{margin-bottom:32px}.schedule-section[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;color:#06d6a0}.schedule-table-container[_ngcontent-%COMP%]{background:#1a1f2e;border-radius:12px;padding:20px;overflow-x:auto}.schedule-table[_ngcontent-%COMP%]{width:100%;border-collapse:collapse;font-size:14px}.schedule-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%]{background:#2d3748;color:#a0aec0;font-weight:600;padding:12px;text-align:left;border-bottom:2px solid #4a5568}.schedule-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:10px 12px;border-bottom:1px solid #2d3748}.schedule-table[_ngcontent-%COMP%]   .amount[_ngcontent-%COMP%]{font-family:monospace;text-align:right}.schedule-table[_ngcontent-%COMP%]   .principal[_ngcontent-%COMP%]{color:#10b981}.schedule-table[_ngcontent-%COMP%]   .interest[_ngcontent-%COMP%]{color:#f59e0b}.schedule-table[_ngcontent-%COMP%]   .balance[_ngcontent-%COMP%]{font-weight:600}.action-buttons[_ngcontent-%COMP%]{text-align:center;margin-top:32px}.btn-primary.action-btn[_ngcontent-%COMP%]{padding:16px 32px;background:#06d6a0;color:#fff;border:none;border-radius:12px;font-size:16px;font-weight:700;cursor:pointer;transition:all .2s}.btn-primary.action-btn[_ngcontent-%COMP%]:hover:not(:disabled){background:#059669;transform:translateY(-1px)}.btn-primary.action-btn[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.modal-overlay[_ngcontent-%COMP%]{position:fixed;inset:0;background:#000c;display:flex;align-items:center;justify-content:center;z-index:1000}.modal-content[_ngcontent-%COMP%]{background:#1a1f2e;border-radius:12px;padding:24px;width:90%;max-width:500px;border:1px solid #2d3748}.modal-content[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 16px;color:#e2e8f0}.deny-textarea[_ngcontent-%COMP%]{width:100%;height:100px;background:#2d3748;border:1px solid #4a5568;border-radius:8px;padding:12px;color:#fff;font-family:inherit;resize:vertical;margin-bottom:16px}.modal-actions[_ngcontent-%COMP%]{display:flex;gap:12px;justify-content:flex-end}.btn-cancel[_ngcontent-%COMP%]{padding:10px 20px;background:#4a5568;color:#fff;border:none;border-radius:8px;cursor:pointer}.btn-confirm-deny[_ngcontent-%COMP%]{padding:10px 20px;background:#dc2626;color:#fff;border:none;border-radius:8px;cursor:pointer}@media (max-width: 768px){.protection-container[_ngcontent-%COMP%]{padding:16px}.banner-content[_ngcontent-%COMP%]{flex-direction:column;text-align:center}.plan-grid[_ngcontent-%COMP%], .scenarios-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}.admin-actions[_ngcontent-%COMP%]{flex-direction:column}.schedule-table-container[_ngcontent-%COMP%]{padding:16px}.schedule-table[_ngcontent-%COMP%]{font-size:12px}.schedule-table[_ngcontent-%COMP%]   th[_ngcontent-%COMP%], .schedule-table[_ngcontent-%COMP%]   td[_ngcontent-%COMP%]{padding:8px}}"]})}}return i})();function jn(i,u){if(i&1&&(o(0,"div",35)(1,"span",36),r(2,"Score de Salud"),a(),o(3,"span",37),r(4),a()()),i&2){let e=m();c(3),P(e.getHealthScoreClass()),c(),b("",(e.client==null?null:e.client.healthScore)!=null?e.client==null?null:e.client.healthScore:"N/A","%")}}function Qn(i,u){i&1&&(o(0,"div",38)(1,"span",39),r(2,"\u{1F6E1}\uFE0F Protecci\xF3n"),a(),o(3,"span",40),r(4," Disponible "),a()())}function Hn(i,u){if(i&1&&(o(0,"div",41)(1,"div",30)(2,"h2",31),r(3,"\u{1F6E1}\uFE0F Sistema de Protecci\xF3n"),a(),o(4,"p",42),r(5," Gesti\xF3n de protecci\xF3n financiera para productos con plazo "),a()(),k(6,"app-protection-real",43),a()),i&2){let e=m();c(6),p("client",e.client)("contractId",e.getContractId())}}function Wn(i,u){if(i&1&&(o(0,"div",44)(1,"div",45)(2,"div",46)(3,"h3"),r(4,"Informaci\xF3n Personal"),a(),o(5,"div",47)(6,"div",48)(7,"span",49),r(8,"Email:"),a(),o(9,"span",50),r(10),a()(),o(11,"div",48)(12,"span",49),r(13,"Tel\xE9fono:"),a(),o(14,"span",50),r(15),a()(),o(16,"div",48)(17,"span",49),r(18,"RFC:"),a(),o(19,"span",50),r(20),a()()()(),o(21,"div",46)(22,"h3"),r(23,"Informaci\xF3n del Proceso"),a(),o(24,"div",47)(25,"div",48)(26,"span",49),r(27,"Fecha de Creaci\xF3n:"),a(),o(28,"span",50),r(29),ce(30,"date"),a()(),o(31,"div",48)(32,"span",49),r(33,"\xDAltima Actualizaci\xF3n:"),a(),o(34,"span",50),r(35),ce(36,"date"),a()(),o(37,"div",48)(38,"span",49),r(39,"Ecosistema:"),a(),o(40,"span",50),r(41),a()()()()()()),i&2){let e=m();c(10),f(e.client.email||"No proporcionado"),c(5),f(e.client.phone||"No proporcionado"),c(5),f(e.client.rfc||"No proporcionado"),c(9),f(le(30,6,e.client.createdAt,"medium")),c(6),f(le(36,9,e.client.updatedAt,"medium")),c(6),f(e.client.ecosystemId||"No asignado")}}function Yn(i,u){if(i&1&&(o(0,"div",51)(1,"div",30)(2,"h2",31),r(3,"\u{1F4C8} Progreso Financiero"),a()(),o(4,"div",52)(5,"div",53)(6,"h3",54),r(7,"\u{1F4B0} Plan de Ahorro"),a(),k(8,"app-progress-bar",55),o(9,"div",56)(10,"div",57)(11,"span"),r(12,"\xDAltima aportaci\xF3n:"),a(),o(13,"span",58),r(14),a()(),o(15,"div",59)(16,"span"),r(17,"Pr\xF3ximo vencimiento:"),a(),o(18,"span",60),r(19),a()()()(),o(20,"div",53)(21,"h3",54),r(22,"\u{1F4B3} Plan de Pagos"),a(),k(23,"app-progress-bar",61),o(24,"div",62)(25,"div",57)(26,"span"),r(27,"Pagos restantes:"),a(),o(28,"span",58),r(29),a()(),o(30,"div",59)(31,"span"),r(32,"Fecha estimada de liquidaci\xF3n:"),a(),o(33,"span",63),r(34),a()()()()()()),i&2){let e=m();c(8),p("progress",e.getSavingsProgress())("goal",e.getSavingsGoal())("animated",!0)("showValues",!0)("showMessages",!0)("showRemaining",!0)("actionCallback",e.openPaymentModal),c(6),f(e.getLastContributionDate()),c(5),f(e.getNextPaymentDue()),c(4),p("progress",e.getPaymentProgress())("goal",e.getTotalPayments())("animated",!0)("showValues",!1)("showMessages",!0)("milestones",e.getPaymentMilestones()),c(6),f(e.getRemainingPayments()),c(5),f(e.getEstimatedCompletion())}}function Xn(i,u){if(i&1){let e=I();o(0,"div",64)(1,"div",30)(2,"h2",31),r(3,"\u{1F6A2} Seguimiento de Importaci\xF3n"),a()(),o(4,"app-import-tracker",65),x("onUpdateMilestone",function(n){y(e);let s=m();return C(s.updateImportMilestone(n))}),a()()}if(i&2){let e=m();c(4),p("client",e.client)}}function Jn(i,u){i&1&&(o(0,"span"),r(1,"\u{1F4C4}"),a())}function Kn(i,u){i&1&&(o(0,"span",87),r(1,"\u23F3"),a())}function Zn(i,u){if(i&1){let e=I();o(0,"div",66)(1,"div",30)(2,"h2",31),r(3,"\u{1F4B3} Opciones de Pago"),a()(),o(4,"div",67)(5,"button",68),x("click",function(){y(e);let n=m();return C(n.generatePaymentLink("spei"))}),o(6,"div",69)(7,"div",70)(8,"span",71),r(9,"\u{1F3E6}"),a()(),o(10,"div")(11,"h3",72),r(12,"Transferencia SPEI"),a(),o(13,"p",73),r(14,"Pago inmediato desde tu banco"),a(),o(15,"p",74),r(16,"Sin comisiones adicionales"),a()()()(),o(17,"button",75),x("click",function(){y(e);let n=m();return C(n.generatePaymentLink("conekta"))}),o(18,"div",69)(19,"div",76)(20,"span",71),r(21,"\u{1F4B3}"),a()(),o(22,"div")(23,"h3",72),r(24,"Tarjeta de Cr\xE9dito/D\xE9bito"),a(),o(25,"p",73),r(26,"Pago seguro con Conekta"),a(),o(27,"p",77),r(28,"Meses sin intereses disponibles"),a()()()()(),o(29,"div",78)(30,"div",79)(31,"div",80)(32,"div")(33,"h3",72),r(34,"\u{1F4C4} Estado de Cuenta"),a(),o(35,"p",81),r(36,"Genera y descarga tu estado de cuenta actualizado"),a()(),o(37,"div",82)(38,"button",83),x("click",function(){y(e);let n=m();return C(n.previewAccountStatement())}),o(39,"span"),r(40,"\u{1F441}\uFE0F"),a(),o(41,"span"),r(42,"Vista Previa"),a()(),o(43,"button",84),x("click",function(){y(e);let n=m();return C(n.generatePDF())}),h(44,Jn,2,0,"span",85)(45,Kn,2,0,"span",86),o(46,"span"),r(47),a()()()()()()()}if(i&2){let e=m();c(43),p("disabled",e.isGeneratingPDF),c(),p("ngIf",!e.isGeneratingPDF),c(),p("ngIf",e.isGeneratingPDF),c(2),f(e.isGeneratingPDF?"Generando...":"Descargar PDF")}}function ei(i,u){if(i&1){let e=I();o(0,"app-avi-verification-modal",88),x("completed",function(n){y(e);let s=m();return C(s.onAviCompleted(n))})("closed",function(){y(e);let n=m();return C(n.onAviClosed())}),a()}if(i&2){let e=m();p("clientId",(e.client==null?null:e.client.id)||"")("municipality",e.getMunicipality())("visible",e.showAviModal)}}var Uo=(()=>{class i{constructor(e){this.route=e,this.client=null,this.showAviModal=!1,this.clientEvents=[],this.isGeneratingPDF=!1,this.openPaymentModal=()=>{console.log("Opening payment modal"),this.generatePaymentLink("spei")}}ngOnInit(){this.client={id:"client-001",name:"Juan P\xE9rez Garc\xEDa",avatarUrl:"",email:"juan.perez@email.com",phone:"+52 449 123 4567",rfc:"PEGJ850315ABC",status:"Expediente en Proceso",market:"aguascalientes",flow:"VentaPlazo",healthScore:85,events:[],documents:[{id:"doc1",name:"INE Vigente",status:"Aprobado"},{id:"doc2",name:"Comprobante de domicilio",status:"Pendiente"},{id:"doc3",name:"Constancia de situaci\xF3n fiscal",status:"En Revisi\xF3n"}],createdAt:new Date("2024-01-15"),updatedAt:new Date("2024-01-20"),ecosystemId:"ags-ruta-5",savingsGoal:15e4,currentSavings:87500,totalPayments:24,completedPayments:8,lastPaymentDate:new Date("2024-01-18"),nextPaymentDue:new Date("2024-02-15"),vehicleInfo:{model:"Nissan Sentra 2024",vin:"JN1AB7AP1PM123456"},importStatus:{pedidoPlanta:{completed:!0,completedAt:new Date("2024-01-10")},unidadFabricada:{completed:!0,completedAt:new Date("2024-02-05")},transitoMaritimo:{inProgress:!0,startedAt:new Date("2024-02-10")},enAduana:{completed:!1},liberada:{completed:!1}}},this.loadClientEvents()}loadClientEvents(){this.clientEvents=[{id:"1",type:"Contribution",actor:"Cliente",message:"Aportaci\xF3n mensual realizada",timestamp:new Date("2024-01-18"),details:{amount:8500,paymentMethod:"Transferencia SPEI",reference:"REF123456"}},{id:"2",type:"AdvisorAction",actor:"Asesor",message:"Documento INE aprobado",timestamp:new Date("2024-01-16"),details:{documentName:"INE Vigente",status:"Aprobado"}},{id:"3",type:"System",actor:"Sistema",message:"Estado de cuenta generado",timestamp:new Date("2024-01-15"),details:{}}]}canStartAviVerification(){return this.client?.status==="Expediente en Proceso"}startAviVerification(){this.showAviModal=!0}onAviCompleted(e){console.log("AVI Completed:",e),this.showAviModal=!1,this.client&&(e.extractedData.nombre&&(this.client.name=e.extractedData.nombre),e.extractedData.rfc&&(this.client.rfc=e.extractedData.rfc),e.riskScore<30?this.client.status="Verificaci\xF3n AVI Completada":this.client.status="Requiere Supervisi\xF3n")}onAviClosed(){this.showAviModal=!1}getMunicipality(){return this.client?.market==="edomex"?"edomex":"aguascalientes"}canStartKyc(){return this.client?.status==="Documentos Completos"}startTraditionalKyc(){console.log("Starting traditional KYC")}canGenerateContract(){return this.client?.status==="KYC Completado"||this.client?.status==="Verificaci\xF3n AVI Completada"}generateContract(){console.log("Generating contract")}viewDocuments(){console.log("Viewing documents")}getDocumentStats(){if(!this.client?.documents)return"0/0";let e=this.client.documents.filter(n=>n.status==="Aprobado").length,t=this.client.documents.length;return`${e}/${t}`}getFlowDisplayName(e){return{VentaDirecta:"Venta Directa",VentaPlazo:"Venta a Plazo",AhorroProgramado:"Ahorro Programado",CreditoColectivo:"Cr\xE9dito Colectivo"}[e]||e||"No definido"}getMunicipalityName(e){return{aguascalientes:"Aguascalientes",edomex:"Estado de M\xE9xico"}[e]||e||"No definido"}getScoreClass(e){return e>=80?"score-excellent":e>=60?"score-good":e>=40?"score-fair":"score-poor"}getHealthScoreClass(){let e=this.client?.healthScore;return e==null?"":this.getScoreClass(e)}getSavingsProgress(){return this.client?.currentSavings||0}getSavingsGoal(){return this.client?.savingsGoal||1e5}getPaymentProgress(){return this.client?.completedPayments||0}getTotalPayments(){return this.client?.totalPayments||24}getRemainingPayments(){let e=this.client?.completedPayments||0,t=this.client?.totalPayments||24;return`${t-e} de ${t}`}getLastContributionDate(){return this.client?.lastPaymentDate?this.client.lastPaymentDate.toLocaleDateString("es-MX",{day:"numeric",month:"short",year:"numeric"}):"No registrada"}getNextPaymentDue(){return this.client?.nextPaymentDue?this.client.nextPaymentDue.toLocaleDateString("es-MX",{day:"numeric",month:"short",year:"numeric"}):"No programado"}getEstimatedCompletion(){let e=this.client?.completedPayments||0,n=(this.client?.totalPayments||24)-e,s=new Date;return s.setMonth(s.getMonth()+n),s.toLocaleDateString("es-MX",{month:"short",year:"numeric"})}getPaymentMilestones(){let e=this.client?.totalPayments||24;return[{value:Math.floor(e*.25),label:"25%"},{value:Math.floor(e*.5),label:"50%"},{value:Math.floor(e*.75),label:"75%"}]}generatePaymentLink(e){console.log(`Generating ${e} payment link for client:`,this.client?.id);let t={spei:"https://payments.conductores.mx/spei/client-001",conekta:"https://payments.conductores.mx/card/client-001"};window.open(t[e],"_blank")}generatePDF(){this.isGeneratingPDF=!0,setTimeout(()=>{this.isGeneratingPDF=!1,console.log("PDF generated for client:",this.client?.id);let e=`https://documents.conductores.mx/statements/client-001-${Date.now()}.pdf`,t=document.createElement("a");t.href=e,t.download=`estado-cuenta-${this.client?.name?.replace(/\s+/g,"-")}.pdf`,t.click()},2e3)}previewAccountStatement(){console.log("Opening account statement preview")}updateImportMilestone(e){if(!this.client?.importStatus)return;let t=this.client.importStatus[e];if(!(!t||Array.isArray(t))&&(t.completed===!1||t.inProgress===!0||t.status!=="completed")){let n=t;n.inProgress?(n.completed=!0,n.status="completed",n.completedAt=new Date,n.inProgress=!1):(n.inProgress=!0,n.status="in_progress",n.startedAt=new Date),console.log(`Updated milestone ${e}:`,t)}}isFinancialProduct(){return this.client?.flow?["VentaPlazo","AhorroProgramado","CreditoColectivo"].includes(this.client.flow):!1}getContractId(){return`contract-${this.client?.id||"unknown"}`}static{this.\u0275fac=function(t){return new(t||i)(ae(Ae))}}static{this.\u0275cmp=$({type:i,selectors:[["app-cliente-detail"]],standalone:!0,features:[z],decls:89,vars:22,consts:[[1,"cliente-detail-container"],[1,"detail-header"],[1,"client-info"],[1,"client-name"],[1,"client-status"],[1,"status-badge"],["class","client-score",4,"ngIf"],["class","protection-status",4,"ngIf"],[1,"quick-stats"],[1,"stat-card"],[1,"stat-icon"],[1,"stat-info"],[1,"stat-label"],[1,"stat-value"],[1,"main-actions"],[1,"action-section"],[1,"action-buttons"],[1,"btn-avi-verification",3,"click","disabled"],[1,"btn-icon"],[1,"btn-content"],[1,"btn-title"],[1,"btn-subtitle"],[1,"btn-arrow"],[1,"btn-secondary-action",3,"click","disabled"],[1,"btn-secondary-action",3,"click"],["class","protection-section",4,"ngIf"],["class","client-details",4,"ngIf"],["class","progress-tracking-section",4,"ngIf"],["class","import-tracker-section",4,"ngIf"],[1,"event-log-section"],[1,"section-header","mb-6"],[1,"text-xl","font-semibold","text-gray-800"],[3,"events","maxEvents","showFilters","showActions"],["class","payment-actions-section",4,"ngIf"],[3,"clientId","municipality","visible","completed","closed",4,"ngIf"],[1,"client-score"],[1,"score-label"],[1,"score-value"],[1,"protection-status"],[1,"status-label"],[1,"status-indicator","protection-available"],[1,"protection-section"],[1,"text-sm","text-gray-600","mt-2"],[3,"client","contractId"],[1,"client-details"],[1,"details-grid"],[1,"detail-card"],[1,"detail-items"],[1,"detail-item"],[1,"detail-label"],[1,"detail-value"],[1,"progress-tracking-section"],[1,"progress-cards","grid","grid-cols-1","lg:grid-cols-2","gap-6","mb-6"],[1,"progress-card","bg-white","p-6","rounded-xl","shadow-lg","border","border-gray-200"],[1,"text-lg","font-semibold","text-gray-800","mb-4"],["label","Ahorro Acumulado","currency","MXN","theme","success","size","lg","actionLabel","Realizar Aportaci\xF3n",3,"progress","goal","animated","showValues","showMessages","showRemaining","actionCallback"],[1,"savings-details","mt-4","pt-4","border-t","border-gray-200"],[1,"flex","justify-between","text-sm","text-gray-600"],[1,"font-medium"],[1,"flex","justify-between","text-sm","text-gray-600","mt-1"],[1,"font-medium","text-amber-600"],["label","Pagos Realizados","theme","info","size","lg",3,"progress","goal","animated","showValues","showMessages","milestones"],[1,"payment-details","mt-4","pt-4","border-t","border-gray-200"],[1,"font-medium","text-emerald-600"],[1,"import-tracker-section"],[3,"onUpdateMilestone","client"],[1,"payment-actions-section"],[1,"payment-options","grid","grid-cols-1","md:grid-cols-2","gap-4","mb-6"],[1,"payment-option-card","p-6","bg-white","rounded-xl","shadow-lg","border","border-gray-200","hover:border-blue-400","hover:shadow-xl","transition-all","duration-200","text-left","group",3,"click"],[1,"flex","items-center","space-x-4"],[1,"payment-icon","w-12","h-12","bg-blue-100","rounded-lg","flex","items-center","justify-center","group-hover:bg-blue-200","transition-colors"],[1,"text-2xl"],[1,"font-semibold","text-gray-800"],[1,"text-sm","text-gray-600"],[1,"text-xs","text-blue-600","mt-1"],[1,"payment-option-card","p-6","bg-white","rounded-xl","shadow-lg","border","border-gray-200","hover:border-purple-400","hover:shadow-xl","transition-all","duration-200","text-left","group",3,"click"],[1,"payment-icon","w-12","h-12","bg-purple-100","rounded-lg","flex","items-center","justify-center","group-hover:bg-purple-200","transition-colors"],[1,"text-xs","text-purple-600","mt-1"],[1,"account-statement-section"],[1,"bg-gray-50","p-6","rounded-xl","border","border-gray-200"],[1,"flex","justify-between","items-center"],[1,"text-sm","text-gray-600","mt-1"],[1,"flex","space-x-3"],[1,"px-4","py-2","bg-gray-600","text-white","rounded-lg","hover:bg-gray-700","transition-colors","flex","items-center","space-x-2",3,"click"],[1,"px-4","py-2","bg-blue-600","text-white","rounded-lg","hover:bg-blue-700","disabled:bg-gray-400","transition-colors","flex","items-center","space-x-2",3,"click","disabled"],[4,"ngIf"],["class","animate-spin",4,"ngIf"],[1,"animate-spin"],[3,"completed","closed","clientId","municipality","visible"]],template:function(t,n){t&1&&(o(0,"div",0)(1,"div",1)(2,"div",2)(3,"h1",3),r(4),a(),o(5,"div",4)(6,"span",5),r(7),a()()(),h(8,jn,5,3,"div",6)(9,Qn,5,0,"div",7),a(),o(10,"div",8)(11,"div",9)(12,"div",10),r(13,"\u{1F4C4}"),a(),o(14,"div",11)(15,"span",12),r(16,"Documentos"),a(),o(17,"span",13),r(18),a()()(),o(19,"div",9)(20,"div",10),r(21,"\u{1F3AF}"),a(),o(22,"div",11)(23,"span",12),r(24,"Flujo"),a(),o(25,"span",13),r(26),a()()(),o(27,"div",9)(28,"div",10),r(29,"\u{1F4CD}"),a(),o(30,"div",11)(31,"span",12),r(32,"Municipio"),a(),o(33,"span",13),r(34),a()()()(),o(35,"div",14)(36,"div",15)(37,"h2"),r(38,"Verificaci\xF3n y Validaci\xF3n"),a(),o(39,"div",16)(40,"button",17),x("click",function(){return n.startAviVerification()}),o(41,"span",18),r(42,"\u{1F3A4}"),a(),o(43,"div",19)(44,"span",20),r(45,"Iniciar Verificaci\xF3n Inteligente AVI"),a(),o(46,"span",21),r(47,"Validaci\xF3n por voz con preguntas micro-locales"),a()(),o(48,"span",22),r(49,"\u2192"),a()(),o(50,"button",23),x("click",function(){return n.startTraditionalKyc()}),o(51,"span",18),r(52,"\u{1F50D}"),a(),o(53,"div",19)(54,"span",20),r(55,"KYC Tradicional"),a(),o(56,"span",21),r(57,"Verificaci\xF3n biom\xE9trica est\xE1ndar"),a()()()()(),o(58,"div",15)(59,"h2"),r(60,"Documentos y Contratos"),a(),o(61,"div",16)(62,"button",24),x("click",function(){return n.viewDocuments()}),o(63,"span",18),r(64,"\u{1F4CB}"),a(),o(65,"div",19)(66,"span",20),r(67,"Ver Documentos"),a(),o(68,"span",21),r(69,"Revisar estado de documentaci\xF3n"),a()()(),o(70,"button",23),x("click",function(){return n.generateContract()}),o(71,"span",18),r(72,"\u{1F4DC}"),a(),o(73,"div",19)(74,"span",20),r(75,"Generar Contrato"),a(),o(76,"span",21),r(77,"Crear documentos legales"),a()()()()()(),h(78,Hn,7,2,"div",25)(79,Wn,42,12,"div",26)(80,Yn,35,17,"div",27)(81,Xn,5,1,"div",28),o(82,"div",29)(83,"div",30)(84,"h2",31),r(85,"\u{1F4DC} Historial de Actividad"),a()(),k(86,"app-event-log",32),a(),h(87,Zn,48,4,"div",33)(88,ei,1,3,"app-avi-verification-modal",34),a()),t&2&&(c(4),f((n.client==null?null:n.client.name)||"Cliente"),c(2),P("status-"+((n.client==null?null:n.client.status)||"unknown").toLowerCase().replace(" ","-")),c(),b(" ",(n.client==null?null:n.client.status)||"Sin estado"," "),c(),p("ngIf",(n.client==null?null:n.client.healthScore)!=null),c(),p("ngIf",n.isFinancialProduct()&&n.client),c(9),f(n.getDocumentStats()),c(8),f(n.getFlowDisplayName(n.client==null?null:n.client.flow)),c(8),f(n.getMunicipalityName(n.client==null?null:n.client.market)),c(6),p("disabled",!n.canStartAviVerification()),c(10),p("disabled",!n.canStartKyc()),c(20),p("disabled",!n.canGenerateContract()),c(8),p("ngIf",n.isFinancialProduct()&&n.client),c(),p("ngIf",n.client),c(),p("ngIf",n.client),c(),p("ngIf",n.client&&n.client.importStatus),c(5),p("events",n.clientEvents)("maxEvents",20)("showFilters",!0)("showActions",!0),c(),p("ngIf",n.client),c(),p("ngIf",n.showAviModal))},dependencies:[U,q,he,je,Qe,He,Ze,at],styles:['@charset "UTF-8";.cliente-detail-container[_ngcontent-%COMP%]{max-width:1200px;margin:0 auto;padding:24px;background:#f8fafc;min-height:100vh}.detail-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:flex-start;background:#fff;padding:32px;border-radius:16px;box-shadow:0 4px 6px #0000000d;margin-bottom:24px}.client-info[_ngcontent-%COMP%]{flex:1}.client-name[_ngcontent-%COMP%]{font-size:28px;font-weight:700;color:#1f2937;margin:0 0 12px}.client-status[_ngcontent-%COMP%]{margin-bottom:8px}.status-badge[_ngcontent-%COMP%]{padding:8px 16px;border-radius:24px;font-size:14px;font-weight:600}.status-expediente-en-proceso[_ngcontent-%COMP%]{background:#fef3c7;color:#92400e}.status-verificaci\\f3n-avi-completada[_ngcontent-%COMP%]{background:#dcfce7;color:#166534}.status-requiere-supervisi\\f3n[_ngcontent-%COMP%]{background:#fecaca;color:#991b1b}.client-score[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:8px;background:#f8fafc;padding:20px;border-radius:12px;border:2px solid #e5e7eb}.protection-status[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:8px;background:#f0fdfa;padding:20px;border-radius:12px;border:2px solid #06d6a0}.score-label[_ngcontent-%COMP%], .status-label[_ngcontent-%COMP%]{font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase;letter-spacing:.5px}.status-indicator[_ngcontent-%COMP%]{font-size:14px;font-weight:600;padding:4px 8px;border-radius:8px}.status-indicator.protection-available[_ngcontent-%COMP%]{background:#06d6a0;color:#fff}.score-value[_ngcontent-%COMP%]{font-size:24px;font-weight:700}.score-excellent[_ngcontent-%COMP%]{color:#059669}.score-good[_ngcontent-%COMP%]{color:#0891b2}.score-fair[_ngcontent-%COMP%]{color:#d97706}.score-poor[_ngcontent-%COMP%]{color:#dc2626}.quick-stats[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:16px;margin-bottom:32px}.stat-card[_ngcontent-%COMP%]{display:flex;align-items:center;gap:16px;background:#fff;padding:24px;border-radius:12px;box-shadow:0 2px 4px #0000000d;border-left:4px solid #3b82f6}.stat-icon[_ngcontent-%COMP%]{font-size:32px;opacity:.8}.stat-info[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.stat-label[_ngcontent-%COMP%]{font-size:12px;font-weight:600;color:#6b7280;text-transform:uppercase}.stat-value[_ngcontent-%COMP%]{font-size:18px;font-weight:600;color:#1f2937}.main-actions[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:32px;margin-bottom:32px}.action-section[_ngcontent-%COMP%]{background:#fff;padding:32px;border-radius:16px;box-shadow:0 4px 6px #0000000d}.action-section[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0 0 24px;font-size:20px;font-weight:600;color:#1f2937;border-bottom:1px solid #e5e7eb;padding-bottom:12px}.action-buttons[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.btn-avi-verification[_ngcontent-%COMP%]{display:flex;align-items:center;gap:20px;padding:24px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:16px;cursor:pointer;transition:all .3s;position:relative;overflow:hidden;box-shadow:0 8px 24px #667eea4d}.btn-avi-verification[_ngcontent-%COMP%]:before{content:"";position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);transition:left .5s}.btn-avi-verification[_ngcontent-%COMP%]:hover:not(:disabled):before{left:100%}.btn-avi-verification[_ngcontent-%COMP%]:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 12px 32px #667eea66}.btn-avi-verification[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed;transform:none}.btn-secondary-action[_ngcontent-%COMP%]{display:flex;align-items:center;gap:20px;padding:20px;background:#fff;color:#374151;border:2px solid #e5e7eb;border-radius:12px;cursor:pointer;transition:all .2s}.btn-secondary-action[_ngcontent-%COMP%]:hover:not(:disabled){border-color:#3b82f6;background:#f8fafc}.btn-secondary-action[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}.btn-icon[_ngcontent-%COMP%]{font-size:24px;min-width:24px}.btn-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-start;gap:4px;flex:1}.btn-title[_ngcontent-%COMP%]{font-size:16px;font-weight:600}.btn-subtitle[_ngcontent-%COMP%]{font-size:14px;opacity:.8}.btn-arrow[_ngcontent-%COMP%]{font-size:20px;opacity:.8}.client-details[_ngcontent-%COMP%]{background:#fff;padding:32px;border-radius:16px;box-shadow:0 4px 6px #0000000d}.details-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px}.detail-card[_ngcontent-%COMP%]{background:#f8fafc;padding:24px;border-radius:12px;border:1px solid #e5e7eb}.detail-card[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0 0 20px;font-size:18px;font-weight:600;color:#1f2937;border-bottom:1px solid #e5e7eb;padding-bottom:12px}.detail-items[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:16px}.detail-item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:12px 0;border-bottom:1px solid #f1f5f9}.detail-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.detail-label[_ngcontent-%COMP%]{font-weight:600;color:#6b7280;font-size:14px}.detail-value[_ngcontent-%COMP%]{color:#1f2937;font-size:14px}@media (max-width: 768px){.cliente-detail-container[_ngcontent-%COMP%]{padding:16px}.detail-header[_ngcontent-%COMP%]{flex-direction:column;gap:20px;padding:24px}.client-score[_ngcontent-%COMP%], .protection-status[_ngcontent-%COMP%]{width:100%}.quick-stats[_ngcontent-%COMP%]{grid-template-columns:1fr}.action-section[_ngcontent-%COMP%]{padding:24px}.btn-avi-verification[_ngcontent-%COMP%], .btn-secondary-action[_ngcontent-%COMP%]{flex-direction:column;text-align:center;gap:12px}.btn-content[_ngcontent-%COMP%]{align-items:center}.details-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.protection-section[_ngcontent-%COMP%]{background:#fff;padding:32px;border-radius:16px;box-shadow:0 4px 6px #0000000d;margin-bottom:32px;border-left:4px solid #06d6a0}.protection-section[_ngcontent-%COMP%]   .section-header[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{color:#1f2937;font-size:20px;font-weight:600;margin:0;display:flex;align-items:center;gap:8px}.protection-section[_ngcontent-%COMP%]   .section-header[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#6b7280;font-size:14px;margin:8px 0 0}@media (max-width: 768px){.protection-section[_ngcontent-%COMP%]{padding:24px;margin-bottom:24px}}']})}}return i})();export{Uo as ClienteDetailComponent};
