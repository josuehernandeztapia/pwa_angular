import{a as P}from"./chunk-O54BG3VU.js";import{a as x}from"./chunk-NH6JDP7H.js";import{a as c}from"./chunk-XIPGL6BB.js";import{a as y,e as M}from"./chunk-SCHFUJ5K.js";import{a as D}from"./chunk-YYSQDTD3.js";import{a as h}from"./chunk-QCEAPM7G.js";import{A as C,I as b,N as k,S as u,V as S,_ as v,c as E,g as w,j as l,k as A,n as o}from"./chunk-5IDTUAMZ.js";import{a as p,b as m}from"./chunk-DM275RSA.js";var L=(()=>{class d{constructor(e,t,s,i){this.http=e,this.authService=t,this.loadingService=s,this.toast=i,this.baseUrl=c.apiUrl||"http://localhost:3000/api",this.maxRetries=3,this.connectionSubject=new w(!0),this.isConnected$=this.connectionSubject.asObservable(),this.setupConnectionMonitoring()}setupConnectionMonitoring(){window.addEventListener("online",()=>{this.connectionSubject.next(!0),this.toast.success("Conexi\xF3n restaurada")}),window.addEventListener("offline",()=>{this.connectionSubject.next(!1),this.toast.error("Sin conexi\xF3n a internet")})}get(e,t={}){let{showLoading:s=!0,showError:i=!0}=t;s&&this.loadingService.setLoading(!0,`GET ${e}`);let a=this.buildUrl(e),n=this.buildHttpOptions(t);return this.http.get(a,m(p({},n),{observe:"body",responseType:"json"})).pipe(k(this.maxRetries),u(r=>this.handleSuccess(r)),C(r=>this.handleError(r,i)),b(()=>{s&&this.loadingService.setLoading(!1,`GET ${e}`)}))}post(e,t,s={}){let{showLoading:i=!0,showError:a=!0,successMessage:n}=s;i&&this.loadingService.setLoading(!0,`POST ${e}`);let r=this.buildUrl(e),f=this.buildHttpOptions(s);return this.http.post(r,t,m(p({},f),{observe:"body",responseType:"json"})).pipe(k(1),u(g=>{this.handleSuccess(g),n&&this.toast.success(n)}),C(g=>this.handleError(g,a)),b(()=>{i&&this.loadingService.setLoading(!1,`POST ${e}`)}))}put(e,t,s={}){let{showLoading:i=!0,showError:a=!0,successMessage:n}=s;i&&this.loadingService.setLoading(!0,`PUT ${e}`);let r=this.buildUrl(e),f=this.buildHttpOptions(s);return this.http.put(r,t,m(p({},f),{observe:"body",responseType:"json"})).pipe(u(g=>{this.handleSuccess(g),n&&this.toast.success(n)}),C(g=>this.handleError(g,a)),b(()=>{i&&this.loadingService.setLoading(!1,`PUT ${e}`)}))}delete(e,t={}){let{showLoading:s=!0,showError:i=!0,successMessage:a}=t;s&&this.loadingService.setLoading(!0,`DELETE ${e}`);let n=this.buildUrl(e),r=this.buildHttpOptions(t);return this.http.delete(n,m(p({},r),{observe:"body",responseType:"json"})).pipe(u(f=>{this.handleSuccess(f),a&&this.toast.success(a)}),C(f=>this.handleError(f,i)),b(()=>{s&&this.loadingService.setLoading(!1,`DELETE ${e}`)}))}uploadFile(e,t,s){this.loadingService.setLoading(!0,"Uploading file");let i=new FormData;i.append("file",t),s&&Object.keys(s).forEach(r=>{i.append(r,s[r])});let a=this.buildUrl(e),n=this.getAuthHeaders();return this.http.post(a,i,{headers:n}).pipe(u(r=>{this.handleSuccess(r),this.toast.success("Archivo subido exitosamente")}),C(r=>this.handleError(r)),b(()=>this.loadingService.setLoading(!1,"Uploading file")))}buildUrl(e){let t=e.startsWith("/")?e.substring(1):e;return`${this.baseUrl}/${t}`}buildHttpOptions(e={}){let{params:t,headers:s}=e;return{params:t,headers:this.mergeHeaders(s)}}getAuthHeaders(){let e=new y({"Content-Type":"application/json",Accept:"application/json"}),t=localStorage.getItem("auth_token");return t&&(e=e.set("Authorization",`Bearer ${t}`)),e}mergeHeaders(e){let t=this.getAuthHeaders();if(!e)return t;let s=t;return e.keys().forEach(i=>{s=s.set(i,e.get(i)||"")}),s}handleSuccess(e){e.success&&e.message&&console.log("API Success:",e.message)}handleError(e,t=!0){let s="Ha ocurrido un error inesperado";if(e.error instanceof ErrorEvent)s=`Error: ${e.error.message}`;else switch(e.status){case 0:s="No se puede conectar al servidor",this.connectionSubject.next(!1);break;case 400:s="Solicitud inv\xE1lida",e.error?.message&&(s=e.error.message);break;case 401:s="No autorizado. Por favor, inicia sesi\xF3n nuevamente",this.authService.logout();break;case 403:s="No tienes permisos para realizar esta acci\xF3n";break;case 404:s="Recurso no encontrado";break;case 422:s="Datos de entrada inv\xE1lidos",e.error?.errors&&(s=Object.values(e.error.errors).flat().join(", "));break;case 500:s="Error interno del servidor";break;case 503:s="Servicio no disponible temporalmente";break;default:s=`Error ${e.status}: ${e.statusText}`}let i={message:s,status:e.status,statusText:e.statusText,url:e.url||void 0};return console.error("API Error:",i),t&&this.toast.error(s),A(()=>i)}checkApiHealth(){return this.get("health",{showLoading:!1,showError:!1}).pipe(o(e=>e.success&&e.data?.status==="ok"),C(()=>(this.connectionSubject.next(!1),l(!1))))}isConnected(){return this.connectionSubject.value&&navigator.onLine}static{this.\u0275fac=function(t){return new(t||d)(v(M),v(x),v(P),v(D))}}static{this.\u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();var W=(()=>{class d{constructor(e){this.httpClient=e,this.clientsCache=new w([]),this.clients$=this.clientsCache.asObservable()}getClients(e){return c.features.enableMockData?l(this.getMockClients()).pipe(o(t=>this.applyFilters(t,e)),u(t=>this.clientsCache.next(t))):this.httpClient.get("clients",{params:e,showLoading:!0}).pipe(o(t=>t.data||[]),u(t=>this.clientsCache.next(t)))}searchClients(e){return this.getClients({search:e})}getClientById(e){if(c.features.enableMockData){let s=this.getMockClients().find(i=>i.id===e)||null;return l(s)}return this.httpClient.get(`clients/${e}`).pipe(o(t=>t.data||null))}createClient(e){if(c.features.enableMockData){let t={id:Date.now().toString(),name:e.name||"",avatarUrl:"",email:e.email||"",phone:e.phone||"",rfc:e.rfc,market:e.market||"aguascalientes",flow:e.flow||h.VentaPlazo,status:"Activo",createdAt:new Date,lastModified:new Date,events:[],documents:this.generateDefaultDocuments(e.flow||h.VentaPlazo)},s=this.clientsCache.value;return this.clientsCache.next([...s,t]),l(t)}return this.httpClient.post("clients",e,{successMessage:"Cliente creado exitosamente"}).pipe(o(t=>t.data),u(t=>{let s=this.clientsCache.value;this.clientsCache.next([...s,t])}))}updateClient(e,t){if(c.features.enableMockData){let i=this.clientsCache.value.map(n=>n.id===e?m(p(p({},n),t),{lastModified:new Date}):n);this.clientsCache.next(i);let a=i.find(n=>n.id===e);return l(a)}return this.httpClient.put(`clients/${e}`,t,{successMessage:"Cliente actualizado exitosamente"}).pipe(o(s=>s.data),u(s=>{let a=this.clientsCache.value.map(n=>n.id===e?s:n);this.clientsCache.next(a)}))}deleteClient(e){if(c.features.enableMockData){let s=this.clientsCache.value.filter(i=>i.id!==e);return this.clientsCache.next(s),l(!0)}return this.httpClient.delete(`clients/${e}`,{successMessage:"Cliente eliminado exitosamente"}).pipe(o(t=>t.success),u(()=>{let s=this.clientsCache.value.filter(i=>i.id!==e);this.clientsCache.next(s)}))}createQuote(e){if(c.features.enableMockData){let t={totalPrice:e.totalPrice||0,downPayment:e.downPayment||0,amountToFinance:e.amountToFinance||0,term:e.term||24,monthlyPayment:e.monthlyPayment||0,market:e.market||"aguascalientes",clientType:e.clientType||"individual",flow:e.flow||h.VentaPlazo,id:Date.now().toString(),clientId:e.clientId||"",product:e.product,financialSummary:e.financialSummary,timeline:e.timeline||[],createdAt:new Date,expiresAt:new Date(Date.now()+2592e6),status:"active"};return l(t)}return this.httpClient.post("quotes",e,{successMessage:"Cotizaci\xF3n creada exitosamente"}).pipe(o(t=>t.data))}getClientQuotes(e){return c.features.enableMockData?l([]):this.httpClient.get(`clients/${e}/quotes`).pipe(o(t=>t.data||[]))}uploadDocument(e,t,s){let i=new FormData;return i.append("file",s),i.append("clientId",e),i.append("documentId",t),c.features.enableMockData?new E(a=>{setTimeout(()=>{let n={id:t,name:"INE Vigente",status:"En Revisi\xF3n",uploadedAt:new Date,fileUrl:URL.createObjectURL(s),fileName:s.name,fileSize:s.size};a.next(n),a.complete()},2e3)}):this.httpClient.uploadFile(`clients/${e}/documents/${t}`,s,{clientId:e,documentId:t}).pipe(o(a=>a.data))}getClientDocuments(e){if(c.features.enableMockData){let t=this.getMockClients().find(s=>s.id===e);return l(t?.documents||[])}return this.httpClient.get(`clients/${e}/documents`).pipe(o(t=>t.data||[]))}addClientEvent(e,t){let s={id:Date.now().toString(),timestamp:new Date,message:t.message||"",actor:t.actor,type:t.type,details:t.details};if(c.features.enableMockData){let a=this.clientsCache.value.map(n=>n.id===e?m(p({},n),{events:[s,...n.events]}):n);return this.clientsCache.next(a),l(s)}return this.httpClient.post(`clients/${e}/events`,s).pipe(o(i=>i.data))}applyFilters(e,t){return t?e.filter(s=>{if(t.market&&s.market!==t.market||t.flow&&s.flow!==t.flow||t.status&&s.status!==t.status)return!1;if(t.search){let i=t.search.toLowerCase();return s.name.toLowerCase().includes(i)||s.email?.toLowerCase().includes(i)||s.phone?.includes(i)}return!0}):e}generateDefaultDocuments(e){let t=[{id:"1",name:"INE Vigente",status:"Pendiente"},{id:"2",name:"Comprobante de domicilio",status:"Pendiente"},{id:"3",name:"Constancia de situaci\xF3n fiscal",status:"Pendiente"}];switch(e){case h.VentaPlazo:t.push({id:"4",name:"Carta Aval de Ruta",status:"Pendiente"},{id:"5",name:"Convenio de Daci\xF3n en Pago",status:"Pendiente"});break;case h.CreditoColectivo:t.push({id:"6",name:"Acta Constitutiva de la Ruta",status:"Pendiente"});break}return t}getMockClients(){return[{id:"1",name:"Ana Garc\xEDa L\xF3pez",avatarUrl:"",email:"ana.garcia@email.com",phone:"5551234567",rfc:"GALA850315ABC",market:"aguascalientes",flow:h.VentaPlazo,status:"Activo",createdAt:new Date("2024-01-15"),lastModified:new Date,events:[{id:"1",timestamp:new Date("2024-01-15"),message:"Cliente registrado en el sistema",actor:"Sistema",type:"System"}],documents:this.generateDefaultDocuments(h.VentaPlazo)},{id:"2",name:"Carlos Rodr\xEDguez Mart\xEDn",avatarUrl:"",email:"carlos.rodriguez@email.com",phone:"5552345678",rfc:"ROMC780922DEF",market:"edomex",flow:h.AhorroProgramado,status:"Pendiente",createdAt:new Date("2024-02-10"),lastModified:new Date,events:[{id:"2",timestamp:new Date("2024-02-10"),message:"Cotizaci\xF3n generada para Plan de Ahorro",actor:"Asesor",type:"AdvisorAction"}],documents:this.generateDefaultDocuments(h.AhorroProgramado)},{id:"3",name:"Mar\xEDa Elena S\xE1nchez",avatarUrl:"",email:"maria.sanchez@email.com",phone:"5553456789",rfc:"SAME901205GHI",market:"aguascalientes",flow:h.CreditoColectivo,status:"Activo",createdAt:new Date("2024-01-28"),lastModified:new Date,events:[{id:"3",timestamp:new Date("2024-01-28"),message:"Agregada a grupo de cr\xE9dito colectivo",actor:"Asesor",type:"AdvisorAction"}],documents:this.generateDefaultDocuments(h.CreditoColectivo)}]}checkHealth(){return this.httpClient.checkApiHealth()}clearCache(){this.clientsCache.next([])}static{this.\u0275fac=function(t){return new(t||d)(v(L))}}static{this.\u0275prov=S({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();export{L as a,W as b};
