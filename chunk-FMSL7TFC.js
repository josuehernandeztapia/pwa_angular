import{c as A}from"./chunk-4M7CYCOE.js";import{e as T}from"./chunk-SCHFUJ5K.js";import{a}from"./chunk-QCEAPM7G.js";import{$ as l,A as n,Q as c,R as m,S as v,V as I,f as h,g as u,j as i,n as s,v as p,z as f}from"./chunk-5IDTUAMZ.js";var k=(()=>{class d{constructor(){this.http=l(T),this.deliveriesService=l(A),this.baseUrl=window.__BFF_BASE__??"/api",this.monitoringActive=new u(!1),this.stopMonitoring$=new h,this.triggerRules=[],this.initializeTriggerRules(),this.startMonitoring()}initializeTriggerRules(){this.triggerRules=[{id:"venta-directa-ags",flow:a.VentaDirecta,market:"aguascalientes",description:"Venta Directa AGS: 50% del pago total",triggerLogic:"cuando se pague el 50% del monto total",thresholdPercentage:.5},{id:"venta-directa-edomex",flow:a.VentaDirecta,market:"edomex",description:"Venta Directa EdoMex: 50% del pago total",triggerLogic:"cuando se pague el 50% del monto total",thresholdPercentage:.5},{id:"venta-plazo-ags",flow:a.VentaPlazo,market:"aguascalientes",description:"Venta a Plazo AGS: 50% del enganche requerido (60%)",triggerLogic:"cuando se pague el 50% del enganche (30% del total)",thresholdPercentage:.5},{id:"venta-plazo-edomex",flow:a.VentaPlazo,market:"edomex",description:"Venta a Plazo EdoMex: 50% del enganche requerido (20-25%)",triggerLogic:"cuando se pague el 50% del enganche (10-12.5% del total)",thresholdPercentage:.5},{id:"ahorro-ags",flow:a.AhorroProgramado,market:"aguascalientes",description:"Ahorro AGS: 50% del enganche requerido",triggerLogic:"cuando ahorro alcance el 50% del enganche requerido",thresholdPercentage:.5},{id:"ahorro-edomex",flow:a.AhorroProgramado,market:"edomex",description:"Ahorro EdoMex: 50% del enganche requerido",triggerLogic:"cuando ahorro alcance el 50% del enganche requerido",thresholdPercentage:.5},{id:"tandas-edomex",flow:a.CreditoColectivo,market:"edomex",description:"Tandas EdoMex: An\xE1lisis predictivo + 5 miembros + 1 mes",triggerLogic:"an\xE1lisis predictivo cuando 5+ miembros colecten por 1+ mes y se proyecte alcanzar 50% del primer enganche",thresholdPercentage:.5,additionalCriteria:{minimumMembers:5,minimumDuration:1,predictiveAnalysis:!0}}]}startMonitoring(){this.monitoringActive.value||(console.log("\u{1F504} ContractTriggers: Iniciando monitoreo autom\xE1tico..."),this.monitoringActive.next(!0),p(0,3e4).pipe(f(()=>this.monitoringActive.value),c(()=>this.processAllTriggers()),m(this.stopMonitoring$),n(e=>(console.error("Error en monitoreo de triggers:",e),i(null)))).subscribe())}stopMonitoringService(){console.log("\u{1F6D1} ContractTriggers: Deteniendo monitoreo..."),this.monitoringActive.next(!1),this.stopMonitoring$.next()}processAllTriggers(){return console.log("\u{1F50D} ContractTriggers: Procesando triggers..."),this.http.get(`${this.baseUrl}/v1/triggers/pending-analysis`).pipe(c(({contractSummaries:e,tandaAnalyses:t})=>{let r=[];return e.forEach(o=>{!o.deliveryOrderTriggered&&o.thresholdReached&&r.push(this.processTriggerForContract(o).toPromise().then(g=>g??null))}),t.forEach(o=>{!o.deliveryOrderTriggered&&o.triggerReady&&r.push(this.processTriggerForTanda(o).toPromise().then(g=>g??null))}),Promise.all(r)}),s(e=>e.filter(t=>t!==null)),v(e=>{e.length>0&&console.log(`\u2705 ContractTriggers: Procesados ${e.length} triggers`)}),n(()=>i([])))}processTriggerForContract(e){let t=this.findTriggerRule(e.flow,e.market);if(!t)throw new Error(`No se encontr\xF3 regla de trigger para ${e.flow} en ${e.market}`);return console.log(`\u{1F3AF} Procesando trigger para contrato ${e.contractId}: ${e.thresholdPercentage.toFixed(1)}%`),this.createDeliveryOrder(e.clientId,{contractId:e.contractId,flow:e.flow,market:e.market,triggerType:"payment_threshold",triggerAmount:e.currentPaidAmount,thresholdAmount:e.thresholdAmount}).pipe(s(r=>{let o={id:`trigger-${Date.now()}-${e.contractId}`,clientId:e.clientId,contractId:e.contractId,triggerRuleId:t.id,eventType:"payment_threshold_reached",triggerDate:new Date,thresholdAmount:e.thresholdAmount,actualAmount:e.currentPaidAmount,triggerPercentage:e.thresholdPercentage,deliveryOrderCreated:!0,deliveryOrderId:r.id,processedBy:"system",notifications:{advisorNotified:!1,clientNotified:!1,whatsappSent:!1}};return this.updateTriggerStatus(e.contractId,o).subscribe(),o}),n(r=>{let o={id:`trigger-error-${Date.now()}-${e.contractId}`,clientId:e.clientId,contractId:e.contractId,triggerRuleId:t.id,eventType:"payment_threshold_reached",triggerDate:new Date,thresholdAmount:e.thresholdAmount,actualAmount:e.currentPaidAmount,triggerPercentage:e.thresholdPercentage,deliveryOrderCreated:!1,errorMessage:r.message||"Error desconocido",processedBy:"system",notifications:{advisorNotified:!1,clientNotified:!1,whatsappSent:!1}};return console.error("\u274C Error procesando trigger para contrato:",r),i(o)}))}processTriggerForTanda(e){let t=this.findTriggerRule(a.CreditoColectivo,"edomex");if(!t)throw new Error("No se encontr\xF3 regla de trigger para Tandas");return console.log(`\u{1F3AF} Procesando trigger predictivo para tanda ${e.tandaId}: ${e.confidenceLevel.toFixed(2)} confianza`),this.createDeliveryOrderForTanda(e).pipe(s(r=>{let o={id:`trigger-tanda-${Date.now()}-${e.tandaId}`,clientId:"group",tandaId:e.tandaId,triggerRuleId:t.id,eventType:"tanda_prediction_ready",triggerDate:new Date,thresholdAmount:e.projectedFirstEnganche,actualAmount:e.totalCollected,triggerPercentage:e.confidenceLevel*100,deliveryOrderCreated:!0,deliveryOrderId:r.id,processedBy:"system",notifications:{advisorNotified:!1,clientNotified:!1,whatsappSent:!1}};return this.updateTandaTriggerStatus(e.tandaId,o).subscribe(),o}),n(r=>{let o={id:`trigger-tanda-error-${Date.now()}-${e.tandaId}`,clientId:"group",tandaId:e.tandaId,triggerRuleId:t.id,eventType:"tanda_prediction_ready",triggerDate:new Date,thresholdAmount:e.projectedFirstEnganche,actualAmount:e.totalCollected,triggerPercentage:e.confidenceLevel*100,deliveryOrderCreated:!1,errorMessage:r.message||"Error desconocido",processedBy:"system",notifications:{advisorNotified:!1,clientNotified:!1,whatsappSent:!1}};return console.error("\u274C Error procesando trigger para tanda:",r),i(o)}))}createDeliveryOrder(e,t){let r={clientId:e,market:t.market,businessFlow:t.flow,sku:this.getDefaultSKU(this.mapDeliveryMarket(t.market),t.flow),totalAmount:0,paidAmount:t.triggerAmount,createdBy:"system",triggerSource:"contract_payment_threshold",triggerMetadata:{contractId:t.contractId,thresholdAmount:t.thresholdAmount,triggerPercentage:50,automaticTrigger:!0}};return this.deliveriesService.create(r)}createDeliveryOrderForTanda(e){let t={clientId:e.tandaId,market:"edomex",businessFlow:a.CreditoColectivo,sku:this.getDefaultSKU("edomex",a.CreditoColectivo),totalAmount:0,paidAmount:e.totalCollected,createdBy:"system",triggerSource:"tanda_predictive_analysis",triggerMetadata:{tandaId:e.tandaId,routeId:e.routeId,activeMembersCount:e.activeMembersCount,monthsCollecting:e.monthsCollecting,confidenceLevel:e.confidenceLevel,projectedFirstEnganche:e.projectedFirstEnganche,automaticTrigger:!0,predictiveAnalysis:!0}};return this.deliveriesService.create(t)}getContractPaymentSummary(e){return this.http.get(`${this.baseUrl}/v1/triggers/contract/${e}/payment-summary`).pipe(n(()=>i({})))}getTandaPredictiveAnalysis(e){return this.http.get(`${this.baseUrl}/v1/triggers/tanda/${e}/predictive-analysis`).pipe(n(()=>i({})))}getTriggerHistory(e=50){return this.http.get(`${this.baseUrl}/v1/triggers/history`,{params:{limit:e.toString()}}).pipe(n(()=>i([])))}forceProcessTriggers(){return console.log("\u{1F527} Forzando procesamiento manual de triggers..."),this.processAllTriggers().pipe(s(e=>({processed:e.length,events:e})))}getTriggerRules(){return[...this.triggerRules]}getTriggerMetrics(){return this.http.get(`${this.baseUrl}/v1/triggers/metrics`).pipe(n(()=>i({totalTriggers:0,successfulTriggers:0,failedTriggers:0,pendingAnalysis:0,averageProcessingTime:0,lastProcessingTime:new Date})))}findTriggerRule(e,t){return this.triggerRules.find(r=>r.flow===e&&r.market===t)}getDefaultSKU(e,t){return e==="aguascalientes"?"H6C-19P-AGS":t===a.CreditoColectivo?"H6C-VENT-COL":"H6C-VENT-IND"}mapDeliveryMarket(e){return e==="AGS"?"aguascalientes":"edomex"}updateTriggerStatus(e,t){return this.http.patch(`${this.baseUrl}/v1/triggers/contract/${e}/status`,{triggerId:t.id,triggerDate:t.triggerDate,deliveryOrderId:t.deliveryOrderId,triggered:t.deliveryOrderCreated}).pipe(n(r=>(console.error("Error actualizando estado de trigger de contrato:",r),i())))}updateTandaTriggerStatus(e,t){return this.http.patch(`${this.baseUrl}/v1/triggers/tanda/${e}/status`,{triggerId:t.id,triggerDate:t.triggerDate,deliveryOrderId:t.deliveryOrderId,triggered:t.deliveryOrderCreated}).pipe(n(r=>(console.error("Error actualizando estado de trigger de tanda:",r),i())))}handleError(e="operation"){return t=>{console.error(`ContractTriggersService.${e} failed:`,t);let r="Error en el sistema de triggers autom\xE1ticos";return t.status===404?r="Informaci\xF3n de trigger no encontrada":t.status===403?r="No tienes permisos para gestionar triggers":t.status===400?r=t.error?.message||"Solicitud de trigger inv\xE1lida":t.status>=500&&(r="Error del servidor. Intenta m\xE1s tarde"),i(void 0)}}static{this.\u0275fac=function(t){return new(t||d)}}static{this.\u0275prov=I({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();export{k as a};
