import{a as I}from"./chunk-ULB2DFX5.js";import{V as j,_ as A}from"./chunk-5IDTUAMZ.js";import{a as g,b as w,g as C}from"./chunk-DM275RSA.js";var B=(()=>{class d{constructor(e){this.financialCalc=e}simulateTanda(e,t){return C(this,null,function*(){let a=0,n=new Map,c=[...e.members].filter(m=>m.status==="active").sort((m,y)=>m.prio-y.prio),o=[],r=[],s={},u=e.product.rateAnnual/12;for(let m=1;m<=t.horizonMonths;m++){let y=t.events.filter(i=>i.t===m),v=new Map(e.members.map(i=>[i.id,i.C]));y.forEach(i=>{i.type==="extra"?v.set(i.data.memberId,(v.get(i.data.memberId)||0)+i.data.amount):i.type==="miss"&&v.set(i.data.memberId,(v.get(i.data.memberId)||0)-i.data.amount)});let M=Array.from(v.values()).reduce((i,f)=>i+f,0),E=Array.from(n.values()).reduce((i,f)=>i+f,0),O=0,P="ok";M>=E?a+=M-E:(O=E-M,P="debtDeficit");let D=[],$=e.product.price*e.product.dpPct+(e.product.fees||0);for(;P!=="debtDeficit"&&a>=$&&c.length>0;){let i=c.shift();if(!i)break;if(!e.rules.eligibility.requireThisMonthPaid||(v.get(i.id)||0)>=e.members.find(L=>L.id===i.id).C){let L=e.product.price*(1-e.product.dpPct),q=this.financialCalc.annuity(L,u,e.product.term);n.set(i.id,q),a-=$;let x={memberId:i.id,name:i.name,month:m,mds:q};D.push(x),r.push(x),s[i.id]=x}else{c.push(i);break}}M<E+D.reduce((i,f)=>i+f.mds,0)&&(P="lowInflow"),o.push({t:m,inflow:M,debtDue:E+D.reduce((i,f)=>i+f.mds,0),deficit:O,savings:a,awards:D,riskBadge:P})}let h=r.length,l=r.length>0?Math.min(...r.map(m=>m.month)):void 0,b=r.length>0?Math.max(...r.map(m=>m.month)):void 0,p=r.length>0?r.reduce((m,y)=>m+y.month,0)/r.length:0,T=o.map(m=>m.debtDue>0?m.inflow/m.debtDue:1),S=T.reduce((m,y)=>m+y,0)/T.length;return{months:o,awardsByMember:s,firstAwardT:l,lastAwardT:b,kpis:{coverageRatioMean:S,deliveredCount:h,avgTimeToAward:p}}})}simulateWithDelta(e,t,a=500){return C(this,null,function*(){let n=yield this.simulateTanda(e,t),c=w(g({},e),{members:e.members.map(r=>w(g({},r),{C:r.C+a}))}),o=yield this.simulateTanda(c,t);return{original:n,withDelta:o}})}generateBaselineTanda(e,t,a){let n=Array.from({length:e},(c,o)=>({id:`member-${o+1}`,name:`Miembro ${o+1}`,prio:o+1,status:"active",C:a}));return{name:`Tanda ${e} Miembros`,members:n,product:{price:t,dpPct:.15,term:60,rateAnnual:.299,fees:2e4},rules:{allocRule:"debt_first",eligibility:{requireThisMonthPaid:!0}},seed:Math.random()}}getProjectedTimeline(e){let t=[];return e.months.forEach(a=>{a.awards.length>0&&a.awards.forEach(n=>{t.push({month:a.t,event:"Entrega de Unidad",details:`${n.name} - Pago mensual: ${this.financialCalc.formatCurrency(n.mds)}`})}),a.riskBadge==="debtDeficit"&&t.push({month:a.t,event:"Alerta de Riesgo",details:`D\xE9ficit de ${this.financialCalc.formatCurrency(a.deficit)}`})}),t.sort((a,n)=>a.month-n.month)}getSnowballEffect(e){let t=e.months.map(o=>o.savings),a=e.months.map(o=>o.debtDue),n=e.months.map(o=>e.months.slice(0,o.t).reduce((r,s)=>r+s.awards.length,0)),c=e.months.map(o=>o.t);return{totalSavings:t,totalDebt:a,unitsDelivered:n,months:c}}static{this.\u0275fac=function(t){return new(t||d)(A(I))}}static{this.\u0275prov=j({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();var F=(()=>{class d{constructor(e,t){this.tandaEngine=e,this.financialCalc=t}generateAGSLiquidationScenario(e,t,a,n,c,o){let r=a.reduce((p,T,S)=>p+n[S]*c,0),s=e+r*t,u=Math.max(0,o-s),h=[],l=e;for(let p=1;p<=t;p++)l+=r,h.push(l);let b=[{month:0,event:"Enganche Inicial",amount:e},...Array.from({length:t},(p,T)=>({month:T+1,event:"Recaudaci\xF3n Mensual",amount:r})),{month:t+1,event:"Entrega de Unidad",amount:-o},{month:t+1,event:"Remanente a Liquidar",amount:u}];return{type:"AGS_LIQUIDATION",targetAmount:o,monthsToTarget:t,monthlyContribution:r,collectionContribution:r,voluntaryContribution:0,projectedBalance:h,timeline:b}}generateEdoMexIndividualScenario(e,t,a,n=0){let c=t*a,o=c+n,r=Math.ceil(e/o),s=[],u=0;for(let l=1;l<=r;l++)u+=o,s.push(u);let h=Array.from({length:r},(l,b)=>({month:b+1,event:"Aportaci\xF3n Mensual",amount:o}));return h.push({month:r+1,event:"Meta de Enganche Alcanzada",amount:e}),{type:"EDOMEX_INDIVIDUAL",targetAmount:e,monthsToTarget:r,monthlyContribution:o,collectionContribution:c,voluntaryContribution:n,projectedBalance:s,timeline:h}}generateEdoMexCollectiveScenario(e){return C(this,null,function*(){let t=e.avgConsumption*e.overpricePerLiter,a=t+e.voluntaryMonthly,n=this.tandaEngine.generateBaselineTanda(e.memberCount,e.unitPrice,a),c={horizonMonths:60,events:[]},o=yield this.tandaEngine.simulateTanda(n,c),r=this.tandaEngine.getSnowballEffect(o),s=this.tandaEngine.getProjectedTimeline(o),u=e.memberCount;return{scenario:{type:"EDOMEX_COLLECTIVE",targetAmount:e.unitPrice*.15*u,monthsToTarget:o.firstAwardT||12,monthlyContribution:a*e.memberCount,collectionContribution:t*e.memberCount,voluntaryContribution:e.voluntaryMonthly*e.memberCount,projectedBalance:r.totalSavings,timeline:s.map(p=>({month:p.month,event:p.event,amount:0}))},tandaResult:o,snowballEffect:r}})}optimizeScenario(e,t,a,n){switch(e){case"AGS_LIQUIDATION":let c=(t-(n.initialDownPayment||0))/a,o=c/(n.totalConsumption||1);return{recommendedParams:{overpricePerLiter:Math.ceil(o),monthlyCollection:c,remainderAfterDelivery:Math.max(0,t-(n.initialDownPayment+c*a))},projectedTimeline:a};case"EDOMEX_INDIVIDUAL":let r=t/a,s=n.plateConsumption*n.maxOverprice,u=Math.max(0,r-s);return{recommendedParams:{voluntaryMonthly:Math.ceil(u),overpricePerLiter:n.maxOverprice,totalMonthlyContribution:r},projectedTimeline:Math.ceil(t/r)};case"EDOMEX_COLLECTIVE":let h=t/n.memberCount,l=n.avgConsumption*n.maxOverprice+n.maxVoluntary,b=Math.ceil(h/l);return{recommendedParams:{memberCount:n.memberCount,overpricePerLiter:n.maxOverprice,voluntaryMonthly:n.maxVoluntary,contributionPerMember:l},projectedTimeline:b};default:return{recommendedParams:{},projectedTimeline:0}}}generateComparisonScenarios(e,t){return C(this,null,function*(){let a=[];for(let n of t)a.push(w(g({},e),{monthlyContribution:n.parameter==="monthly"?n.value:e.monthlyContribution,monthsToTarget:n.parameter==="months"?n.value:e.monthsToTarget}));return a})}formatScenarioForSenior(e){let t=[`Tu objetivo es ahorrar ${this.financialCalc.formatCurrency(e.targetAmount)}.`,`Con tus aportaciones actuales, lo lograr\xE1s en ${e.monthsToTarget} meses.`,`Cada mes necesitas aportar ${this.financialCalc.formatCurrency(e.monthlyContribution)}.`],a=[{label:"Meta de Ahorro",value:this.financialCalc.formatCurrency(e.targetAmount)},{label:"Tiempo Estimado",value:`${e.monthsToTarget} meses`},{label:"Aportaci\xF3n Mensual",value:this.financialCalc.formatCurrency(e.monthlyContribution)}],n=e.timeline.slice(0,5).map(c=>`Mes ${c.month}: ${c.event}`);return{summary:t,keyNumbers:a,timeline:n}}static{this.\u0275fac=function(t){return new(t||d)(A(B),A(I))}}static{this.\u0275prov=j({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();export{F as a};
