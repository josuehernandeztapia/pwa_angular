import{A as u,G as c,V as g,g as p,j as i,k as s,n as a}from"./chunk-5IDTUAMZ.js";import{a as m,b as h}from"./chunk-DM275RSA.js";var S=(()=>{class d{constructor(){this.currentUserSubject=new p(null),this.isAuthenticatedSubject=new p(!1),this.tokenKey="auth_token",this.refreshTokenKey="refresh_token",this.userKey="current_user",this.currentUser$=this.currentUserSubject.asObservable(),this.isAuthenticated$=this.isAuthenticatedSubject.asObservable(),this.initializeAuth()}initializeAuth(){let e=localStorage.getItem(this.tokenKey),t=localStorage.getItem(this.userKey);if(e&&t)try{let r=JSON.parse(t);this.currentUserSubject.next(r),this.isAuthenticatedSubject.next(!0)}catch(r){console.error("Error parsing user data:",r),this.logout()}}login(e){let t=[{email:"demo@conductores.com",password:"demo123",user:{id:"1",name:"Asesor Demo",email:"demo@conductores.com",role:"asesor",permissions:["read:clients","write:quotes","read:reports"],avatarUrl:"https://picsum.photos/seed/demo/100/100"}},{email:"supervisor@conductores.com",password:"super123",user:{id:"2",name:"Supervisor Demo",email:"supervisor@conductores.com",role:"supervisor",permissions:["read:clients","write:quotes","read:reports","approve:quotes","manage:team"],avatarUrl:"https://picsum.photos/seed/supervisor/100/100"}}];return i(null).pipe(c(1500),a(()=>{let r=t.find(n=>n.email===e.email&&n.password===e.password);if(!r)throw new Error("Invalid credentials");let o={user:r.user,token:"demo_jwt_token_"+Date.now(),refreshToken:"demo_refresh_token_"+Date.now(),expiresIn:3600};return this.setAuthData(o,e.rememberMe),o}),u(r=>(console.error("Login error:",r),s(()=>new Error("Credenciales incorrectas")))))}logout(){localStorage.removeItem(this.tokenKey),localStorage.removeItem(this.refreshTokenKey),localStorage.removeItem(this.userKey),localStorage.removeItem("rememberMe"),this.currentUserSubject.next(null),this.isAuthenticatedSubject.next(!1)}getCurrentUser(){return this.currentUserSubject.value}isAuthenticated(){return this.isAuthenticatedSubject.value}getToken(){return localStorage.getItem(this.tokenKey)}hasPermission(e){return this.getCurrentUser()?.permissions.includes(e)||!1}hasRole(e){return this.getCurrentUser()?.role===e}refreshToken(){return localStorage.getItem(this.refreshTokenKey)?i(null).pipe(c(1e3),a(()=>{let t=this.getCurrentUser();if(!t)throw new Error("No current user");let r={user:t,token:"refreshed_jwt_token_"+Date.now(),refreshToken:"new_refresh_token_"+Date.now(),expiresIn:3600};return this.setAuthData(r),r}),u(t=>(console.error("Token refresh error:",t),this.logout(),s(()=>new Error("Token refresh failed"))))):(this.logout(),s(()=>new Error("No refresh token available")))}updateProfile(e){let t=this.getCurrentUser();return t?i(null).pipe(c(1e3),a(()=>{let r=m(m({},t),e);return localStorage.setItem(this.userKey,JSON.stringify(r)),this.currentUserSubject.next(r),r}),u(r=>(console.error("Profile update error:",r),s(()=>new Error("Failed to update profile"))))):s(()=>new Error("No authenticated user"))}changePassword(e,t){return i(null).pipe(c(1500),a(()=>{if(e==="demo123"&&t.length>=6)return!0;throw new Error("Invalid current password or new password too short")}),u(r=>(console.error("Password change error:",r),s(()=>new Error("Failed to change password")))))}requestPasswordReset(e){return i(null).pipe(c(2e3),a(()=>(console.log("Password reset email sent to:",e),!0)))}setAuthData(e,t){localStorage.setItem(this.tokenKey,e.token),localStorage.setItem(this.refreshTokenKey,e.refreshToken),localStorage.setItem(this.userKey,JSON.stringify(e.user)),t&&localStorage.setItem("rememberMe","true"),this.currentUserSubject.next(e.user),this.isAuthenticatedSubject.next(!0)}isTokenExpired(){let e=this.getToken();if(!e)return!0;let r=e.split("_").pop(),o=r?parseInt(r):0;if(isNaN(o)||o===0)return!0;let n=60*60*1e3;return Date.now()-o>n}register(e){return!e.acceptTerms||!e.acceptPrivacy?s(()=>new Error("Debe aceptar los t\xE9rminos y condiciones")):e.password!==e.confirmPassword?s(()=>new Error("Las contrase\xF1as no coinciden")):e.email.endsWith("@conductores.com")?i(null).pipe(c(2e3),a(()=>{if(["demo@conductores.com","supervisor@conductores.com","admin@conductores.com","test@conductores.com"].includes(e.email.toLowerCase()))throw new Error("Este correo ya est\xE1 registrado");let r={message:"Registro exitoso. Se ha enviado un email de verificaci\xF3n.",userId:"user_"+Date.now(),emailSent:!0,approvalRequired:!!e.supervisor},o=h(m({},e),{userId:r.userId,status:"PENDING_EMAIL_VERIFICATION",createdAt:new Date().toISOString(),verificationToken:"verify_"+Date.now()}),n=JSON.parse(localStorage.getItem("pendingRegistrations")||"[]");return n.push(o),localStorage.setItem("pendingRegistrations",JSON.stringify(n)),console.log("\u{1F4E7} Registration Email Sent:",{to:e.email,subject:"Verificar tu cuenta - Conductores PWA",verificationLink:`${window.location.origin}/verify-email?token=${o.verificationToken}`}),e.supervisor&&console.log("\u{1F4E7} Supervisor Notification Sent:",{to:e.supervisor,subject:"Nueva solicitud de registro - Conductores PWA",newUser:`${e.firstName} ${e.lastName}`}),r}),u(t=>(console.error("Registration error:",t),s(()=>t)))):s(()=>new Error("Debe usar un correo corporativo"))}verifyEmail(e){return i(null).pipe(c(1e3),a(()=>{let t=JSON.parse(localStorage.getItem("pendingRegistrations")||"[]"),r=t.find(l=>l.verificationToken===e);if(!r)throw new Error("Token de verificaci\xF3n inv\xE1lido o expirado");if(r.status!=="PENDING_EMAIL_VERIFICATION")throw new Error("Esta cuenta ya ha sido verificada");r.status=r.supervisor?"PENDING_SUPERVISOR_APPROVAL":"APPROVED",r.emailVerifiedAt=new Date().toISOString();let o=t.map(l=>l.verificationToken===e?r:l);return localStorage.setItem("pendingRegistrations",JSON.stringify(o)),{message:r.supervisor?"Email verificado. Tu cuenta est\xE1 pendiente de aprobaci\xF3n por tu supervisor.":"Email verificado. Tu cuenta ha sido activada.",success:!0}}),u(t=>(console.error("Email verification error:",t),s(()=>t))))}checkEmailAvailability(e){return i(null).pipe(c(500),a(()=>{let t=["demo@conductores.com","supervisor@conductores.com","admin@conductores.com","test@conductores.com"],o=JSON.parse(localStorage.getItem("pendingRegistrations")||"[]").map(l=>l.email.toLowerCase());return{available:![...t,...o].includes(e.toLowerCase())}}))}static{this.\u0275fac=function(t){return new(t||d)}}static{this.\u0275prov=g({token:d,factory:d.\u0275fac,providedIn:"root"})}}return d})();export{S as a};
